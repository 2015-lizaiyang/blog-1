<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head><script type="text/javascript">var NREUMQ=NREUMQ||[];NREUMQ.push(["mark","firstbyte",new Date().getTime()]);</script>
	<title>Programming JavaScript Applications</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link href="http://dwn0odqttrkhc.cloudfront.net/assets/book-748da559db3e7bc457e1e4da3b2fa1e9.css" media="screen" rel="stylesheet" type="text/css" />
	<link href="http://dwn0odqttrkhc.cloudfront.net/assets/default-6b113e470a1a8ec83000e32a1548bc3a.css" media="screen" rel="stylesheet" type="text/css" />
	<script src="http://dwn0odqttrkhc.cloudfront.net/assets/application-984298d79dbc8412cdf579684d9338f6.js" type="text/javascript"></script>
	<script src="http://dwn0odqttrkhc.cloudfront.net/assets/book-756862b9ed04d945ca53de5b8f106a83.js" type="text/javascript"></script>
	<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
	<link href="http://dwn0odqttrkhc.cloudfront.net/assets/janrain-53eb5abed55992e21943b9d3373923e8.css" media="all" rel="stylesheet" type="text/css" />
	<meta content="authenticity_token" name="csrf-param" />
<meta content="P4YjoABcut4xmj06ZcBqoEZGrSU1unbA9vdZXHRtlMA=" name="csrf-token" />
	<script type="text/javascript" charset="utf-8">
  	
		app.data = new classes.Data({"controller":{"controller":"books","action":"html"},"capturable":{"capture_server":"https://oreilly.janraincapture.com","client_id":"6n5q2k9vesqgn93k3mhevka6c3c3rsre","app_url":"https://login.oreilly.com","app_id":"xsnca5wmqe9vxv97ygh5vfejkd","load_js":"d16s8pqtk4uodx.cloudfront.net/login.oreilly.com/load.js"},"user":{"id":null,"account":"LoggedOutAccount","email":"","name":null,"gravatar_url":"http://www.gravatar.com/avatar/d41d8cd98f00b204e9800998ecf8427e?s=40&d=identicon"},"book":{"isbn":"1234000000262","chapter":"ch03.html","toc_url":"/books/1234000000262/toc_html","metadata_url":"http://d4bb7yl96lyl1.cloudfront.net/1234000000262/metadata/metadata_c6a0e8997c9604111d0171fb2d72f5c1b6cfd618.json"},"abilities":{"can_destroy_all_comments":false,"can_create_comments":false},"advertisement":{"body":"<style>      \r\n.ad-profile-image {\r\n  padding: 0;\r\n  margin: 0;\r\n  max-height: 30px;\r\n }\r\n\r\n.top-banner {\r\n  position: absolute;\r\n  right: 0;\r\n  top: 34px;\r\n  z-index: 99999;\r\n}\r\n\r\np.banner-text {\r\n  margin: 0;\r\n  text-align: center;\r\n  padding-right: 10px;\r\n  width: 500px;\r\n}\r\n\r\n@media screen and (max-width: 600px) {\r\n   p.banner-text {\r\n     width: 100%;\r\n     text-align: center;\r\n  }\r\n}\r\n\r\nspan.ebook-advantage {\r\n  font-size: smaller;\r\n  display: block;\r\n}\r\n\r\ndiv.banner-container {\r\n  margin: 0 auto;\r\n}\r\n\r\ndiv.banner-container ul {\r\n  margin: 0 auto;\r\n}\r\n\r\ndiv.topad { padding-bottom: 5px; }\r\n\r\ndiv.banner-container ul li {\r\n  display: inline-block;\r\n  vertical-align: middle;\r\n}\r\n\r\ndiv.banner-container li p {\r\n  padding-top: 0;\r\n  margin-top: 0;\r\n}\r\n\r\ndiv.banner-container li.sponsor {\r\n  border-right: 1px solid rgb(125, 154, 180);\r\n  margin-right: 5px;\r\n  padding-right: 10px;\r\n}\r\n\r\ndiv.banner-container .webbutton {\r\n  background-color: #3994b6;\r\n  display: inline-block;\r\n  padding: 10px;\r\n  -webkit-border-radius: 5px;\r\n  -moz-border-radius: 5px;\r\n  border-radius: 5px;\r\n  color: #FFF;\r\n  text-align: center;\r\n  text-decoration: none;\r\n  font-size: 12px;\r\n  font-weight: bold;\r\n}\r\n\r\n</style>\r\n   \r\n<div style=\"color: rgb(125, 154, 180);\">\r\n\r\n<div class=\"banner-container\">\r\n\r\n<ul>\r\n\r\n<li class=\"sponsor\">\r\n<!--CONFERENCE SPONSOR IMAGE-->\r\n<a href=\"http://velocityconf.com/\">\r\n<img src=\"http://orm-other.s3.amazonaws.com/velocity_logo.png\" class=\"ad-profile-image\"/>\r\n<!-- <img src=\"http://orm-other.s3.amazonaws.com/fluent_logo.png\" class=\"ad-profile-image\"/>\r\n<img src=\"http://orm-other.s3.amazonaws.com/oscon_logo.png\" class=\"ad-profile-image\"/>\r\n<img src=\"http://orm-other.s3.amazonaws.com/strata_logo.png\" class=\"ad-profile-image\"/>\r\n<img src=\"http://orm-other.s3.amazonaws.com/StrataRx_logo.png\" class=\"ad-profile-image\"/>\r\n<img src=\"http://orm-other.s3.amazonaws.com/velocity_logo.png\" class=\"ad-profile-image\"/> -->\r\n</a>\r\n</li>\r\n\r\n<li>\r\n<!--AD TEXT, 2 LINES, REPLACE LINK URL AS WELL-->\r\n<p class=\"banner-text\">Enjoy this free Early Release version of <em>Programming JavaScript Applications</em>. Purchase and download the DRM-free ebook on <a href=\"http://shop.oreilly.com/product/0636920024231.do?intcmp=il-npa-books-video-product_chimera\">oreilly.com</a>.<span class=\"ebook-advantage\">Learn more about the O’Reilly <a href=\"http://shop.oreilly.com/category/ebooks.do\">Ebook Advantage</a>.</span></p>\r\n</li>\r\n\r\n<li>\r\n<!--BUY BUTTON-->\r\n<a class=\"webbutton\" href=\"http://shop.oreilly.com/product/0636920024231.do?intcmp=il-npa-books-video-product_chimera\">Buy the Ebook</a>\r\n</li> \r\n\r\n</ul>\r\n\r\n</div>\r\n\r\n<!--CORNER BANNER (IF NEEDED)-->\r\n<!--<a href=\"http://shop.oreilly.com/product/0636920025245.do\" class=\"top-banner\"><img src=\"http://orm-other.s3.amazonaws.com/banner.png\" /></a>-->\r\n\r\n</div>"}});

		/* Janrain setup */
  	var janrainModal = new JanrainView();
  	$("head").append(janrainModal.render().el);

  	/* segment.io setup */
  	var analytics=analytics||[];analytics.load=function(e){var t=document.createElement("script");t.type="text/javascript",t.async=!0,t.src=("https:"===document.location.protocol?"https://":"http://")+"d2dq2ahtl5zl1z.cloudfront.net/analytics.js/v1/"+e+"/analytics.min.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(t,n);var r=function(e){return function(){analytics.push([e].concat(Array.prototype.slice.call(arguments,0)))}},i=["identify","track","trackLink","trackForm","trackClick","trackSubmit","pageview","ab","alias","ready"];for(var s=0;s<i.length;s++)analytics[i[s]]=r(i[s])};
  	
  	analytics.load("hg9h6b9pae");

  	$(function() {
			app.bookapp = new BookApp();
		});
	
	</script>
</head>
<body>
	<div id="menu">
	
		<ul id="menu-left">
			<li id="home-link"><a href="/"><i class="icon-house"></i></a></li>
			<li><a href="/books/1234000000262">Programming JavaScript Applications</a></li>
			<div class="clear"></div>
		</ul>
	
		<ul id="menu-right">
			<li id="comments-link"><a>&nbsp;</a></li>
			<li>
				<a href="#" class="dropdown-toggle" data-toggle="dropdown">Chapters</a>
				<div id="toc-popup" class="dropdown-menu"></div>
			</li>
				<li><a href="#" class="capture_modal_open" id="capture_signin_link">Log In / Sign Up</a></li>
			<li id="search-li">
				<form accept-charset="UTF-8" action="/searches" id="search-form" method="get"><div style="margin:0;padding:0;display:inline"><input name="utf8" type="hidden" value="&#x2713;" /></div>
	<input name='search[q]' type="text" placeholder="Search book..." id="book-search" />

	<input id="search_bookId" name="search[bookId]" type="hidden" value="1234000000262" />
	
	<div style='display:none'>
		sorted by: 
		<select name='search[sort]' >
			<option value='relevance'>Relevance</option>
			<option value='authors'>Author(s)</option>
			<option value='title'>Title</option>
		</select>
		returning
		<select name='search[limit]' >
			<option value='5'>5</option>
			<option value='10'>10</option>
			<option value='20'>20</option>
			<option selected="selected" value='50'>50</option>
			<option value='100'>100</option>
		</select>
		values at a time.
	</div>
</form>
			</li>
			<div class="clear"></div>
		</ul>
		<div class="clear"></div>
	
</div>
	<header><div class="navheader">
<table style="width: 100%; ">
<tr><td style="text-align: center; " colspan="3">Chapter 3. Functions</td></tr>
<tr>
<td style="width: 20%; text-align: left; ">
<a accesskey="p" href="ch02.html">Prev</a> </td>
<td style="width: 60%; text-align: center; "> </td>
<td style="width: 20%; text-align: right; "> <a accesskey="n" href="ch04.html">Next</a>
</td>
</tr>
</table>
<hr>
</div></header><section class="chapter" data-original-filename="ch03.xml" id="functions"><div class="titlepage"><div><div><h1 class="title">Chapter 3. Functions</h1></div></div></div>
<p id="functions_are_t">Functions are the building blocks of applications. They are particularly important in JavaScript because JavaScript supports first class functions, functions as objects, run time function definition, and so on. It's important to have a thorough understanding of how functions work in JavaScript so you can leverage them to full advantage in your applications.</p>
<p id="here_are_some_g">Here are some guidelines that will help you write better functions:</p>
<p id="dont_repeat_yo_id1">Don't Repeat Yourself (DRY)</p>
<p id="good_programmer">Good programmers are both lazy, and very productive. They express a lot of functionality in very little code. Once you have established a pattern for something that gets repeated again in the code, it's time to write a function, object, or module that encapsulates that pattern so that it can be easily reused.</p>
<p id="doing_so_also_q">Doing so also quarantines that functionality to a single spot in the code base, so that if you later find something wrong with the code or the algorithm, you only have to fix it in one place.</p>
<p id="todo_needs__id1">Writing a reusable function also forces you to isolate the pattern from the problem, which helps you keep related functionality grouped together.</p>
<p id="do_one_thing_d">Do One Thing (DOT)</p>
<p id="each_function_s">Each function should do only one thing, and do that one thing as well as it can. Following this principle will make your function more reusable, more readable, and easier to debug.</p>
<p id="keep_it_simple_">Keep it Simple Stupid (KISS)</p>
<p id="todo_needs__id2">Programmers are often tempted to come up with clever solutions to problems. That's a good thing, of course, but sometimes programmers are <span class="emphasis"><em>too clever,</em></span> and the solutions are cryptic. This tends to happen when a single line of code is used to accomplish more than a single atomic goal.</p>
<p id="less_is_more">Less is More</p>
<p id="in_order_to_aid">In order to aid readability, and reduce the temptation to do more than one thing, functions should be as short as possible: Just enough code to do the one thing they were made to do, and no more. In most cases, functions should be just a handful of lines long. If they run much longer, consider breaking out sub tasks and data into separate functions and objects.</p>
<p id="minimize_side_e">Minimize Side Effects</p>
<p id="there_are_two_c">There are two classes of bugs that are extremely common and easily avoidable. The first is syntax errors (covered in the section on linting). The second is unintentional side effects.</p>
<p id="unintentional_s">Unintentional side effects are the bane of code reuse. They occur when multiple functions depend on and manipulate the values of the same variables or object properties. In this situation, it becomes much more difficult to refactor code, because your functions assume too much about the state of the program. For example, imagine your app includes a shopping cart, and your users can save cart contents between sessions.</p>
<p id="now_the_user_wa">Now the user wants to change the order <span class="emphasis"><em>for the current session, only:</em></span></p>
<pre class="programlisting" data-language="js" id="testorder_wit"><code class="nx">test</code><code class="p">(</code><code class="s1">'Order WITH unintentional side effect.'</code><code class="p">,</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
  <code class="kd">var</code> <code class="nx">cartProto</code> <code class="o">=</code> <code class="p">{</code>
      <code class="nx">items</code><code class="o">:</code> <code class="p">[],</code>

      <code class="nx">addItem</code><code class="o">:</code> <code class="kd">function</code> <code class="nx">addItem</code><code class="p">(</code><code class="nx">item</code><code class="p">)</code> <code class="p">{</code>
        <code class="k">this</code><code class="p">.</code><code class="nx">items</code><code class="p">.</code><code class="nx">push</code><code class="p">(</code><code class="nx">item</code><code class="p">);</code>
      <code class="p">}</code>
    <code class="p">},</code>

    <code class="nx">createCart</code> <code class="o">=</code> <code class="kd">function</code> <code class="p">(</code><code class="nx">items</code><code class="p">)</code> <code class="p">{</code>
      <code class="kd">var</code> <code class="nx">cart</code> <code class="o">=</code> <code class="nb">Object</code><code class="p">.</code><code class="nx">create</code><code class="p">(</code><code class="nx">cartProto</code><code class="p">);</code>
      <code class="nx">cart</code><code class="p">.</code><code class="nx">items</code> <code class="o">=</code> <code class="nx">items</code><code class="p">;</code>
      <code class="k">return</code> <code class="nx">cart</code><code class="p">;</code>
    <code class="p">},</code>

    <code class="c1">// Hydrate cart with stored items.</code>
    <code class="nx">savedCart</code> <code class="o">=</code> <code class="nx">createCart</code><code class="p">([</code><code class="s2">"apple"</code><code class="p">,</code> <code class="s2">"pear"</code><code class="p">,</code> <code class="s2">"orange"</code><code class="p">]),</code>

    <code class="nx">session</code> <code class="o">=</code> <code class="p">{</code>
      <code class="nx">get</code><code class="o">:</code> <code class="kd">function</code> <code class="nx">get</code><code class="p">()</code> <code class="p">{</code>
        <code class="k">return</code> <code class="k">this</code><code class="p">.</code><code class="nx">cart</code><code class="p">;</code>
      <code class="p">},</code>

      <code class="c1">// Grab the saved cart.</code>
      <code class="nx">cart</code><code class="o">:</code> <code class="nx">createCart</code><code class="p">(</code><code class="nx">savedCart</code><code class="p">.</code><code class="nx">items</code><code class="p">)</code>
    <code class="p">};</code>

  <code class="c1">// addItem gets triggered by an event handler somewhere:</code>
  <code class="nx">session</code><code class="p">.</code><code class="nx">cart</code><code class="p">.</code><code class="nx">addItem</code><code class="p">(</code><code class="s1">'grapefruit'</code><code class="p">);</code>

  <code class="nx">ok</code><code class="p">(</code><code class="nx">session</code><code class="p">.</code><code class="nx">cart</code><code class="p">.</code><code class="nx">items</code><code class="p">.</code><code class="nx">indexOf</code><code class="p">(</code><code class="s1">'grapefruit'</code><code class="p">)</code>
    <code class="o">!==</code> <code class="o">-</code><code class="mi">1</code><code class="p">,</code> <code class="s1">'Passes: Session cart has grapefruit.'</code><code class="p">);</code>

  <code class="nx">ok</code><code class="p">(</code><code class="nx">savedCart</code><code class="p">.</code><code class="nx">items</code><code class="p">.</code><code class="nx">indexOf</code><code class="p">(</code><code class="s1">'grapefruit'</code><code class="p">)</code> <code class="o">===</code> <code class="o">-</code><code class="mi">1</code><code class="p">,</code>
    <code class="s1">'Fails: The stored cart is unchanged.'</code><code class="p">);</code>
<code class="p">});</code></pre>
<p id="sadly_when_the">Sadly, when the user adds or removes items from his session cart, those changes will destroy the settings for the stored cart that she wants to use later. The trouble with this code is here:</p>
<pre class="programlisting" data-language="js" id="createcart__fu"><code class="nx">createCart</code> <code class="o">=</code> <code class="kd">function</code> <code class="p">(</code><code class="nx">items</code><code class="p">)</code> <code class="p">{</code>
  <code class="kd">var</code> <code class="nx">cart</code> <code class="o">=</code> <code class="nb">Object</code><code class="p">.</code><code class="nx">create</code><code class="p">(</code><code class="nx">cartProto</code><code class="p">);</code>
  <code class="nx">cart</code><code class="p">.</code><code class="nx">items</code> <code class="o">=</code> <code class="nx">items</code><code class="p">;</code>
  <code class="k">return</code> <code class="nx">cart</code><code class="p">;</code>
<code class="p">},</code></pre>
<p id="at_this_point_">At this point, <code class="code">cart.items</code> is a reference to the prototype <code class="code">items</code> attribute. This is improved with one small change to the code:</p>
<pre class="programlisting" data-language="js" id="cartitems__ob"><code class="nx">cart</code><code class="p">.</code><code class="nx">items</code> <code class="o">=</code> <code class="nb">Object</code><code class="p">.</code><code class="nx">create</code><code class="p">(</code><code class="nx">items</code><code class="p">);</code></pre>
<p id="now_the_new_car">Now the new cart will have its own copy of the item data, so changes will not be destructive to <code class="code">storedCart</code>.</p>
<p id="the_best_way_to">The best way to ensure that your <code class="code">program</code> contains few unintentional side effects is to avoid them in your <span class="emphasis"><em>functions</em></span>. If your function operates on outside variables, return a <span class="emphasis"><em>copy</em></span> instead of the original.</p>
<p id="a_pure_function">A <em class="firstterm">pure function</em> has no side effects. It does not alter existing variables or program state in any way, and always returns the same value given the same inputs.</p>
<p id="wherever_possib_id2">Wherever possible, make sure that your functions don't change anything outside the function itself. Return amended copies rather than originals. Note that you can still alter program state. REST works this way: You get a <span class="emphasis"><em>copy</em></span> of the data resource (called a <span class="emphasis"><em>representation</em></span>), manipulate it, and send the copy back to the server.</p>
<p id="writing_most_of">Writing most of your functions in a similar fashion can help you separate concerns and reduce code duplication. For example, if you need to implement data validation months after you wrote the original code, and you have a single function that is responsible for writing data to your data resource, it will be trivial to add the needed validation. If hundreds of functions throughout the codebase are accessing the data directly, it will be a much more difficult task.</p>
<p id="keeping_things_">Keeping things isolated in this way can also enhance your ability to implement state management. If the functions that manipulate data don't have to worry about the state of the program and account for side effects created by other functions, they can do their job with much less code. All they have to know how to do is the <span class="emphasis"><em>one task</em></span> they were designed to do.</p>
<p id="todo_link_to_id3">Likewise, the only functions that should be manipulating the DOM should be the methods dedicated to DOM manipulation, such as a DOM plugin or a view's <code class="code">.render()</code> method.</p>
<div class="sect1" data-original-filename="ch03.xml" id="function_definition">
<div class="titlepage"><div><div><h2 class="title">Function Definition</h2></div></div></div>
<p id="there_are_sever_id1">There are several ways to define functions in JavaScript. Each has its own advantages and disadvantages.</p>
<pre class="programlisting" data-language="js" id="function_foo_"><code class="kd">function</code> <code class="nx">foo</code><code class="p">()</code> <code class="p">{</code>

    <code class="cm">/* Warning: arguments.callee is deprecated.</code>
<code class="cm">       Use with caution. Used here strictly for</code>
<code class="cm">       illustration. */</code>

    <code class="k">return</code> <code class="nx">arguments</code><code class="p">.</code><code class="nx">callee</code><code class="p">;</code>
<code class="p">}</code>

<code class="nx">foo</code><code class="p">();</code> <code class="c1">//=&gt; [Function: foo]</code></pre>
<p id="in_the_code_abo_id1">In the code above, <code class="code">foo()</code> is a <em class="firstterm">function declaration</em>. As mentioned in the section on hoisting, it's important to be aware that you can't declare a function conditionally. For example, the following code will fail:</p>
<pre class="programlisting" data-language="js" id="var_score___"><code class="kd">var</code> <code class="nx">score</code> <code class="o">=</code> <code class="mi">6</code><code class="p">;</code>

<code class="k">if</code> <code class="p">(</code><code class="nx">score</code> <code class="o">&gt;</code> <code class="mi">5</code><code class="p">)</code> <code class="p">{</code>
  <code class="kd">function</code> <code class="nx">grade</code><code class="p">()</code> <code class="p">{</code>
    <code class="k">return</code> <code class="s1">'pass'</code><code class="p">;</code>
  <code class="p">}</code>
<code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
  <code class="kd">function</code> <code class="nx">grade</code><code class="p">()</code> <code class="p">{</code>
    <code class="k">return</code> <code class="s1">'fail'</code><code class="p">;</code>
  <code class="p">}</code>
<code class="p">}</code>

<code class="nx">module</code><code class="p">(</code><code class="s1">'Pass or Fail'</code><code class="p">);</code>

<code class="nx">test</code><code class="p">(</code><code class="s1">'Conditional function declaration.'</code><code class="p">,</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
  <code class="c1">// Firefox: Pass</code>
  <code class="c1">// Chrome, Safari, IE, Opera: Fail</code>
  <code class="nx">equal</code><code class="p">(</code>
    <code class="nx">grade</code><code class="p">(),</code> <code class="s1">'pass'</code><code class="p">,</code>
    <code class="s1">'Grade should pass.'</code>
  <code class="p">);</code>
<code class="p">});</code>  </pre>
<p id="whats_worse_t">What's worse, this pattern fails inconsistently across browsers. It's best to avoid conditional function declarations entirely. For more detail, refer to the section on function hoisting.</p>
<p id="function_declar">Function declaration tends to encourage large piles of loosely related functions to grow in your module, with no real hints about what goes where, whether its public or private, or how the functions work together.</p>
<pre class="programlisting" data-language="js" id="var_bar__funct"><code class="kd">var</code> <code class="nx">bar</code> <code class="o">=</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
    <code class="k">return</code> <code class="nx">arguments</code><code class="p">.</code><code class="nx">callee</code><code class="p">;</code>
<code class="p">};</code>

<code class="nx">bar</code><code class="p">();</code> <code class="c1">//=&gt; [Function] (Note: It's anonymous.)</code></pre>
<p id="the_bar_examp">The <code class="code">bar()</code> example assigns a function body to the variable, <code class="code">bar</code>. This implementation is called a <em class="firstterm">function expression</em>.</p>
<p id="the_advantage_o">The advantage of  function expressions is you can assign functions to variables the same way you would assign values to variables. You can count on function expressions to follow your application logic reliably. If you want to do a conditional assignment, it will work as expected.</p>
<p id="the_disadvantag">The disadvantage is function expressions create <em class="firstterm">anonymous functions</em>. Anonymous functions are used in JavaScript frequently. With reckless abandon, perhaps. Imagine that you've declared all of your functions this way, and you have a pile of functions that call functions that call even more functions. This is a common scenario in a well architected, event-driven application. Now imagine that you're twelve function calls deep and something goes wrong. You need to debug and view your call stack, but it looks something like this:</p>
<pre class="programlisting" id="anonymous_func">(Anonymous function)
(Anonymous function)
(Anonymous function)
(Anonymous function)
(Anonymous function)
(Anonymous function)
(Anonymous function)
(Anonymous function)
(Anonymous function)
(Anonymous function)
(Anonymous function)
(Anonymous function)</pre>
<p id="obviously_this">Obviously, this is not very helpful.</p>
<pre class="programlisting" data-language="js" id="var_baz___f_"><code class="kd">var</code> <code class="nx">baz</code> <code class="o">=</code> <code class="p">{</code>
    <code class="nx">f</code><code class="o">:</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
        <code class="k">return</code> <code class="nx">arguments</code><code class="p">.</code><code class="nx">callee</code><code class="p">;</code>
    <code class="p">}</code>
<code class="p">};</code>

<code class="nx">baz</code><code class="p">.</code><code class="nx">f</code><code class="p">();</code> <code class="c1">// =&gt; [Function] (Note: Also anonymous.)</code></pre>
<p id="the_baz_example">The <code class="code">baz</code> example exhibits the same behavior. It's another anonymous function assigned to a property in an object literal. Function expressions assigned to object literals are sometimes called <em class="firstterm">method literals</em>. Methods are functions attached to objects.</p>
<p id="the_advantage_i">The advantage is that method literals make it very easy to group related functions using object literals. For example, say you have a group of functions that control the state of a lightbulb:</p>
<pre class="programlisting" data-language="js" id="var_lightbulbap"><code class="kd">var</code> <code class="nx">lightBulbAPI</code> <code class="o">=</code> <code class="p">{</code>
        <code class="nx">toggle</code><code class="o">:</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{},</code>
        <code class="nx">getState</code><code class="o">:</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{},</code>
        <code class="nx">off</code><code class="o">:</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{},</code>
        <code class="nx">on</code><code class="o">:</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{},</code>
        <code class="nx">blink</code><code class="o">:</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{}</code>
    <code class="p">};</code></pre>
<p id="you_gain_a_lot_">You gain a lot when you group related functions together. Your code is more organized and readable. Code in context is easier to understand and maintain. </p>
<p id="another_advanta">Another advantage is that you can more easily rearrange code if you notice that your module is growing too large. For example, if your smart house module is too bulky with APIs for lightbulbs, TV, music, and the garage door, and they're all grouped like this, it's much easier to split them into individual modules in separate files.</p>
<div class="caution" id="do_not_use_the__id1"><p id="do_not_use_the__id2">Do not use the <code class="code">Function()</code> constructor to declare a function. Passing it a string is equivalent to passing a string to <code class="code">eval()</code>. It comes with the same drawbacks and security implications discussed in chapter two. </p></div>
<div class="sect2" id="named_function_expressions">
<div class="titlepage"><div><div><h3 class="title">Named Function Expressions</h3></div></div></div>
<p id="as_you_can_see_id2">As you can see, all of the function definition techniques have weaknesses, but it's possible to get the benefits of code organization and conditional function definition without littering your stack traces with anonymous functions. Let's take another look at the lightbulb API:</p>
<pre class="programlisting" data-language="js" id="lightbulbapi__"><code class="nx">lightbulbAPI</code> <code class="o">=</code> <code class="p">{</code>
  <code class="nx">toggle</code><code class="o">:</code> <code class="kd">function</code> <code class="nx">toggle</code><code class="p">()</code> <code class="p">{},</code>
  <code class="nx">getState</code><code class="o">:</code> <code class="kd">function</code> <code class="nx">getState</code><code class="p">()</code> <code class="p">{},</code>
  <code class="nx">off</code><code class="o">:</code> <code class="kd">function</code> <code class="nx">off</code><code class="p">()</code> <code class="p">{},</code>
  <code class="nx">on</code><code class="o">:</code> <code class="kd">function</code> <code class="nx">on</code><code class="p">()</code> <code class="p">{},</code>
  <code class="nx">blink</code><code class="o">:</code> <code class="kd">function</code> <code class="nx">blink</code><code class="p">()</code> <code class="p">{}</code>
<code class="p">};</code></pre>
<p id="named_function_">Named function expressions are like  anonymous function expressions in every way, except that they have a name that you can use from inside the function (for recursion). That name also conveniently appears in the function call stack.</p>
<p id="as_with_anonymo">As with anonymous function expressions, you can use them anywhere you would use a variable -- not just inside method literals. Named function expressions are <span class="emphasis"><em>not</em></span> the same as function declarations. Unlike function declarations, the name you assign is only available from within the function (covered in more detail in the section on function scope). From outside the function, you must access the function through the variable it's assigned to or the parameter it's passed in on:</p>
<pre class="programlisting" data-language="js" id="testnamed_fun"><code class="nx">test</code><code class="p">(</code><code class="s1">'Named function expressions.'</code><code class="p">,</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
  <code class="kd">var</code> <code class="nx">a</code> <code class="o">=</code> <code class="kd">function</code> <code class="nx">x</code> <code class="p">()</code> <code class="p">{</code>
    <code class="nx">ok</code><code class="p">(</code><code class="nx">x</code><code class="p">,</code> <code class="s1">'x() is usable inside the function.'</code><code class="p">);</code>
  <code class="p">};</code>

  <code class="nx">a</code><code class="p">();</code>

  <code class="k">try</code> <code class="p">{</code>
    <code class="nx">x</code><code class="p">();</code> <code class="c1">// Error</code>
  <code class="p">}</code> <code class="k">catch</code> <code class="p">(</code><code class="nx">e</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">ok</code><code class="p">(</code><code class="kc">true</code><code class="p">,</code> <code class="s1">'x() is undefined outside the function.'</code><code class="p">);</code>
  <code class="p">}</code>
<code class="p">});</code></pre>
<div class="caution" id="internet_explor_id1">
<p id="internet_explor_id2">Internet Explorer 8 and older treat named function expressions like function declarations, so be careful that the names you chose won't collide with the names of other functions or variables in the same scope. This bug is fixed in IE9. All other major browsers treat named function expressions correctly.</p>
<p id="if_you_name_you">If you name your function expressions the same as the variable you assign them to, and declare all of your variables at the top of your function, this will rarely be a problem.</p>
</div>
<pre class="programlisting" data-language="js" id="testfunction__id1"><code class="nx">test</code><code class="p">(</code><code class="s1">'Function Scope'</code><code class="p">,</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
  <code class="kd">var</code> <code class="nx">testDeclaration</code> <code class="o">=</code> <code class="kc">false</code><code class="p">,</code>
    <code class="nx">foo</code><code class="p">;</code>

  <code class="c1">// This function gets erroneously overridden in IE8.</code>
  <code class="kd">function</code> <code class="nx">bar</code><code class="p">(</code><code class="nx">arg1</code><code class="p">,</code> <code class="nx">bleed</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">if</code> <code class="p">(</code><code class="nx">bleed</code><code class="p">)</code> <code class="p">{</code>

      <code class="nx">ok</code><code class="p">(</code><code class="kc">false</code><code class="p">,</code> 
       <code class="s1">'Declaration bar() should NOT be callable from'</code>
       <code class="o">+</code> <code class="s1">' inside the expression.'</code><code class="p">);</code>

    <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>

      <code class="nx">ok</code><code class="p">(</code><code class="kc">true</code><code class="p">,</code> 
        <code class="s1">'Declaration bar() should be called outside the'</code>
        <code class="o">+</code> <code class="s1">' expression.'</code><code class="p">);</code>

    <code class="p">}</code>
    <code class="nx">testDeclaration</code> <code class="o">=</code> <code class="kc">true</code><code class="p">;</code>
  <code class="p">}</code>

  <code class="nx">foo</code> <code class="o">=</code> <code class="kd">function</code> <code class="nx">bar</code><code class="p">(</code><code class="nx">declaration</code><code class="p">,</code> <code class="nx">recurse</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">if</code> <code class="p">(</code><code class="nx">recurse</code><code class="p">)</code> <code class="p">{</code>

      <code class="nx">ok</code><code class="p">(</code><code class="kc">true</code><code class="p">,</code>
        <code class="s1">'Expression bar() should support scope safe'</code>
        <code class="o">+</code> <code class="s1">' recursion'</code><code class="p">);</code>

    <code class="p">}</code> <code class="k">else</code> <code class="k">if</code> <code class="p">(</code><code class="nx">declaration</code> <code class="o">===</code> <code class="kc">true</code><code class="p">)</code> <code class="p">{</code>

      <code class="nx">ok</code><code class="p">(</code><code class="kc">true</code><code class="p">,</code>
        <code class="s1">'Expression bar() should be callable via foo()'</code><code class="p">);</code>
        <code class="nx">bar</code><code class="p">(</code><code class="kc">false</code><code class="p">,</code> <code class="kc">true</code><code class="p">);</code>

    <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>

      <code class="c1">// Fails in IE8 and older</code>
      <code class="nx">ok</code><code class="p">(</code><code class="kc">false</code><code class="p">,</code> 
      <code class="s1">'Expression bar() should NOT be callable outside'</code>
      <code class="o">+</code> <code class="s1">' the expression'</code><code class="p">);</code>

    <code class="p">}</code>
  <code class="p">};</code>

  <code class="nx">bar</code><code class="p">();</code>
  <code class="nx">foo</code><code class="p">(</code><code class="kc">true</code><code class="p">);</code>
    
  <code class="c1">// Fails in IE8 and older</code>
  <code class="nx">ok</code><code class="p">(</code><code class="nx">testDeclaration</code><code class="p">,</code> 
    <code class="s1">'The bar() declaration should NOT get overridden by'</code>
    <code class="o">+</code> <code class="s1">' the expression bar()'</code><code class="p">);</code>
<code class="p">});</code></pre>
</div>
<div class="sect2" id="lambdas">
<div class="titlepage"><div><div><h3 class="title">Lambdas</h3></div></div></div>
<p id="a_lambda_is_a_f">A <em class="firstterm">lambda</em> is a function  that is used as data.  As such, they can be used the same way any other expression can: as a parameter for another function, the return value of a function,  or anywhere you might use a literal value. </p>
<p id="for_example">For example:</p>
<pre class="programlisting" data-language="js" id="var_sum__funct"><code class="kd">var</code> <code class="nx">sum</code> <code class="o">=</code> <code class="kd">function</code> <code class="nx">sum</code><code class="p">()</code> <code class="p">{</code>
  <code class="kd">var</code> <code class="nx">result</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code>

  <code class="p">[</code><code class="mi">5</code><code class="p">,</code> <code class="mi">5</code><code class="p">,</code> <code class="mi">5</code><code class="p">].</code><code class="nx">forEach</code><code class="p">(</code><strong class="userinput"><code><code class="kd">function</code> <code class="nx">addTo</code><code class="p">(</code><code class="nx">number</code><code class="p">)</code> <code class="p">{</code> <code class="nx">result</code> <code class="o">+=</code> <code class="nx">number</code><code class="p">;</code> <code class="p">}</code></code></strong><code class="p">);</code>

  <code class="k">return</code> <code class="nx">result</code><code class="p">;</code>
<code class="p">};</code>

<code class="nx">test</code><code class="p">(</code><code class="s1">'Lambdas.'</code><code class="p">,</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
  <code class="nx">equal</code><code class="p">(</code>
    <code class="nx">sum</code><code class="p">(),</code> <code class="mi">15</code><code class="p">,</code>
    <code class="s1">'result should be 15.'</code>
  <code class="p">);</code>
<code class="p">});</code></pre>
<p id="the_addto_fu">The <code class="code">.addTo()</code> function passed into <code class="code">.forEach()</code> is a lambda. The <code class="code">.forEach()</code>method calls <code class="code">.addTo()</code> for each number in the array.  Note that <code class="code">.addTo()</code> has access to the <code class="code">result</code> variable from the containing function scope's closure (covered in more detail in the section on closures). The <code class="code">.forEach()</code> method is one of several <em class="firstterm">functional enumerators</em> added to JavaScript in the ECMAScript 5 specification. More detail on that can be found in the Functional Programming section.</p>
<p id="in_javascript__id2">In JavaScript, lambdas are commonly used to:</p>
<div class="itemizedlist" id="perform_operati_id1"><ul class="itemizedlist">
<li class="listitem"><p id="perform_operati_id2">Perform operations on the other arguments passed in. (As demonstrated above).</p></li>
<li class="listitem"><p id="attach_event_ha">Attach event handlers for DOM interactions.</p></li>
<li class="listitem"><p id="pass_in_a_callb">Pass in a <em class="firstterm">callback function</em> to be executed when the current function is complete.</p></li>
<li class="listitem"><p id="wrap_existing_f">Wrap existing functions with additional functionality (often used to implement cross-cutting concerns, such as logging). A function that adds functionality to another function is called a <em class="firstterm">function decorator</em>.</p></li>
<li class="listitem"><p id="take_a_function">Take a function that requires multiple parameters, and return a function that requires fewer parameters, (for example, by fixing one or more of the parameters to specific values). (See Partial Application)</p></li>
<li class="listitem"><p id="return_a_functi">Return a function from another function. For example, you might have a function that takes an argument, and returns a curried function that applies that argument in a predetermined calculation. (See Function Currying)</p></li>
</ul></div>
<p id="lambdas_are_fre">Lambdas are frequently confused with anonymous functions, closures, first class functions,  and higher order functions. The concepts are all similar, but they mean different things.</p>
<p id="some_languages_">Some languages use a character (such as "<code class="code">\</code>"), or the keyword, <code class="code">lambda</code>  to denote lambdas and leave off the function name. Don't let that fool you. Function anonymity is merely syntactical sugar for lambdas, designed to make them less verbose and easier to work with. The important point is that lambdas are treated like data that can be passed around as inputs and outputs between other functions, regardless of whether or not they are named.</p>
<p id="closure_refers_">Closure refers to the mechanism that exposes variables  in the containing scope  to access from nested functions (lambdas), even after the containing function has returned. Functions passed as arguments or return values create closures, and it is a common to confuse the words "closure" and "lambda" as synonyms. That is not accurate. The word "closure" refers to the mechanism that allows access to variables from the containing scope, not to the nested functions. Some languages support lambdas, but do not support closures.</p>
<p id="all_functions_i">All functions in JavaScript are first class, meaning that you can use them anywhere you would use a value, so it's possible to create a first class function that is not also a lambda. You can pass any function as data, but when we talk about lambdas in JavaScript, we're talking about actually taking advantage of that capability by treating the function like a value.</p>
<p id="higher_order_fu_id1">Higher order functions are functions that consume or return functions as data. Lambdas get passed to and/or returned from higher order functions, and a function might be both a lambda and a higher order function, but not all higher order functions are lambdas.</p>
<div class="tip" id="if_a_function_i_id1"><p id="if_a_function_i_id2">If a function is  used as an argument or  return value, it's  a lambda.</p></div>
<div class="sect3" id="lambda_calculus_id1">
<div class="titlepage"><div><div><h4 class="title">Lambda Calculus</h4></div></div></div>
<p id="to_add_to_the_c">To add to the confusion, the mathematical inspiration for lambdas (lambda calculus) has special rules that don't apply to JavaScript. For example, in lambda calculus, a lambda can't have more than one argument. Multi-argument operations are computed by fixing an argument and returning a new function that takes the next argument, which is also fixed and returned in a function that takes the next argument and so on. Lambda calculus takes this concept so far that there is even a system for representing numerals using layers of nested lambda expressions (called Church encoding after its discovery by Alonzo Church, the formulator of lambda calculus).</p>
<p id="while_similar_b">While similar behavior is sometimes useful in JavaScript, it's hardly efficient, and rarely required. In short, the definition of lambdas from lambda calculus is a little too limited to apply directly to practical, real-world JavaScript applications.</p>
<p id="whats_really_i">What's really interesting about Lambda calculus is that it has been proved computationally equivalent to a Turing machine: meaning that if an algorithm exists to complete a calculation, that algorithm can be expressed using lambdas.</p>
<p id="lambda_calculus_id2">Lambda calculus was the inspiration for Lisp, a language virtually made up of pure lambda expressions. Interestingly, the expressive power of lambdas makes it very easy to define your own domain specific language inside your Lisp code -- and you can do similar things with JavaScript (see Fluent APIs).</p>
</div>
</div>
<div class="sect2" id="immediately_invoked_function_expressions">
<div class="titlepage"><div><div><h3 class="title">Immediately Invoked Function Expressions</h3></div></div></div>
<p id="its_possible_i">It's possible  in JavaScript to immediately invoke a function as soon as it's defined. A popular name for the technique is a <em class="firstterm">self invoked anonymous function</em>. That name is not accurate because it incorrectly implies that the function is recursive. Ben Alman posted a better suggestion on his blog: <em class="firstterm">Immediately Invoked Function Expression</em> (IIFE, pronounced <span class="emphasis"><em>"iffy"</em></span>). The name is a lot more fun to say in the abbreviated form, and clearly describes what it is. Thankfully, the name IIFE seems to be taking root.</p>
<p id="this_technique_">This technique is often used to create a new scope to encapsulate modules. jQuery uses IIFEs to isolate its variables from the global scope. Before the IIFE became popular, a common technique was to assign  names to the object prototype:</p>
<pre class="programlisting" data-language="js" id="var_lightbulb__id1"><code class="kd">var</code> <code class="nx">Lightbulb</code> <code class="o">=</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
    <code class="k">this</code><code class="p">.</code><code class="nx">isOn</code> <code class="o">=</code> <code class="kc">false</code><code class="p">;</code>
  <code class="p">},</code>
  <code class="nx">lightbulb</code> <code class="o">=</code> <code class="k">new</code> <code class="nx">Lightbulb</code><code class="p">();</code>

<code class="nx">Lightbulb</code><code class="p">.</code><code class="nx">prototype</code><code class="p">.</code><code class="nx">toggle</code> <code class="o">=</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
  <code class="k">this</code><code class="p">.</code><code class="nx">isOn</code> <code class="o">=</code> <code class="o">!</code><code class="k">this</code><code class="p">.</code><code class="nx">isOn</code><code class="p">;</code>
  <code class="k">return</code> <code class="k">this</code><code class="p">.</code><code class="nx">isOn</code><code class="p">;</code>
<code class="p">};</code>

<code class="nx">Lightbulb</code><code class="p">.</code><code class="nx">prototype</code><code class="p">.</code><code class="nx">getState</code> <code class="o">=</code> <code class="kd">function</code> <code class="nx">getState</code><code class="p">()</code> <code class="p">{</code>
  <code class="c1">// Implementation...</code>
<code class="p">};</code>

<code class="nx">Lightbulb</code><code class="p">.</code><code class="nx">prototype</code><code class="p">.</code><code class="nx">off</code> <code class="o">=</code> <code class="kd">function</code> <code class="nx">off</code><code class="p">()</code> <code class="p">{</code>
  <code class="c1">// Implementation...</code>
<code class="p">};</code>

<code class="nx">Lightbulb</code><code class="p">.</code><code class="nx">prototype</code><code class="p">.</code><code class="nx">on</code> <code class="o">=</code> <code class="kd">function</code> <code class="nx">on</code><code class="p">()</code> <code class="p">{</code>
  <code class="c1">// Implementation...</code>
<code class="p">};</code>

<code class="nx">Lightbulb</code><code class="p">.</code><code class="nx">prototype</code><code class="p">.</code><code class="nx">blink</code> <code class="o">=</code> <code class="kd">function</code> <code class="nx">blink</code><code class="p">()</code> <code class="p">{</code>
  <code class="c1">// Implementation...</code>
<code class="p">};</code>

<code class="nx">test</code><code class="p">(</code><code class="s1">'Prototypes without IIFE.'</code><code class="p">,</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
  <code class="nx">equal</code><code class="p">(</code><code class="nx">lightbulb</code><code class="p">.</code><code class="nx">toggle</code><code class="p">(),</code> <code class="kc">true</code><code class="p">,</code> <code class="s1">'Lightbulb turns on.'</code><code class="p">);</code>
  <code class="nx">equal</code><code class="p">(</code><code class="nx">lightbulb</code><code class="p">.</code><code class="nx">toggle</code><code class="p">(),</code> <code class="kc">false</code><code class="p">,</code> <code class="s1">'Lightbulb turns off.'</code><code class="p">);</code>
<code class="p">});</code></pre>
<p id="as_you_can_see_id3">As you can see, this method leads to a lot of repetition as you have to specifically address <code class="code">lightbulb.prototype</code> for every property definition. The IIFE lets you encapsulate scope, so you can assign to regular variables, instead of just the prototype. This gives you more flexibility, and the ability to hide state inside the function closure:</p>
<pre class="programlisting" data-language="js" id="function____id1"><code class="p">(</code><code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
  <code class="kd">var</code> <code class="nx">isOn</code> <code class="o">=</code> <code class="kc">false</code><code class="p">,</code>
    <code class="nx">toggle</code> <code class="o">=</code> <code class="kd">function</code> <code class="nx">toggle</code><code class="p">()</code> <code class="p">{</code>
      <code class="nx">isOn</code> <code class="o">=</code> <code class="o">!</code><code class="nx">isOn</code><code class="p">;</code>
      <code class="k">return</code> <code class="nx">isOn</code><code class="p">;</code>
    <code class="p">},</code>
    <code class="nx">getState</code> <code class="o">=</code> <code class="kd">function</code> <code class="nx">getState</code><code class="p">()</code> <code class="p">{</code>
      <code class="c1">// Implementation...</code>
    <code class="p">},</code>
    <code class="nx">off</code> <code class="o">=</code> <code class="kd">function</code> <code class="nx">off</code><code class="p">()</code> <code class="p">{</code>
      <code class="c1">// Implementation...</code>
    <code class="p">},</code>
    <code class="nx">on</code> <code class="o">=</code> <code class="kd">function</code> <code class="nx">on</code><code class="p">()</code> <code class="p">{</code>
      <code class="c1">// Implementation...</code>
    <code class="p">},</code>
    <code class="nx">blink</code> <code class="o">=</code> <code class="kd">function</code> <code class="nx">blink</code><code class="p">()</code> <code class="p">{</code>
      <code class="c1">// Implementation...</code>
    <code class="p">},</code>

    <code class="nx">lightbulb</code> <code class="o">=</code> <code class="p">{</code>
      <code class="nx">toggle</code><code class="o">:</code> <code class="nx">toggle</code><code class="p">,</code>
      <code class="nx">getState</code><code class="o">:</code> <code class="nx">getState</code><code class="p">,</code>
      <code class="nx">off</code><code class="o">:</code> <code class="nx">off</code><code class="p">,</code>
      <code class="nx">on</code><code class="o">:</code> <code class="nx">on</code><code class="p">,</code>
      <code class="nx">blink</code><code class="o">:</code> <code class="nx">blink</code>
    <code class="p">};</code>

  <code class="nx">test</code><code class="p">(</code><code class="s1">'Prototypes with IIFE.'</code><code class="p">,</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
    <code class="nx">equal</code><code class="p">(</code><code class="nx">lightbulb</code><code class="p">.</code><code class="nx">toggle</code><code class="p">(),</code> <code class="kc">true</code><code class="p">,</code> <code class="s1">'Lightbulb turns on.'</code><code class="p">);</code>
    <code class="nx">equal</code><code class="p">(</code><code class="nx">lightbulb</code><code class="p">.</code><code class="nx">toggle</code><code class="p">(),</code> <code class="kc">false</code><code class="p">,</code> <code class="s1">'Lightbulb turns off.'</code><code class="p">);</code>
  <code class="p">});</code>
<code class="p">}());</code></pre>
</div>
<div class="sect2" id="method_context">
<div class="titlepage"><div><div><h3 class="title">Method Context</h3></div></div></div>
<p id="functions_are_i">Functions are invoked by appending parentheses to the end of the function reference. For these examples, we'll use  a slightly altered <code class="code">highPass()</code> function:</p>
<pre class="programlisting" data-language="js" id="function_highpa"><code class="kd">function</code> <code class="nx">highPass</code><code class="p">(</code><code class="nx">number</code><code class="p">,</code> <code class="nx">cutoff</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">cutoff</code> <code class="o">=</code> <code class="nx">cutoff</code> <code class="o">||</code> <code class="k">this</code><code class="p">.</code><code class="nx">cutoff</code><code class="p">;</code>
    <code class="k">return</code> <code class="p">(</code><code class="nx">number</code> <code class="o">&gt;=</code> <code class="nx">cutoff</code><code class="p">);</code>
<code class="p">}</code>

<code class="kd">var</code> <code class="nx">filter1</code> <code class="o">=</code> <code class="p">{</code>
        <code class="nx">highPass</code><code class="o">:</code> <code class="nx">highPass</code><code class="p">,</code>
        <code class="nx">cutoff</code><code class="o">:</code> <code class="mi">5</code>
    <code class="p">},</code>
    <code class="nx">filter2</code> <code class="o">=</code> <code class="p">{</code>
        <code class="c1">// No highPass here!</code>
        <code class="nx">cutoff</code><code class="o">:</code> <code class="mi">3</code>
    <code class="p">};</code></pre>
<p id="the_highpass_">The <code class="code">highPass()</code> function takes one required parameter for the <code class="code">number</code> to be tested, and one optional parameter for the <code class="code">cutoff</code>. If the optional parameter is not supplied, the function assumes that it's being called as a method of a valid filter object, and uses the <code class="code">cutoff</code> property of the object, instead.</p>
<p id="function_invoca">Function invocation is simple:</p>
<pre class="programlisting" data-language="js" id="testinvoking__id1"><code class="nx">test</code><code class="p">(</code><code class="s1">'Invoking a function.'</code><code class="p">,</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
    <code class="kd">var</code> <code class="nx">result</code> <code class="o">=</code> <code class="nx">highPass</code><code class="p">(</code><code class="mi">6</code><code class="p">,</code> <code class="mi">5</code><code class="p">);</code>

    <code class="nx">equal</code><code class="p">(</code>
        <code class="nx">result</code><code class="p">,</code> <code class="kc">true</code><code class="p">,</code>
        <code class="s1">'6 &gt; 5 should be true.'</code>
    <code class="p">);</code>
<code class="p">});</code></pre>
<div class="caution" id="unless_you_use__id1"><p id="unless_you_use__id2">Unless you use <em class="firstterm">method invocation</em> (<em class="firstterm">dot notation</em> or <em class="firstterm">square bracket notation</em>), <code class="code">this</code> generally refers to the global object. Assignments to properties on <code class="code">this</code> will pollute  the global namespace. It's better to make sure you have a valid object before trying to use <code class="code">this</code> in your function if you expect it might be invoked on its own.</p></div>
<p id="method_invocati">Method invocation applies the function to the object to which it is attached. It takes the form, <code class="code">object.methodName()</code> (dot notation) or <code class="code">object['methodName']</code> (square bracket notation).</p>
<pre class="programlisting" data-language="js" id="testinvoking__id2"><code class="nx">test</code><code class="p">(</code><code class="s1">'Invoking a method.'</code><code class="p">,</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
  <code class="kd">var</code> <code class="nx">result1</code> <code class="o">=</code> <code class="nx">filter1</code><code class="p">.</code><code class="nx">highPass</code><code class="p">(</code><code class="mi">3</code><code class="p">),</code>
    <code class="nx">result2</code> <code class="o">=</code> <code class="nx">highPass</code><code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">filter2</code><code class="p">,</code> <code class="mi">3</code><code class="p">),</code>
    <code class="nx">result3</code> <code class="o">=</code> <code class="nx">filter1</code><code class="p">.</code><code class="nx">highPass</code><code class="p">(</code><code class="mi">6</code><code class="p">);</code>

  <code class="nx">equal</code><code class="p">(</code>
    <code class="nx">result1</code><code class="p">,</code> <code class="kc">false</code><code class="p">,</code>
    <code class="s1">'3 &gt;= filter1.cutoff should be false.'</code>
  <code class="p">);</code>

  <code class="nx">equal</code><code class="p">(</code>
    <code class="nx">result2</code><code class="p">,</code> <code class="kc">true</code><code class="p">,</code>
    <code class="s1">'3 &gt;= filter2.cutoff should be true.'</code>
  <code class="p">);</code>

  <code class="nx">equal</code><code class="p">(</code>
    <code class="nx">result3</code><code class="p">,</code> <code class="kc">true</code><code class="p">,</code>
    <code class="s1">'6 &gt;= filter1.cutoff should be true.'</code>
  <code class="p">);</code>
<code class="p">});</code></pre>
<p id="when_you_invoke">When you invoke a method with  dot notation, you have access to the object's properties using <code class="code">this</code>. The <code class="code">number</code> parameter is compared to <code class="code">filter1.cutoff</code>. The method returns <code class="code">false</code> because <code class="code">3</code> is less than the value stored in <code class="code">this.cutoff</code>, which refers to <code class="code">filter1.cutoff</code>. Remember, <code class="code">this</code> refers to the object that the method is called on.</p>
<p id="in_the_second_e">In the second example, the  <code class="code">call</code> method (inherited from <code class="code">Function.prototype</code>) delegates to the method on <code class="code">filter2</code>, instead. Because filter2.cutoff is 3 instead of 5, the same test passes this time.</p>
<p id="to_clarify_the">To clarify, the  <code class="code">.call()</code> method shared by all functions  allows you to call any method or function on any object. In other words, it sets <code class="code">this</code> inside the method to refer to the object of your choosing. The signature is:</p>
<pre class="programlisting" id="somemethodcall">someMethod.call(<em class="replaceable"><code>context, argument1, argument2, ...</code></em>);</pre>
<p id="where_context_i">Where <code class="code">context</code> is the object you want <code class="code">this</code> to refer to. If you need to pass an array of arguments, use apply, instead:</p>
<pre class="programlisting" id="somemethadappl">someMethad.apply(<em class="replaceable"><code>context, someArray</code></em>);</pre>
<div class="sect3" id="functionprototypebind">
<div class="titlepage"><div><div><h4 class="title">Function.prototype.bind()</h4></div></div></div>
<p id="as_useful_as_c">As useful as <code class="code">.call()</code> and <code class="code">.apply()</code> can be, they have one serious drawback: They impermanently bind the context to the target method. You have to remember to use them every time you invoke the method, and you have to have a access to the context object in scope. That's not always easy, particularly in event handlers.</p>
<p id="the_bind_met">The <code class="code">.bind()</code> method is used to permanently set the value of <code class="code">this</code> inside the target function to the passed in context object. <code class="code">The .bind()</code> method is a recent addition to the language. It was first popularized by Prototype and adopted in many other libraries, and was standardized in ECMAScript 5. If you want to use it in older browsers, you'll need to shim it or use one of many available  library implementations.</p>
<p id="lets_take_a_lo">Let's take a look at a common use case for bind. An event handler:</p>
<pre class="programlisting" data-language="js" id="var_lightbulb__id2"><code class="kd">var</code> <code class="nx">lightbulb</code> <code class="o">=</code> <code class="p">{</code>
    <code class="nx">toggle</code><code class="o">:</code> <code class="kd">function</code> <code class="nx">toggle</code><code class="p">()</code> <code class="p">{</code>
      <code class="k">this</code><code class="p">.</code><code class="nx">isOn</code> <code class="o">=</code> <code class="o">!</code><code class="k">this</code><code class="p">.</code><code class="nx">isOn</code><code class="p">;</code>
      <code class="k">return</code> <code class="k">this</code><code class="p">.</code><code class="nx">isOn</code><code class="p">;</code>
    <code class="p">},</code>
    <code class="nx">isOn</code><code class="o">:</code> <code class="kc">false</code>
  <code class="p">},</code>
  <code class="nx">toggle</code> <code class="o">=</code> <code class="nx">lightbulb</code><code class="p">.</code><code class="nx">toggle</code><code class="p">.</code><code class="nx">bind</code><code class="p">(</code><code class="nx">lightbulb</code><code class="p">),</code>
  <code class="nx">lightswitch</code> <code class="o">=</code> <code class="nb">document</code><code class="p">.</code><code class="nx">getElementById</code><code class="p">(</code><code class="s1">'lightswitch'</code><code class="p">);</code>

<code class="nx">lightswitch</code> <code class="o">=</code> <code class="nb">document</code><code class="p">.</code><code class="nx">getElementById</code><code class="p">(</code><code class="s1">'lightswitch'</code><code class="p">);</code>
<code class="nx">lightswitch</code><code class="p">.</code><code class="nx">addEventListener</code><code class="p">(</code><code class="s1">'click'</code><code class="p">,</code> <code class="nx">toggle</code><code class="p">,</code> <code class="kc">false</code><code class="p">);</code></pre>
<p id="glancing_over_t">Glancing over this code, it looks simple enough.  An event listener gets attached to the lightswitch DOM with <code class="code">.addEventListener()</code>. There's just one problem: This code will fail, because the context inside an event listener is not the object that the method was assigned to at design time. Instead, it's a reference to the element that was clicked.</p>
<p id="even_after_you_">Even after you click the switch element, <code class="code">lightbulb.isOn</code> will be <code class="code">false</code>. You can fix this mess with <code class="code">.bind()</code>. You only need to alter the toggle assignment:</p>
<pre class="programlisting" data-language="js" id="toggle__lightb"><code class="nx">toggle</code> <code class="o">=</code> <code class="nx">lightbulb</code><code class="p">.</code><code class="nx">toggle</code><code class="p">.</code><code class="nx">bind</code><code class="p">(</code><code class="nx">lightbulb</code><code class="p">);</code></pre>
<p id="now_when_the_u">Now, when the user clicks the lightswitch, the lightbulb will turn on or off as expected.</p>
</div>
</div>
</div>
<div class="sect1" data-original-filename="ch03.xml" id="function_scope">
<div class="titlepage"><div><div><h2 class="title">Function Scope</h2></div></div></div>
<p id="variable_scope_">Variable <em class="firstterm">scope</em> is the section of code in which the identifier refers to the expected value. Outside a variable's scope, the variable is undefined, or replaced by another variable with the same name. Most C-family languages have <em class="firstterm">block scope</em>: meaning that you can create blocks arbitrarily to contain variables. JavaScript does not have block scope. This is a common source of confusion among people who are new to JavaScript, but  familiar with other languages.</p>
<p id="javascript_has__id3">JavaScript  has <em class="firstterm">function scope</em>, instead. This has been a point of debate in the JavaScript community, and block scope has been discussed for future versions of the language.</p>
<p id="the_desire_to_u_id2"></p>
<div class="tip" id="the_desire_to_u_id3"><p id="the_desire_to_u_id4">The desire to use block scope can be a good code smell that indicates that it may be time to break a function into smaller pieces in order to encourage readability, organization, and code reuse. It's a good idea to keep functions small.</p></div>
<div class="sect2" id="hoisting">
<div class="titlepage"><div><div><h3 class="title">Hoisting</h3></div></div></div>
<p id="hoisting_is_the"><em class="firstterm">Hoisting</em> is the word most commonly used to describe the illusion that all variable declarations are "hoisted" to the top of the containing function. Technically, that's not exactly how it happens, but the effect is the same.</p>
<p id="javascript_buil">JavaScript builds its execution environment in two passes. The declaration pass sets up the run time environment, where it scans for all variable and function declarations and creates the identifiers. The second pass is the execution pass. After the first pass, all declared functions are available, but variables are still undefined.  Consider the following code:</p>
<pre class="programlisting" data-language="js" id="var_x___fun_id1"><code class="kd">var</code> <code class="nx">x</code> <code class="o">=</code> <code class="mi">1</code><code class="p">;</code>

<code class="p">(</code><code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
  <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">x</code><code class="p">);</code>
  <code class="kd">var</code> <code class="nx">x</code> <code class="o">=</code> <code class="mi">2</code><code class="p">;</code>
<code class="p">}());</code></pre>
<p id="if_you_guessed_">If you guessed that the value of <code class="code">x</code> at the <code class="code">console.log()</code> statement is <code class="code">1</code>, you're not alone. This is a common source of bugs in JavaScript. In the first pass, the function declarations occur, and <code class="code">x</code> is <code class="code">undefined</code> in both the inner and outer scope. When it gets to the <code class="code">console.log()</code> statement in the execution pass,  the inner scoped <code class="code">x</code> has been declared, but is still <code class="code">undefined</code>, because it hasn't hit the initialization in the next statement yet. In effect, this is how JavaScript interprets the code:</p>
<pre class="programlisting" data-language="js" id="var_x___fun_id2"><code class="kd">var</code> <code class="nx">x</code> <code class="o">=</code> <code class="mi">1</code><code class="p">;</code>

<code class="p">(</code><code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
  <code class="kd">var</code> <code class="nx">x</code><code class="p">;</code> <code class="c1">// Declarition is hoisted and x is undefined.</code>
  <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">x</code><code class="p">);</code>
  <code class="nx">x</code> <code class="o">=</code> <code class="mi">2</code><code class="p">;</code> <code class="c1">// Initialization is still down here.</code>
<code class="p">}());</code></pre>
<p id="functions_behav">Functions behave a little differently. Remember that declarations get hoisted:</p>
<p id="testfunction__id2"></p>
<pre class="programlisting" data-language="js" id="testfunction__id3"><code class="nx">test</code><code class="p">(</code><code class="s1">'Function Declaration Hoisting'</code><code class="p">,</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
  <code class="kd">function</code> <code class="nx">number</code><code class="p">()</code> <code class="p">{</code>
    <code class="k">return</code> <code class="mi">1</code><code class="p">;</code>
  <code class="p">}</code>

  <code class="p">(</code><code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
    <code class="nx">equal</code><code class="p">(</code><code class="nx">number</code><code class="p">(),</code> <code class="mi">2</code><code class="p">,</code> <code class="s1">'Inner scope wins.'</code><code class="p">);</code>

    <code class="kd">function</code> <code class="nx">number</code><code class="p">()</code> <code class="p">{</code>
      <code class="k">return</code> <code class="mi">2</code><code class="p">;</code>
    <code class="p">}</code>
  <code class="p">}());</code>

  <code class="nx">equal</code><code class="p">(</code><code class="nx">number</code><code class="p">(),</code> <code class="mi">1</code><code class="p">,</code> <code class="s1">'Outer scope still works.'</code><code class="p">);</code>
<code class="p">});</code></pre>
<p id="this_code_is_eq">This code is equivalent to:</p>
<pre class="programlisting" data-language="js" id="testfunction__id4"><code class="nx">test</code><code class="p">(</code><code class="s1">'Function declaration hoisted.'</code><code class="p">,</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
  <code class="kd">function</code> <code class="nx">number</code><code class="p">()</code> <code class="p">{</code>
    <code class="k">return</code> <code class="mi">1</code><code class="p">;</code>
  <code class="p">}</code>

  <code class="p">(</code><code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
    <code class="kd">function</code> <code class="nx">number</code><code class="p">()</code> <code class="p">{</code>
      <code class="k">return</code> <code class="mi">2</code><code class="p">;</code>
    <code class="p">}</code>

    <code class="nx">equal</code><code class="p">(</code><code class="nx">number</code><code class="p">(),</code> <code class="mi">2</code><code class="p">,</code> <code class="s1">'Inner scope wins.'</code><code class="p">);</code>
  <code class="p">}());</code>

  <code class="nx">equal</code><code class="p">(</code><code class="nx">number</code><code class="p">(),</code> <code class="mi">1</code><code class="p">,</code> <code class="s1">'Outer scope still works.'</code><code class="p">);</code>
<code class="p">});</code></pre>
<p id="function_expres">Function expressions do not share this behavior, because they do not declare a function. Instead, they declare a variable, and are subject to the same variable hoisting behavior.</p>
<pre class="programlisting" data-language="js" id="testfunction__id5"><code class="nx">test</code><code class="p">(</code><code class="s1">'Function expression hoisting'</code><code class="p">,</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
  <code class="kd">function</code> <code class="nx">number</code><code class="p">()</code> <code class="p">{</code>
    <code class="k">return</code> <code class="mi">1</code><code class="p">;</code>
  <code class="p">}</code>

  <code class="p">(</code><code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
    <code class="k">try</code> <code class="p">{</code>
      <code class="nx">number</code><code class="p">();</code>
    <code class="p">}</code> <code class="k">catch</code> <code class="p">(</code><code class="nx">e</code><code class="p">)</code> <code class="p">{</code>
      <code class="nx">ok</code><code class="p">(</code><code class="kc">true</code><code class="p">,</code> <code class="s1">'number() is undefined.'</code><code class="p">);</code>
    <code class="p">}</code>

    <code class="kd">var</code> <code class="nx">number</code> <code class="o">=</code> <code class="kd">function</code> <code class="nx">number</code><code class="p">()</code> <code class="p">{</code>
      <code class="k">return</code> <code class="mi">2</code><code class="p">;</code>
    <code class="p">}</code>

    <code class="nx">equal</code><code class="p">(</code><code class="nx">number</code><code class="p">(),</code> <code class="mi">2</code><code class="p">,</code> <code class="s1">'number() is defined now.'</code><code class="p">);</code>
  <code class="p">}());</code>

  <code class="nx">equal</code><code class="p">(</code><code class="nx">number</code><code class="p">(),</code> <code class="mi">1</code><code class="p">,</code> <code class="s1">'Outer scope still works.'</code><code class="p">);</code>
<code class="p">});</code></pre>
<p id="in_the_declarat">In the declaration pass, the <code class="code">number</code> variable is hoisted, but the function body is <span class="emphasis"><em>not hoisted</em></span>, because it is a named function expression, not a function declaration. The value of number is not defined until run time. This code is equivalent to:</p>
<pre class="programlisting" data-language="js" id="testfunction__id6"><code class="nx">test</code><code class="p">(</code><code class="s1">'Function Expression Hoisted'</code><code class="p">,</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
  <code class="kd">function</code> <code class="nx">number</code><code class="p">()</code> <code class="p">{</code>
    <code class="k">return</code> <code class="mi">1</code><code class="p">;</code>
  <code class="p">}</code>

  <code class="p">(</code><code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
    <code class="kd">var</code> <code class="nx">number</code><code class="p">;</code> <code class="c1">// Declaration initialized to undefined.</code>

    <code class="k">try</code> <code class="p">{</code>
      <code class="nx">number</code><code class="p">();</code>
    <code class="p">}</code> <code class="k">catch</code> <code class="p">(</code><code class="nx">e</code><code class="p">)</code> <code class="p">{</code>
      <code class="nx">ok</code><code class="p">(</code><code class="kc">true</code><code class="p">,</code> <code class="s1">'number() is undefined.'</code><code class="p">);</code>
    <code class="p">}</code>

    <code class="nx">number</code> <code class="o">=</code> <code class="kd">function</code> <code class="nx">number</code><code class="p">()</code> <code class="p">{</code>
      <code class="k">return</code> <code class="mi">2</code><code class="p">;</code>
    <code class="p">}</code>

    <code class="nx">equal</code><code class="p">(</code><code class="nx">number</code><code class="p">(),</code> <code class="mi">2</code><code class="p">,</code> <code class="s1">'number() is defined now.'</code><code class="p">);</code>
  <code class="p">}());</code>

  <code class="nx">equal</code><code class="p">(</code><code class="nx">number</code><code class="p">(),</code> <code class="mi">1</code><code class="p">,</code> <code class="s1">'Outer scope still works.'</code><code class="p">);</code>
<code class="p">});</code></pre>
<div class="tip" id="if_you_declare__id1"><p id="if_you_declare__id2">If you declare all of your variables at the top of your function, and define your functions before you try to use them, you'll never need to worry about any of this. This practice can completely eliminate scope related bugs from your code.</p></div>
</div>
<div class="sect2" id="closures">
<div class="titlepage"><div><div><h3 class="title">Closures</h3></div></div></div>
<p id="closures_are_cr">Closures are critical to successful application development.</p>
<p id="in_a_nutshell_">In a nutshell, a <em class="firstterm">closure</em> stores function state, even after the function has returned. To create a closure, simply define a function inside another function and return it. The inner function will have access to the variables declared in the outer function. This technique is commonly used to give objects data privacy.</p>
<p id="because_the_clo">Because the closure variables in the outer function are only in scope within the containing function, you can't get at the data except through its <em class="firstterm">privileged methods</em>. In other languages, a privileged method is an exposed method that has access to private data. In JavaScript, any exposed method defined within the closure scope is privileged. For example:</p>
<pre class="programlisting" data-language="js" id="var_o__functio"><code class="kd">var</code> <code class="nx">o</code> <code class="o">=</code> <code class="kd">function</code> <code class="nx">o</code> <code class="p">()</code> <code class="p">{</code>
  <code class="kd">var</code> <code class="nx">data</code> <code class="o">=</code> <code class="mi">1</code><code class="p">,</code>
    <code class="nx">get</code><code class="p">;</code>

  <code class="nx">get</code> <code class="o">=</code> <code class="kd">function</code> <code class="nx">get</code><code class="p">()</code> <code class="p">{</code>
    <code class="k">return</code> <code class="nx">data</code><code class="p">;</code>
  <code class="p">};</code>

  <code class="k">return</code> <code class="p">{</code>
    <code class="nx">get</code><code class="o">:</code> <code class="nx">get</code>
  <code class="p">};</code>
<code class="p">};</code>

<code class="nx">test</code><code class="p">(</code><code class="s1">'Closure for object privacy.'</code><code class="p">,</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
  <code class="kd">var</code> <code class="nx">obj</code> <code class="o">=</code> <code class="nx">o</code><code class="p">();</code> <code class="c1">// Get an object with the .get() method.</code>

  <code class="k">try</code> <code class="p">{</code>
    <code class="nx">ok</code><code class="p">(</code><code class="nx">data</code><code class="p">,</code> <code class="s1">'This throws an error.'</code><code class="p">);</code>
  <code class="p">}</code> <code class="k">catch</code> <code class="p">(</code><code class="nx">e</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">ok</code><code class="p">(</code><code class="kc">true</code><code class="p">,</code><code class="s1">'The data var is only available'</code>
      <code class="o">+</code> <code class="s1">' to privileged methods.'</code><code class="p">);</code>
  <code class="p">}</code>

  <code class="nx">equal</code><code class="p">(</code>
    <code class="nx">obj</code><code class="p">.</code><code class="nx">get</code><code class="p">(),</code> <code class="mi">1</code><code class="p">,</code>
    <code class="s1">'.get() should have access to the closure.'</code>
  <code class="p">);</code>
<code class="p">});</code></pre>
<p id="in_the_above_ex">In the above example, o is an object factory that defines the private variable <code class="code">data</code>, and a privileged method, <code class="code">.get()</code> that has access to it. The factory exposes <code class="code">.get()</code> in the object literal that it returns.</p>
<p id="in_the_test_th">In the test, the return value from <code class="code">o</code> is assigned to the <code class="code">obj</code> variable. In the <code class="code">try</code> block, the attempt to access the private data <code class="code">var</code> throws an error because it is undeclared outside the closure scope. </p>
<p id="in_addition_to_">In addition to the data privacy benefits,  closures are an essential ingredient in languages that support first class functions, because they give you access to outer scope variables from inside your lambdas.</p>
<p id="closures_are_co">Closures are commonly used to feed data to event handlers or callbacks, which might get triggered long after the containing function has finished. For example:</p>
<pre class="programlisting" data-language="js" id="function____id2"><code class="p">(</code><code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
  <code class="kd">var</code> <code class="nx">arr</code> <code class="o">=</code> <code class="p">[],</code>
    <code class="nx">count</code> <code class="o">=</code> <code class="mi">1</code><code class="p">,</code>
    <code class="nx">delay</code> <code class="o">=</code> <code class="mi">20</code><code class="p">,</code>
    <code class="nx">timer</code><code class="p">,</code>
    <code class="nx">complete</code><code class="p">;</code>

  <code class="nx">timer</code> <code class="o">=</code> <code class="kd">function</code> <code class="nx">timer</code><code class="p">()</code> <code class="p">{</code>
    <code class="nx">setTimeout</code><code class="p">(</code><code class="kd">function</code> <code class="nx">inner</code><code class="p">()</code> <code class="p">{</code>
      <code class="nx">arr</code><code class="p">.</code><code class="nx">push</code><code class="p">(</code><code class="nx">count</code><code class="p">);</code>

      <code class="k">if</code> <code class="p">(</code><code class="nx">count</code> <code class="o">&lt;</code> <code class="mi">3</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">count</code> <code class="o">+=</code> <code class="mi">1</code><code class="p">;</code>
        <code class="nx">timer</code><code class="p">();</code>
      <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>
        <code class="nx">complete</code><code class="p">();</code>
      <code class="p">}</code>
    <code class="p">},</code> <code class="nx">delay</code><code class="p">);</code>
  <code class="p">};</code>

  <code class="nx">asyncTest</code><code class="p">(</code><code class="s1">'Closure with setTimeout.'</code><code class="p">,</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
    <code class="nx">complete</code> <code class="o">=</code> <code class="kd">function</code> <code class="nx">complete</code><code class="p">()</code> <code class="p">{</code>
      <code class="nx">equal</code><code class="p">(</code>
        <code class="nx">arr</code><code class="p">.</code><code class="nx">join</code><code class="p">(</code><code class="s1">','</code><code class="p">),</code> <code class="s1">'1,2,3'</code><code class="p">,</code>
        <code class="s1">'arr should be [1,2,3]'</code>
      <code class="p">);</code>
      <code class="nx">start</code><code class="p">();</code>
    <code class="p">};</code>

    <code class="nx">timer</code><code class="p">();</code>

    <code class="nx">equal</code><code class="p">(</code>
      <code class="nx">arr</code><code class="p">.</code><code class="nx">length</code><code class="p">,</code> <code class="mi">0</code><code class="p">,</code>
      <code class="s1">'array should be empty until the first timout.'</code>
    <code class="p">);</code>
  <code class="p">});</code>
<code class="p">}());</code></pre>
<p id="in_this_example">In this example, the  <code class="code">inner()</code>  lambda has access to <code class="code">arr</code>, <code class="code">complete()</code>, and <code class="code">count</code> from the containing function. Its job is to add the current <code class="code">count</code> to the array each time it's called. If the array isn't full yet, it calls the <code class="code">timer()</code> function to set a new timeout so it will be invoked again after the delay has expired.</p>
<p id="this_is_an_exam">This is an example of asynchronous recursion, and the pattern is sometimes used to retry Ajax requests when they fail. There is usually a retry limit and a delay so that the server doesn't get hammered with endless retries from millions of users.</p>
<p id="the_asynctest">The <code class="code">asyncTest()</code> function is provided by QUnit as a shortcut for running asynchronous tests. Normally, you need to call <code class="code">stop()</code> at the top of your test to tell QUnit that you're expecting assertions to fire asynchronously. The <code class="code">stop()</code> function suspends the completion of the test until <code class="code">start()</code> gets called.</p>
<p id="when_the_test_r">When the test runs, the <code class="code">complete()</code> function gets defined. It will later be called from <code class="code">inner()</code> after all of the timeouts have expired. The complete function defines an <code class="code">equal()</code> assertion to verify the contents of <code class="code">arr</code>.</p>
<p id="as_you_can_see_id4">As you can see, the final <code class="code">equal()</code> assertion in the program listing is actually the first one that gets run. That's because the first timeout has not had time to expire before the JavaScript engine gets to that line in the code. At that point, any attempt to read <code class="code">arr</code> or <code class="code">count</code> will return the initial values. The values don't get modified until the first timeout expires, and <code class="code">inner()</code> has had a chance to run.</p>
<p id="each_time_inner">Each time <code class="code">inner()</code> gets called, <code class="code">count</code> is incremented, and pushed onto the array, <code class="code">arr</code>. Since <code class="code">count</code> and <code class="code">arr</code> were defined inside the closure, it's possible to access them from other functions in the same scope, which is why we can test them in the <code class="code">asyncTest()</code> call.</p>
</div>
</div>
<div class="sect1" data-original-filename="ch03.xml" id="method_design">
<div class="titlepage"><div><div><h2 class="title">Method Design</h2></div></div></div>
<p id="several_techniq">Several techniques exist in JavaScript to design method APIs. JavaScript supports named parameter lists, function polymorphism, method chaining, and lambda expressions. You should be familiar with all of these techniques so that you can choose the right tool for the job.</p>
<p id="some_principles">Some principles to keep in mind when you design your methods. This bears repeating:</p>
<div class="itemizedlist" id="keep_it_simple_id1"><ul class="itemizedlist">
<li class="listitem"><p id="keep_it_simple_id2">Keep It Simple, Stupid (KISS)</p></li>
<li class="listitem"><p id="do_one_thing_a">Do One Thing,  and do it well (DOT)</p></li>
<li class="listitem"><p id="dont_repeat_yo_id2">Don't Repeat Yourself (DRY)</p></li>
</ul></div>
<div class="sect2" id="named_parameters">
<div class="titlepage"><div><div><h3 class="title">Named Parameters</h3></div></div></div>
<p id="the_number_of_v">The number of variables you pass into a function is called its <em class="firstterm">arity</em>. Generally speaking, function arity should be kept small, but sometimes you need a wide range of parameters (for example, to initialize the configuration of a module, or create a new object instance). The trouble with a large arity is that each parameter must be passed into the function in the right order, even if several parameters are not needed. It can be difficult to remember what order is required, and it doesn't make sense to require a parameter that isn't really required for the function to do its job properly.</p>
<p id="this_example_is">This example is designed to set up  a new user account. Each user account has some default settings that get honored unless an override value is passed in:</p>
<pre class="programlisting" data-language="js" id="var_userproto_"><code class="kd">var</code> <code class="nx">userProto</code> <code class="o">=</code> <code class="p">{</code>
    <code class="nx">name</code><code class="o">:</code> <code class="s1">''</code><code class="p">,</code>
    <code class="nx">email</code><code class="o">:</code> <code class="s1">''</code><code class="p">,</code>
    <code class="nx">alias</code><code class="o">:</code> <code class="s1">''</code><code class="p">,</code>
    <code class="nx">showInSearch</code><code class="o">:</code> <code class="kc">true</code><code class="p">,</code>
    <code class="nx">colorScheme</code><code class="o">:</code> <code class="s1">'light'</code>
  <code class="p">};</code>

<code class="kd">function</code> <code class="nx">createUser</code><code class="p">(</code><code class="nx">name</code><code class="p">,</code> <code class="nx">email</code><code class="p">,</code> <code class="nx">alias</code><code class="p">,</code> <code class="nx">showInSearch</code><code class="p">,</code> 
  <code class="nx">colorScheme</code><code class="p">)</code> <code class="p">{</code>

  <code class="k">return</code> <code class="p">{</code>
    <code class="nx">name</code><code class="o">:</code> <code class="nx">name</code> <code class="o">||</code> <code class="nx">userProto</code><code class="p">.</code><code class="nx">name</code><code class="p">,</code>
    <code class="nx">name</code><code class="o">:</code> <code class="nx">email</code> <code class="o">||</code> <code class="nx">userProto</code><code class="p">.</code><code class="nx">email</code><code class="p">,</code>
    <code class="nx">alias</code><code class="o">:</code> <code class="nx">alias</code> <code class="o">||</code> <code class="nx">userProto</code><code class="p">.</code><code class="nx">alias</code><code class="p">,</code>
    <code class="nx">showInSearch</code><code class="o">:</code> <code class="nx">showInSearch</code><code class="p">,</code>
    <code class="nx">colorScheme</code><code class="o">:</code> <code class="nx">colorScheme</code> <code class="o">||</code> <code class="nx">userProto</code><code class="p">.</code><code class="nx">colorScheme</code>
  <code class="p">};</code>
<code class="p">}</code>

<code class="nx">test</code><code class="p">(</code><code class="s1">'User account creation'</code><code class="p">,</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
  <code class="kd">var</code> <code class="nx">newUser</code> <code class="o">=</code> <code class="nx">createUser</code><code class="p">(</code><code class="s1">'Tonya'</code><code class="p">,</code> <code class="s1">''</code><code class="p">,</code> <code class="s1">''</code><code class="p">,</code> <code class="s1">''</code><code class="p">,</code> <code class="s1">'dark'</code><code class="p">);</code>
    
  <code class="nx">equal</code><code class="p">(</code><code class="nx">newUser</code><code class="p">.</code><code class="nx">colorScheme</code><code class="p">,</code> <code class="s1">'dark'</code><code class="p">,</code>
    <code class="s1">'colorScheme stored correctly.'</code><code class="p">);</code>
<code class="p">});</code></pre>
<p id="in_this_case_t">In this case, the <code class="code">createUser()</code> function takes five optional parameters. The userProto object is a prototype (not to be confused with the <code class="code">prototype</code> property).  The trouble with this implementation becomes obvious when you look at the usage in isolation:</p>
<pre class="programlisting" data-language="js" id="var_newuser__c_id1"><code class="kd">var</code> <code class="nx">newUser</code> <code class="o">=</code> <code class="nx">createUser</code><code class="p">(</code><code class="s1">'Tonya'</code><code class="p">,</code> <code class="s1">''</code><code class="p">,</code> <code class="s1">''</code><code class="p">,</code> <code class="s1">''</code><code class="p">,</code> <code class="s1">'dark'</code><code class="p">);</code></pre>
<p id="what_jumps_out_">What jumps out immediately is that it's impossible to know what the second, third, or fourth parameter is without looking at the <code class="code">createUser()</code> implementation. It's also impossible to set the last parameter without passing in values for <span class="emphasis"><em>all parameters</em></span>. What's more, if you want to add more parameters later, or change the order of the parameters, it's going to be difficult if the function is used frequently.</p>
<p id="here_is_a_bette">Here is a better alternative:</p>
<pre class="programlisting" data-language="js" id="var_newuser__c_id2"><code class="kd">var</code> <code class="nx">newUser</code> <code class="o">=</code> <code class="nx">createUser</code><code class="p">({</code>
  <code class="nx">name</code><code class="o">:</code> <code class="s1">'Mike'</code><code class="p">,</code>
  <code class="nx">showInSearch</code><code class="o">:</code> <code class="kc">false</code>
<code class="p">});</code></pre>
<p id="you_can_impleme">You can implement this easily using the extend method that comes with most popular libraries (including jQuery and Underscore). Here's how it's done with jQuery:</p>
<pre class="programlisting" data-language="js" id="function_create"><code class="kd">function</code> <code class="nx">createUser</code><code class="p">(</code><code class="nx">options</code><code class="p">)</code> <code class="p">{</code>
  <code class="k">return</code> <code class="nx">$</code><code class="p">.</code><code class="nx">extend</code><code class="p">({},</code> <code class="nx">userProto</code><code class="p">,</code> <code class="nx">options</code><code class="p">);</code>
<code class="p">}</code></pre>
<p id="extend_take"><code class="code">$.extend()</code> takes objects as its parameters. The first is the object to be extended. In this case, we want to return a new object so that we don't alter the userProto or options objects. The other objects (as many as you like) hold the properties and methods you wish to extend the first object with. This is a simple, elegant way to reuse code. </p>
</div>
<div class="sect2" id="function_polymorphism">
<div class="titlepage"><div><div><h3 class="title">Function Polymorphism</h3></div></div></div>
<p id="in_computer_sci">In computer science, <em class="firstterm">polymorphism</em> means that something behaves differently based on context, like words that have different meanings based on how they're used:</p>
<div class="itemizedlist" id="watch_out_for__id1"><ul class="itemizedlist">
<li class="listitem"><p id="watch_out_for__id2">"Watch out for that sharp turn in the road!"</p></li>
<li class="listitem"><p id="that_knife_is_">"That knife is sharp!"</p></li>
<li class="listitem"><p id="john_resig_is_">"John Resig is sharp! Making the jQuery function polymorphic was a stroke of genius."</p></li>
</ul></div>
<p id="polymorphic_fun_id1"><em class="firstterm">Polymorphic functions</em> behave differently based on the parameters you pass into them.  In JavaScript, those parameters are stored in the array-like <code class="code">arguments</code> object, but it’s missing useful array methods.</p>
<p id="arrayprototype"><code class="code">Array.prototype.slice()</code> is an easy way to shallow copy some or all of an array (or an array-like object).</p>
<p id="you_can_borrow_">You can borrow the <code class="code">.slice()</code> method from the <code class="code">Array</code> prototype using a technique called <em class="firstterm">method delegation</em>. You delegate the <code class="code">.slice()</code>call to the  <code class="code">Array.prototype</code>  object. The method call looks like this:</p>
<pre class="programlisting" data-language="js" id="var_args__arra"><code class="kd">var</code> <code class="nx">args</code> <code class="o">=</code> <code class="nb">Array</code><code class="p">.</code><code class="nx">prototype</code><code class="p">.</code><code class="nx">slice</code><code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">arguments</code><code class="p">,</code> <code class="mi">0</code><code class="p">);</code></pre>
<p id="slice_starts_at">Slice starts at index <code class="code">0</code> and returns everything from that index on as a new array. That syntax is  a little long winded, though. It's easier and faster to write:</p>
<pre class="programlisting" data-language="js" id="var_args__s"><code class="kd">var</code> <code class="nx">args</code> <code class="o">=</code> <code class="p">[].</code><code class="nx">slice</code><code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">arguments</code><code class="p">,</code> <code class="mi">0</code><code class="p">);</code></pre>
<p id="the_square_brac">The square bracket notation creates a new empty array to delegate the slice call to. That sounds like it might be slow, but creating an empty array is actually a very fast operation. Faster, in fact, than delegating to <code class="code">Array.prototype</code>.</p>
<p id="you_could_use_t">You could use this technique to create a function that sorts parameters:</p>
<pre class="programlisting" data-language="js" id="function_sort"><code class="kd">function</code> <code class="nx">sort</code><code class="p">()</code> <code class="p">{</code>
  <code class="kd">var</code> <code class="nx">args</code> <code class="o">=</code> <code class="p">[].</code><code class="nx">slice</code><code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">arguments</code><code class="p">,</code> <code class="mi">0</code><code class="p">);</code>
  <code class="k">return</code> <code class="nx">args</code><code class="p">.</code><code class="nx">sort</code><code class="p">();</code>
<code class="p">}</code>

<code class="nx">test</code><code class="p">(</code><code class="s1">'Sort'</code><code class="p">,</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
  <code class="kd">var</code> <code class="nx">result</code> <code class="o">=</code> <code class="nx">sort</code><code class="p">(</code><code class="s1">'b'</code><code class="p">,</code> <code class="s1">'a'</code><code class="p">,</code> <code class="s1">'c'</code><code class="p">);</code>   
  <code class="nx">ok</code><code class="p">(</code><code class="nx">result</code><code class="p">,</code> <code class="p">[</code><code class="s1">'a'</code><code class="p">,</code> <code class="s1">'b'</code><code class="p">,</code> <code class="s1">'c'</code><code class="p">],</code> <code class="s1">'Sort works!'</code><code class="p">);</code>
<code class="p">});</code></pre>
<p id="because_argumen">Because <code class="code">arguments</code> is not a real array, it doesn't have the <code class="code">.sort()</code> method. However, since a real array is returned from the <code class="code">.slice()</code> call, you have access to all of the array  methods on the <code class="code">args</code> array. The  <code class="code">.sort()</code> method returns a sorted version of the array.</p>
<p id="polymorphic_fun_id2">Polymorphic functions frequently need to examine the first argument in order to decide how to respond. Now that <code class="code">args</code> is a real array, you can use the <code class="code">.shift()</code> method to get the first argument:</p>
<pre class="programlisting" data-language="js" id="var_first__arg"><code class="kd">var</code> <code class="nx">first</code> <code class="o">=</code> <code class="nx">args</code><code class="p">.</code><code class="nx">shift</code><code class="p">();</code></pre>
<p id="now_you_can_bra">Now you can branch if a string  is passed as the first parameter:</p>
<pre class="programlisting" data-language="js" id="function_morph"><code class="kd">function</code> <code class="nx">morph</code><code class="p">(</code><code class="nx">options</code><code class="p">)</code> <code class="p">{</code>
  <code class="kd">var</code> <code class="nx">args</code> <code class="o">=</code> <code class="p">[].</code><code class="nx">slice</code><code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">arguments</code><code class="p">,</code> <code class="mi">0</code><code class="p">),</code>
    <code class="nx">animals</code> <code class="o">=</code> <code class="s1">'turtles'</code><code class="p">;</code> <code class="c1">// Set a default</code>

  <code class="k">if</code> <code class="p">(</code><code class="k">typeof</code> <code class="nx">options</code> <code class="o">===</code> <code class="s1">'string'</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">animals</code> <code class="o">=</code> <code class="nx">options</code><code class="p">;</code>
    <code class="nx">args</code><code class="p">.</code><code class="nx">shift</code><code class="p">();</code>
  <code class="p">}</code>

  <code class="k">return</code><code class="p">(</code><code class="s1">'The pet store has '</code> <code class="o">+</code> <code class="nx">args</code> <code class="o">+</code> <code class="s1">' '</code> <code class="o">+</code> <code class="nx">animals</code>
    <code class="o">+</code> <code class="s1">'.'</code><code class="p">);</code>
<code class="p">}</code>

<code class="nx">test</code><code class="p">(</code><code class="s1">'Polymorphic branching.'</code><code class="p">,</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
  <code class="kd">var</code> <code class="nx">test1</code> <code class="o">=</code> <code class="nx">morph</code><code class="p">(</code><code class="s1">'cats'</code><code class="p">,</code> <code class="mi">3</code><code class="p">),</code>
    <code class="nx">test2</code> <code class="o">=</code> <code class="nx">morph</code><code class="p">(</code><code class="s1">'dogs'</code><code class="p">,</code> <code class="mi">4</code><code class="p">),</code>
    <code class="nx">test3</code> <code class="o">=</code> <code class="nx">morph</code><code class="p">(</code><code class="mi">2</code><code class="p">);</code>

  <code class="nx">equal</code><code class="p">(</code><code class="nx">test1</code><code class="p">,</code> <code class="s1">'The pet store has 3 cats.'</code><code class="p">,</code> <code class="s1">'3 Cats.'</code><code class="p">);</code>
  <code class="nx">equal</code><code class="p">(</code><code class="nx">test2</code><code class="p">,</code> <code class="s1">'The pet store has 4 dogs.'</code><code class="p">,</code> <code class="s1">'4 Dogs.'</code><code class="p">);</code>
  <code class="nx">equal</code><code class="p">(</code><code class="nx">test3</code><code class="p">,</code> <code class="s1">'The pet store has 2 turtles.'</code><code class="p">,</code>
    <code class="s1">'The pet store has 2 turtles.'</code><code class="p">);</code>
<code class="p">});</code></pre>
<div class="sect3" id="method_dispatch_id1">
<div class="titlepage"><div><div><h4 class="title">Method Dispatch</h4></div></div></div>
<p id="method_dispatch_id2"><em class="firstterm">Method dispatch</em> is the mechanism that determines what to do when an object receives a message.  JavaScript does this by checking to see if the method exists on the object. If it doesn't, the JavaScript engine checks the prototype object. If the method isn't there, it checks the prototype's prototype, and so on. When it finds a matching method, it calls the method and passes the parameters in.</p>
<p id="dynamic_dispatc_id1"><em class="firstterm">Dynamic dispatch</em> enables polymorphism by selecting the appropriate method to run based on the parameters that get passed into the method at run time. Some languages have special syntax to support dynamic dispatch. In JavaScript, you can check the parameters from within the called method, and call another method in response:</p>
<pre class="programlisting" data-language="js" id="var_methods__"><code class="kd">var</code> <code class="nx">methods</code> <code class="o">=</code> <code class="p">{</code>
    <code class="nx">init</code><code class="o">:</code> <code class="kd">function</code> <code class="p">(</code><code class="nx">args</code><code class="p">)</code> <code class="p">{</code>
      <code class="k">return</code> <code class="s1">'initializing...'</code><code class="p">;</code>
    <code class="p">},</code>
    <code class="nx">hello</code><code class="o">:</code> <code class="kd">function</code> <code class="p">(</code><code class="nx">args</code><code class="p">)</code> <code class="p">{</code>
      <code class="k">return</code> <code class="s1">'Hello, '</code> <code class="o">+</code> <code class="nx">args</code><code class="p">;</code>
    <code class="p">},</code>
    <code class="nx">goodbye</code><code class="o">:</code> <code class="kd">function</code> <code class="p">(</code><code class="nx">args</code><code class="p">)</code> <code class="p">{</code>
      <code class="k">return</code> <code class="s1">'Goodbye, cruel '</code> <code class="o">+</code> <code class="nx">args</code><code class="p">;</code>
    <code class="p">}</code>
  <code class="p">},</code>
  <code class="nx">greet</code> <code class="o">=</code> <code class="kd">function</code> <code class="nx">greet</code><code class="p">(</code><code class="nx">options</code><code class="p">)</code> <code class="p">{</code>
    <code class="kd">var</code> <code class="nx">args</code> <code class="o">=</code> <code class="p">[].</code><code class="nx">slice</code><code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">arguments</code><code class="p">,</code> <code class="mi">0</code><code class="p">),</code>
      <code class="nx">initialized</code> <code class="o">=</code> <code class="kc">false</code><code class="p">,</code>
      <code class="nx">action</code> <code class="o">=</code> <code class="s1">'init'</code><code class="p">;</code> <code class="c1">// init will run by default</code>

    <code class="k">if</code> <code class="p">(</code><code class="k">typeof</code> <code class="nx">options</code> <code class="o">===</code> <code class="s1">'string'</code> <code class="o">&amp;&amp;</code>
        <code class="k">typeof</code> <code class="nx">methods</code><code class="p">[</code><code class="nx">options</code><code class="p">]</code> <code class="o">===</code> <code class="s1">'function'</code><code class="p">)</code> <code class="p">{</code>

      <code class="nx">action</code> <code class="o">=</code> <code class="nx">options</code><code class="p">;</code>
      <code class="nx">args</code><code class="p">.</code><code class="nx">shift</code><code class="p">();</code>
    <code class="p">}</code>

    <code class="k">return</code> <code class="nx">methods</code><code class="p">[</code><code class="nx">action</code><code class="p">](</code><code class="nx">args</code><code class="p">);</code>
  <code class="p">};</code>

<code class="nx">test</code><code class="p">(</code><code class="s1">'Dynamic dispatch'</code><code class="p">,</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
  <code class="kd">var</code> <code class="nx">test1</code> <code class="o">=</code> <code class="nx">greet</code><code class="p">(),</code>
    <code class="nx">test2</code> <code class="o">=</code> <code class="nx">greet</code><code class="p">(</code><code class="s1">'hello'</code><code class="p">,</code> <code class="s1">'world!'</code><code class="p">),</code>
    <code class="nx">test3</code> <code class="o">=</code> <code class="nx">greet</code><code class="p">(</code><code class="s1">'goodbye'</code><code class="p">,</code> <code class="s1">'world!'</code><code class="p">);</code>
  
  <code class="nx">equal</code><code class="p">(</code><code class="nx">test2</code><code class="p">,</code> <code class="s1">'Hello, world!'</code><code class="p">,</code>
    <code class="s1">'Dispatched to hello method.'</code><code class="p">);</code>

  <code class="nx">equal</code><code class="p">(</code><code class="nx">test3</code><code class="p">,</code> <code class="s1">'Goodbye, cruel world!'</code><code class="p">,</code>
    <code class="s1">'Dispatched to goodbye method.'</code><code class="p">);</code>
<code class="p">});</code></pre>
<p id="dynamic_dispatc_id2">Dynamic dispatch is a common technique in chainable modules, such as jQuery plugins (see the section on Method Chaining), and functional programming.</p>
</div>
</div>
<div class="sect2" id="generics_and_collection_polymorphism">
<div class="titlepage"><div><div><h3 class="title">Generics and Collection Polymorphism</h3></div></div></div>
<p id="generic_program_id1"><em class="firstterm">Generic programming</em> is a style that attempts to express algorithms and data structures in a way that is type-agnostic. The idea is that most algorithms can be employed across a variety of different types. Generic programming typically starts with one or more type-specific implementations, which then get <em class="firstterm">lifted</em> (abstracted)  to create a more generic version that will work with a new set of types.</p>
<p id="generics_do_not">Generics do not require conditional logic branching to implement an algorithm differently based on the type of data passed in. Rather, the data types passed in must support the required features that the algorithm needs in order to work. Those features are called <em class="firstterm">requirements</em>, which in turn get collected into sets  called <em class="firstterm">concepts</em>.</p>
<p id="generics_employ">Generics employ <em class="firstterm">parametric polymorphism,</em> which uses a single branch of logic applied to generic type parameters. In contrast,  <em class="firstterm">ad-hoc polymorphism,</em> relies on conditional branching to handle the treatment of different parameter types (either built-in to the language with features like dynamic dispatch, or introduced at program design time).</p>
<p id="generic_program_id2">Generic programming is particularly relevant to functional programming because functional programming works best when a simple function vocabulary can express a wide range of functionality, regardless of type.</p>
<p id="in_most_languag">In most languages, generic programming is concerned with making algorithms work for different types of lists. In JavaScript, any collection (array or object) can contain any type (or mix of types), and most programmers rely on duck typing to accomplish similar goals. That said, stronger typing is coming as an optional feature to JavaScript, and proposals have been introduced to add specific support for generics to the language. Many of the built in object methods are generics, meaning that they can operate on multiple types of objects.</p>
<p id="javascript_supp">JavaScript supports two types of collections: Objects, and arrays. The principle difference between an object and an array is that one is keyed with names, and the other sequentially with numbers. Objects don't guarantee any particular order. Arrays do.  Other than that, both behave pretty much the same. It often makes sense to implement functions that work  regardless of which type of collection gets passed in.</p>
<p id="a_lot_of_the_fu">A lot of the functions you might apply to an array would also work for an object and  vise verse.   For example, say you want to select a random member from an object or array.</p>
<p id="the_easiest_way">The easiest way to select a random element is to use a numbered index, so if the collection is an object, it could be converted to an array using ad-hoc polymorphism. The following function will do that:</p>
<pre class="programlisting" data-language="js" id="var_toarray__f"><code class="kd">var</code> <code class="nx">toArray</code> <code class="o">=</code> <code class="kd">function</code> <code class="nx">toArray</code><code class="p">(</code><code class="nx">obj</code><code class="p">)</code> <code class="p">{</code>
  <code class="kd">var</code> <code class="nx">arr</code> <code class="o">=</code> <code class="p">[],</code>
    <code class="nx">prop</code><code class="p">;</code>

  <code class="k">for</code> <code class="p">(</code><code class="nx">prop</code> <code class="k">in</code> <code class="nx">obj</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">if</code> <code class="p">(</code><code class="nx">obj</code><code class="p">.</code><code class="nx">hasOwnProperty</code><code class="p">(</code><code class="nx">prop</code><code class="p">))</code> <code class="p">{</code>
      <code class="nx">arr</code><code class="p">.</code><code class="nx">push</code><code class="p">(</code><code class="nx">prop</code><code class="p">);</code>
    <code class="p">}</code>
  <code class="p">}</code>
  <code class="k">return</code> <code class="nx">arr</code><code class="p">;</code>
<code class="p">};</code></pre>
<p id="the_randomitem">The <code class="code">randomItem()</code> function is easy now. First, you test the type of collection that gets passed in, and convert it to an array if it's not one already, and then return a random item from the array using the built-in <code class="code">Math.random()</code> method:</p>
<pre class="programlisting" data-language="js" id="var_randomitem_"><code class="kd">var</code> <code class="nx">randomItem</code> <code class="o">=</code> <code class="kd">function</code> <code class="nx">randomItem</code><code class="p">(</code><code class="nx">collection</code><code class="p">)</code> <code class="p">{</code>
  <code class="kd">var</code> <code class="nx">arr</code> <code class="o">=</code> <code class="p">({}.</code><code class="nx">toString</code><code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">collection</code><code class="p">)</code> <code class="o">!==</code> 
    <code class="s1">'[object Array]'</code><code class="p">)</code>
      <code class="o">?</code> <code class="nx">toArray</code><code class="p">(</code><code class="nx">collection</code><code class="p">)</code>
      <code class="o">:</code> <code class="nx">collection</code><code class="p">;</code>
  <code class="k">return</code> <code class="nx">arr</code><code class="p">[</code><code class="nb">Math</code><code class="p">.</code><code class="nx">floor</code><code class="p">(</code><code class="nx">arr</code><code class="p">.</code><code class="nx">length</code> <code class="o">*</code> <code class="nb">Math</code><code class="p">.</code><code class="nx">random</code><code class="p">())];</code>
<code class="p">};</code>

<code class="nx">test</code><code class="p">(</code><code class="s1">'randomItem()'</code><code class="p">,</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
  <code class="kd">var</code> <code class="nx">obj</code> <code class="o">=</code> <code class="p">{</code>
      <code class="nx">a</code><code class="o">:</code> <code class="s1">'a'</code><code class="p">,</code>
      <code class="nx">b</code><code class="o">:</code> <code class="s1">'b'</code><code class="p">,</code>
      <code class="nx">c</code><code class="o">:</code> <code class="s1">'c'</code>
    <code class="p">},</code>
    <code class="nx">arr</code> <code class="o">=</code> <code class="p">[</code><code class="s1">'a'</code><code class="p">,</code> <code class="s1">'b'</code><code class="p">,</code> <code class="s1">'c'</code><code class="p">];</code>

  <code class="nx">ok</code><code class="p">(</code><code class="nx">obj</code><code class="p">.</code><code class="nx">hasOwnProperty</code><code class="p">(</code><code class="nx">randomItem</code><code class="p">(</code><code class="nx">obj</code><code class="p">)),</code>
    <code class="s1">'randomItem works on Objects.'</code><code class="p">);</code>

  <code class="nx">ok</code><code class="p">(</code><code class="nx">obj</code><code class="p">.</code><code class="nx">hasOwnProperty</code><code class="p">(</code><code class="nx">randomItem</code><code class="p">(</code><code class="nx">arr</code><code class="p">)),</code>
    <code class="s1">'randomItem works on Arrays.'</code><code class="p">);</code>
<code class="p">});</code></pre>
<p id="the_tests_above">The tests above  check to see if the returned value exists in the test object.</p>
<p id="unlike_true_gen">Unlike true generics, the code above relies on conditional branching internally to handle objects as a special case. Since arrays are already objects in JavaScript, a lot of what you might do with an object will work for arrays without any conversion. In other words, a lot of functions designed to act on JavaScript objects are truly generic in that they will also work for arrays without any specialized logic (assuming that the array has all of the required features).</p>
<p id="collection_poly">Collection polymorphism is a very useful tool for code reuse and API consistency. Many library methods in both jQuery and Underscore work on both objects and arrays.</p>
<p id="javascript__">JavaScript 1.6 introduced a number of new built-in array and string generics. With 1.6 compatible JavaScript engines, you can use array methods such as <code class="code">.every()</code>  on strings:</p>
<pre class="programlisting" data-language="js" id="var_validstring"><code class="kd">var</code> <code class="nx">validString</code> <code class="o">=</code> <code class="s1">'abc'</code><code class="p">,</code>
  <code class="nx">invalidString</code> <code class="o">=</code> <code class="s1">'abcd'</code><code class="p">,</code>

  <code class="nx">validArray</code> <code class="o">=</code> <code class="p">[</code><code class="s1">'a'</code><code class="p">,</code> <code class="s1">'b'</code><code class="p">,</code> <code class="s1">'c'</code><code class="p">],</code>
  <code class="nx">invalidArray</code> <code class="o">=</code> <code class="p">[</code><code class="s1">'a'</code><code class="p">,</code> <code class="s1">'b'</code><code class="p">,</code> <code class="s1">'c'</code><code class="p">,</code> <code class="s1">'d'</code><code class="p">],</code>

  <code class="nx">isValid</code> <code class="o">=</code> <code class="kd">function</code> <code class="nx">isValid</code><code class="p">(</code><code class="kr">char</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">return</code> <code class="nx">validString</code><code class="p">.</code><code class="nx">indexOf</code><code class="p">(</code><code class="kr">char</code><code class="p">)</code> <code class="o">&gt;=</code> <code class="mi">0</code><code class="p">;</code>
  <code class="p">};</code>

<code class="nx">test</code><code class="p">(</code><code class="s1">'Array String generics'</code><code class="p">,</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
  <code class="nx">ok</code><code class="p">(</code><code class="o">!</code><code class="p">[].</code><code class="nx">every</code><code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">invalidString</code><code class="p">,</code> <code class="nx">isValid</code><code class="p">),</code>
    <code class="s1">'invalidString is rejected.'</code><code class="p">);</code>
  <code class="nx">ok</code><code class="p">([].</code><code class="nx">every</code><code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">validString</code><code class="p">,</code> <code class="nx">isValid</code><code class="p">),</code>
    <code class="s1">'validString passes.'</code><code class="p">);</code>
  <code class="nx">ok</code><code class="p">(</code><code class="o">!</code><code class="p">[].</code><code class="nx">every</code><code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">invalidArray</code><code class="p">,</code> <code class="nx">isValid</code><code class="p">),</code>
    <code class="s1">'invalidArray is rejected.'</code><code class="p">);</code>
  <code class="nx">ok</code><code class="p">([].</code><code class="nx">every</code><code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">validArray</code><code class="p">,</code> <code class="nx">isValid</code><code class="p">),</code>
    <code class="s1">'validArray passes.'</code><code class="p">);</code>
<code class="p">});</code></pre>
<p id="you_can_also_us">You can also use string methods on numbers:</p>
<pre class="programlisting" data-language="js" id="var_num___"><code class="kd">var</code> <code class="nx">num</code> <code class="o">=</code> <code class="mi">303</code><code class="p">;</code>

<code class="nx">test</code><code class="p">(</code><code class="s1">'String number generics'</code><code class="p">,</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
  <code class="kd">var</code> <code class="nx">i</code> <code class="o">=</code> <code class="s1">''</code><code class="p">.</code><code class="nx">indexOf</code><code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">num</code><code class="p">,</code> <code class="mi">0</code><code class="p">);</code>
  <code class="nx">ok</code><code class="p">(</code><code class="nx">i</code> <code class="o">===</code> <code class="mi">1</code><code class="p">,</code>
    <code class="s1">'String methods work on numbers.'</code><code class="p">);</code>
<code class="p">});</code></pre>
</div>
<div class="sect2" id="method_chaining_and_fluent_apis">
<div class="titlepage"><div><div><h3 class="title">Method Chaining and Fluent APIs</h3></div></div></div>
<p id="method_chaining"><em class="firstterm">Method chaining</em> is using the output of one method call as the context of the next method call. For example, in jQuery you often see things like:</p>
<pre class="programlisting" data-language="js" id="friendhi"><code class="nx">$</code><code class="p">(</code><code class="s1">'.friend'</code><code class="p">).</code><code class="nx">hide</code><code class="p">().</code><code class="nx">filter</code><code class="p">(</code><code class="s1">'.active'</code><code class="p">).</code><code class="nx">show</code><code class="p">();</code></pre>
<p id="perhaps_better">Perhaps better:</p>
<pre class="programlisting" data-language="js" id="friend_h"><code class="nx">$</code><code class="p">(</code><code class="s1">'.friend'</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">hide</code><code class="p">()</code>
  <code class="p">.</code><code class="nx">filter</code><code class="p">(</code><code class="s1">'.active'</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">show</code><code class="p">();</code></pre>
<p id="which_translate">Which translates, "find all elements with the <code class="code">friend</code> class and hide them, then find the friends with the <code class="code">active</code> class and show them."</p>
<p id="on_page_load_o">On page load, our friends list looks like this:</p>
<pre class="programlisting" id="mick__hunz_">* Mick
* Hunz (active)
* Yannis</pre>
<p id="after_running_t">After running the code above, it looks like this:</p>
<pre class="programlisting" id="hunz_active">* Hunz (active)</pre>
<p id="one_of_the_prim">One of the primary benefits of method chaining is that it can be used to support fluent APIs. In short, a <em class="firstterm">fluent API</em> is one that reads like natural language. That doesn't mean that it has to look like English, but fluent APIs often use real verbs as method calls (like hide and show). </p>
<p id="jquery_is_a_gre">jQuery is a great example of a fluent API. In fact, jQuery's fluency makes it one of the easiest libraries to learn and use. Almost everything that jQuery does was already available in other libraries when jQuery was first released. What made jQuery stand out was the easy-to-learn vocabulary. Almost every jQuery statement reads something like this:</p>
<p id="find_all_the_el">Find all the elements matching a selector, then do x, then y, then z. Selection, verb, verb...</p>
<p id="chaining_has_it">Chaining has it's disadvantages. It can encourage you to do too much in a single line of code, it can encourage you to write too much procedural code, and it can be difficult to debug. It's tough to set a breakpoint in the middle of a chain.</p>
<p id="if_you_get_into">If you get into a tight spot debugging a chain, remember you can always capture the output at any step in the chain with a variable assignment, and resume the chain by calling the next method on that variable. In fact, you don't have to chain at all to use a fluent API.</p>
<p id="theres_more_to">There's more to  fluency than chaining. The salient point is that fluent methods are made to work together to express functionality  in the same way that words in a language work together to express ideas. That means that they output objects with methods that make sense to call on the resulting data.</p>
<p id="building_a_flue">Building a fluent API is a lot like building a miniature Domain  Specific Language (DSL). We'll go into detail about how to build a fluent API in the next chapter.</p>
<p id="its_easy_to_go_id1"></p>
<div class="warning" id="its_easy_to_go_id2">
<p id="its_easy_to_go_id3">It's easy to go too far with fluent APIs. In other languages, fluent APIs are frequently used to configure a new object. Since JavaScript supports object literal notation, this is almost certainly a bad use of fluency in JavaScript.</p>
<p id="fluency_can_als">Fluency can also lead to unnecessary verbosity. For example, the Should.js API encourages you to write long sentences with strung-together dot notation access. Keep it simple.</p>
</div>
</div>
</div>
<div class="sect1" data-original-filename="ch03.xml" id="functional_programming">
<div class="titlepage"><div><div><h2 class="title">Functional Programming</h2></div></div></div>
<p id="functional_prog">Functional programming is a style of programming that uses <em class="firstterm">higher order functions</em> (as opposed to objects and data) to facilitate code organization and reuse.  A higher order function treats functions as data, either taking a function as an argument, or returning a function as a result. Higher order functions are very powerful code reuse tools which are commonly used in JavaScript for a variety of purposes. Here are a few examples:</p>
<p id="they_can_be_use">They can be used to <span class="emphasis"><em>abstract algorithms from datatypes.</em></span> This is important because it reduces the amount of code you need in order to support various datatypes in your reusable algorithms. Without this, you might create a special function to operate  on a collection of one type, and a similar, but slightly different function to operate on another.  This is a very common problem in most applications.</p>
<div class="tip" id="a_series_of_fun_id1"><p id="a_series_of_fun_id2">A series of functions which do essentially the same thing and differ only in the type  of data they operate on is a serious code smell. You're violating the DRY principle, one of the most valuable guidelines available to you in software design.</p></div>
<p id="for_example_im">For example, imagine you have to sort two lists of items by price, but one is a list of concerts where the price is called <code class="code">ticketPrice</code>, another is a list of books where the price is just <code class="code">price</code>.</p>
<p id="of_course_you__id1">Of course, you could attempt to squeeze both into a single, more generic type and create a generic function that will work with both (using duck typing), but that might require an unjustifiable refactor. </p>
<p id="instead_you_co">Instead, you could  pass in a function to handle the comparison for the sort:</p>
<pre class="programlisting" data-language="js" id="var_shows___"><code class="kd">var</code> <code class="nx">shows</code> <code class="o">=</code> <code class="p">[</code>
    <code class="p">{</code>
      <code class="nx">artist</code><code class="o">:</code> <code class="s1">'Kreap'</code><code class="p">,</code>
      <code class="nx">city</code><code class="o">:</code> <code class="s1">'Melbourne'</code><code class="p">,</code>
      <code class="nx">ticketPrice</code><code class="o">:</code> <code class="s1">'40'</code>
    <code class="p">},</code>
    <code class="p">{</code>
      <code class="nx">artist</code><code class="o">:</code> <code class="s1">'DJ EQ'</code><code class="p">,</code>
      <code class="nx">city</code><code class="o">:</code> <code class="s1">'Paris'</code><code class="p">,</code>
      <code class="nx">ticketPrice</code><code class="o">:</code> <code class="s1">'38'</code>
    <code class="p">},</code>
    <code class="p">{</code>
      <code class="nx">artist</code><code class="o">:</code> <code class="s1">'Treasure Fingers'</code><code class="p">,</code>
      <code class="nx">city</code><code class="o">:</code> <code class="s1">'London'</code><code class="p">,</code>
      <code class="nx">ticketPrice</code><code class="o">:</code> <code class="s1">'60'</code>
    <code class="p">}</code>
  <code class="p">],</code>
  <code class="nx">books</code> <code class="o">=</code> <code class="p">[</code>
    <code class="p">{</code>
      <code class="nx">title</code><code class="o">:</code> <code class="s1">'How to DJ Proper'</code><code class="p">,</code>
      <code class="nx">price</code><code class="o">:</code> <code class="s1">'18'</code>
    <code class="p">},</code>
    <code class="p">{</code>
      <code class="nx">title</code><code class="o">:</code> <code class="s1">'Music Marketing for Dummies'</code><code class="p">,</code>
      <code class="nx">price</code><code class="o">:</code> <code class="s1">'26'</code>
    <code class="p">},</code>
    <code class="p">{</code>
      <code class="nx">title</code><code class="o">:</code> <code class="s1">'Turntablism for Beginners'</code><code class="p">,</code>
      <code class="nx">price</code><code class="o">:</code> <code class="s1">'15'</code>
    <code class="p">}</code>
  <code class="p">];</code>

<code class="nx">test</code><code class="p">(</code><code class="s1">'Datatype abstraction'</code><code class="p">,</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
  <code class="kd">var</code> <code class="nx">sortedShows</code> <code class="o">=</code> <code class="nx">shows</code><code class="p">.</code><code class="nx">sort</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">a</code><code class="p">,</code> <code class="nx">b</code><code class="p">)</code> <code class="p">{</code>
      <code class="k">return</code> <code class="nx">a</code><code class="p">.</code><code class="nx">ticketPrice</code> <code class="o">&lt;</code> <code class="nx">b</code><code class="p">.</code><code class="nx">ticketPrice</code><code class="p">;</code>
    <code class="p">}),</code>
    <code class="nx">sortedBooks</code> <code class="o">=</code> <code class="nx">books</code><code class="p">.</code><code class="nx">sort</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">a</code><code class="p">,</code> <code class="nx">b</code><code class="p">)</code> <code class="p">{</code>
      <code class="k">return</code> <code class="nx">a</code><code class="p">.</code><code class="nx">price</code> <code class="o">&lt;</code> <code class="nx">b</code><code class="p">.</code><code class="nx">price</code><code class="p">;</code>
    <code class="p">});</code>
  <code class="nx">ok</code><code class="p">(</code><code class="nx">sortedShows</code><code class="p">[</code><code class="mi">0</code><code class="p">].</code><code class="nx">ticketPrice</code> <code class="o">&gt;</code>
    <code class="nx">sortedShows</code><code class="p">[</code><code class="mi">2</code><code class="p">].</code><code class="nx">ticketPrice</code><code class="p">,</code>
    <code class="s1">'Shows sorted correctly.'</code><code class="p">);</code>
  <code class="nx">ok</code><code class="p">(</code><code class="nx">sortedBooks</code><code class="p">[</code><code class="mi">0</code><code class="p">].</code><code class="nx">price</code> <code class="o">&gt;</code>
    <code class="nx">sortedBooks</code><code class="p">[</code><code class="mi">1</code><code class="p">].</code><code class="nx">price</code><code class="p">,</code>
    <code class="s1">'Books sorted correctly.'</code><code class="p">);</code>
<code class="p">});</code></pre>
<p id="higher_order_fu_id2">Higher order functions are very commonly used to <span class="emphasis"><em>abstract list iteration boilerplate from algorithm implementation</em></span>. You may have noticed in the previous example that the built-in <code class="code">Array.sort()</code> method handles the iteration details internally, so you don't even have to think about writing a for loop. You frequently see a pattern like this repeated in most code:</p>
<pre class="programlisting" data-language="js" id="testtradition"><code class="nx">test</code><code class="p">(</code><code class="s1">'Traditional for loop'</code><code class="p">,</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
  <code class="kd">var</code> <code class="nx">i</code><code class="p">,</code>
    <code class="nx">length</code> <code class="o">=</code> <code class="nx">books</code><code class="p">.</code><code class="nx">length</code><code class="p">;</code>

  <code class="k">for</code> <code class="p">(</code><code class="nx">i</code> <code class="o">=</code> <code class="mi">0</code><code class="p">;</code> <code class="nx">i</code> <code class="o">&lt;</code> <code class="nx">length</code><code class="p">;</code> <code class="nx">i</code><code class="o">++</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">books</code><code class="p">[</code><code class="nx">i</code><code class="p">].</code><code class="nx">category</code> <code class="o">=</code> <code class="s1">'music'</code><code class="p">;</code>
  <code class="p">}</code>

  <code class="nx">ok</code><code class="p">(</code><code class="nx">books</code><code class="p">[</code><code class="mi">0</code><code class="p">].</code><code class="nx">category</code> <code class="o">===</code> <code class="s1">'music'</code><code class="p">,</code>
    <code class="s1">'Books have categories.'</code><code class="p">);</code>
<code class="p">});</code></pre>
<p id="there_are_sever_id2">There are several functional methods available whose sole purpose is to iterate through a collection in order to process it with a passed in function of your choice. The most basic of the Array iterators is <code class="code">.forEach()</code>. For example, imagine you want to add a category field  to each of the book items. Using <code class="code">.forEach()</code>, you don't have to worry about writing the loop, or keeping track of the iteration index. You simply write the function that you'll use to process the list:</p>
<pre class="programlisting" data-language="js" id="testiterator_"><code class="nx">test</code><code class="p">(</code><code class="s1">'Iterator abstraction'</code><code class="p">,</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
  <code class="nx">books</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">book</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">book</code><code class="p">.</code><code class="nx">category</code> <code class="o">=</code> <code class="s1">'music'</code><code class="p">;</code>
  <code class="p">});</code>

  <code class="nx">ok</code><code class="p">(</code><code class="nx">books</code><code class="p">[</code><code class="mi">0</code><code class="p">].</code><code class="nx">category</code> <code class="o">===</code> <code class="s1">'music'</code><code class="p">,</code>
    <code class="s1">'Books have categories.'</code><code class="p">);</code>
<code class="p">});</code></pre>
<p id="another_common_">Another common use of higher order functions is to support <span class="emphasis"><em>partial application and currying</em></span> (discussed in the section of the same name).</p>
<div class="sect2" id="stateless_functions_aka_pure_functions">
<div class="titlepage"><div><div><h3 class="title">Stateless Functions (aka Pure Functions)</h3></div></div></div>
<p id="pure_functions_"><span class="emphasis"><em>Pure</em></span> functions are stateless. This means that they do not use or modify variables, objects, or arrays that were defined outside the function. Given the same inputs, stateless functions will always return the same output. Stateless functions won't break if you call them at different times.</p>
<p id="that_feature_is">That feature is particularly useful in JavaScript applications,  because you often need to manage  a lot of asynchronous events, so time becomes a major factor in code organization.</p>
<p id="because_you_don">Because you don't have to worry about clobbering shared data, stateless functions can often be run in parallel, meaning that it's much easier to scale computation horizontally across a large number worker nodes. In other words, stateless functions are great for high-concurrency applications.</p>
<p id="stateless_funct_id1">Stateless functions can be chained together for stream processing. (Enumerator, processor, [processor], [processor], ...., collector).</p>
<p id="stateless_funct_id2">Stateless functions can be abstracted and shared as context-agnostic modules.</p>
<div class="tip" id="to_maximize_cod_id1"><p id="to_maximize_cod_id2">To maximize code reuse, try to make as many functions as possible both stateless and generic (or polymorphic). Many jQuery methods satisfy both requirements. Such functions tend to be very useful library methods.</p></div>
</div>
<div class="sect2" id="partial_application_and_currying">
<div class="titlepage"><div><div><h3 class="title">Partial Application and Currying</h3></div></div></div>
<p id="partial_applica"><em class="firstterm">Partial Application</em> wraps a function that takes multiple arguments, and returns a function that takes fewer arguments. It uses closures to <em class="firstterm">fix</em> one or more arguments so that you only need to supply the arguments that are unknown. Imagine you have a function multiply() which takes two arguments, x and y, and you notice that you often call the function to multiply by specific numbers. You could create a generic function that will fix one parameter:</p>
<pre class="programlisting" data-language="js" id="var_multiply__"><code class="kd">var</code> <code class="nx">multiply</code> <code class="o">=</code> <code class="kd">function</code> <code class="nx">multiply</code><code class="p">(</code><code class="nx">x</code><code class="p">,</code> <code class="nx">y</code><code class="p">)</code> <code class="p">{</code>
    <code class="k">return</code> <code class="nx">x</code> <code class="o">*</code> <code class="nx">y</code><code class="p">;</code>
  <code class="p">},</code>

  <code class="nx">partial</code> <code class="o">=</code> <code class="kd">function</code> <code class="nx">partial</code><code class="p">(</code><code class="nx">fn</code><code class="p">)</code> <code class="p">{</code>
    <code class="c1">// Drop the function from the arguments list and</code>
    <code class="c1">// fix arguments in the closure.</code>
    <code class="kd">var</code> <code class="nx">args</code> <code class="o">=</code> <code class="p">[].</code><code class="nx">slice</code><code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">arguments</code><code class="p">,</code> <code class="mi">1</code><code class="p">);</code>

    <code class="c1">// Return a new function with fixed arguments.</code>
    <code class="k">return</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
      <code class="c1">// Combine fixed arguments with new arguments</code>
      <code class="c1">// and call fn with them.</code>
      <code class="kd">var</code> <code class="nx">combinedArgs</code> <code class="o">=</code> <code class="nx">args</code><code class="p">.</code><code class="nx">concat</code><code class="p">(</code>
        <code class="p">[].</code><code class="nx">slice</code><code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">arguments</code><code class="p">));</code>
      <code class="k">return</code> <code class="nx">fn</code><code class="p">.</code><code class="nx">apply</code><code class="p">(</code><code class="k">this</code><code class="p">,</code> <code class="nx">combinedArgs</code><code class="p">);</code>
    <code class="p">};</code>
  <code class="p">},</code>

  <code class="kr">double</code> <code class="o">=</code> <code class="nx">partial</code><code class="p">(</code><code class="nx">multiply</code><code class="p">,</code> <code class="mi">2</code><code class="p">);</code>

<code class="nx">test</code><code class="p">(</code><code class="s1">'Partial application'</code><code class="p">,</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
  <code class="nx">equal</code><code class="p">(</code><code class="kr">double</code><code class="p">(</code><code class="mi">4</code><code class="p">),</code> <code class="mi">8</code><code class="p">,</code>
    <code class="s1">'partial() works.'</code><code class="p">);</code>
<code class="p">});</code></pre>
<p id="as_of_javascrip">As of JavaScript 1.8.5, you can also use <code class="code">Function.prototype.bind()</code> for partial application. The only disadvantage is that you won't be able to override the value of <code class="code">this</code> with <code class="code">.call()</code> or <code class="code">.apply()</code>. If your function uses <code class="code">this</code>, you shouldn't use <code class="code">.bind()</code>. This is how you use <code class="code">.bind()</code> for partial application, using the same multiply function:</p>
<pre class="programlisting" data-language="js" id="var_bounddouble"><code class="kd">var</code> <code class="nx">boundDouble</code> <code class="o">=</code> <code class="nx">multiply</code><code class="p">.</code><code class="nx">bind</code><code class="p">(</code><code class="kc">null</code><code class="p">,</code> <code class="mi">2</code><code class="p">);</code> <code class="c1">// null context</code>

<code class="nx">test</code><code class="p">(</code><code class="s1">'Partial application with bind'</code><code class="p">,</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
  <code class="nx">equal</code><code class="p">(</code><code class="nx">boundDouble</code><code class="p">(</code><code class="mi">4</code><code class="p">),</code> <code class="mi">8</code><code class="p">,</code>
      <code class="s1">'.bind() should allow partial application.'</code><code class="p">);</code>
<code class="p">});</code></pre>
<p id="you_may_have_he">You may have heard this process described as <em class="firstterm">currying</em>. The two are commonly confused, but there is a difference. Currying is the process of transforming a function which takes multiple arguments into a chain of functions which take no more than one argument, each.</p>
<p id="an_add_function">An add function, <code class="code">add(1, 2, 3)</code> would become <code class="code">add(1)(2)(3)</code> in curried form, where the first call returns a function that returns another function, and so on. This concept  is important in lambda calculus (the inspiration for the lisp family of languages, from which JavaScript borrows heavily). However, since JavaScript supports multiple arguments, it's not common to see true currying in JavaScript applications.</p>
</div>
</div>
<div class="sect1" data-original-filename="ch03.xml" id="asynchronous_operations">
<div class="titlepage"><div><div><h2 class="title">Asynchronous Operations</h2></div></div></div>
<p id="asynchronous_op_id1"><em class="firstterm">Asynchronous operations</em> are operations that happen outside the linear flow of program execution. Normally, the JavaScript engine will execute code line by line, in order from top to bottom, following the normal flow of your program (such as function calls, conditional logic, etc...).</p>
<p id="asynchronous_op_id2">Asynchronous operations are broken up into two phases: call and response. By definition, it's impossible to know at what point in the program flow you'll be when you receive an asynchronous response. There are a couple of popular ways to manage that uncertainty.</p>
<div class="sect2" id="callbacks">
<div class="titlepage"><div><div><h3 class="title">Callbacks</h3></div></div></div>
<p id="callbacks_are_f"><em class="firstterm">Callbacks</em>  are functions that you pass as arguments to be invoked when the callee has finished its job. Callbacks are commonly passed into event handlers, Ajax requests, and timers. You should already be familiar with passing callbacks to event listeners and timers:</p>
<pre class="programlisting" data-language="js" id="var_button__"><code class="kd">var</code> <code class="nx">$button</code> <code class="o">=</code> <code class="nx">$</code><code class="p">(</code><code class="s1">'&lt;button class="select"&gt;Click&lt;/button&gt;'</code><code class="p">)</code>
  <code class="p">.</code><code class="nx">appendTo</code><code class="p">(</code><code class="s1">'body'</code><code class="p">);</code>


<code class="nx">asyncTest</code><code class="p">(</code><code class="s1">'Async callback event listener.'</code><code class="p">,</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
  <code class="nx">$button</code><code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s1">'click'</code><code class="p">,</code> <code class="kd">function</code> <code class="nx">clicked</code><code class="p">()</code> <code class="p">{</code>
    <code class="nx">ok</code><code class="p">(</code><code class="kc">true</code><code class="p">,</code> <code class="s1">'Button clicked.'</code><code class="p">);</code>
    <code class="nx">start</code><code class="p">();</code>
  <code class="p">});</code>

  <code class="nx">setTimeout</code><code class="p">(</code><code class="kd">function</code> <code class="nx">timedOut</code><code class="p">()</code> <code class="p">{</code>
    <code class="nx">$button</code><code class="p">.</code><code class="nx">click</code><code class="p">();</code>
    <code class="nx">$button</code><code class="p">.</code><code class="nx">remove</code><code class="p">();</code>
  <code class="p">},</code> <code class="mi">20</code><code class="p">);</code>
<code class="p">});</code></pre>
<p id="in_the_above_co">In the above code, the   <code class="code">clicked()</code> callback gets passed into into jQuery's <code class="code">.on()</code> method. When <code class="code">$button</code> receives a <code class="code">click</code> event, it invokes <code class="code">clicked()</code> which runs the <code class="code">ok()</code> assertion and then <code class="code">start()</code>, which tells QUnit that it's finished waiting for asynchronous operations, so it can continue to run tests.</p>
<p id="next_the_timed">Next, the <code class="code">timedOut()</code> callback is passed into <code class="code">setTimeout()</code>, which triggers the <code class="code">click</code> event on <code class="code">$button</code> and removes the button from the DOM.</p>
<p id="callbacks_work_">Callbacks work great when you're only waiting for one operation at a time, or when you only have one job to do when the response comes back, but what if you need to manage multiple asynchronous dependencies, or you have several unrelated tasks waiting on the same data (such as a provider authorization)? That's where promises can be very useful.</p>
</div>
<div class="sect2" id="promises_and_deferreds">
<div class="titlepage"><div><div><h3 class="title">Promises and Deferreds</h3></div></div></div>
<p id="promises_are_ob"><em class="firstterm">Promises</em> are objects that allow you to add callback functions to success or failure queues. Instead of calling a callback function in response to the completion of an asynchronous (or synchronous) operation, you return a promise which allows you to register any number of callbacks.</p>
<p id="the_promise_pro">The promise provides access to the state of the operation: whether it's waiting or finished, and in some cases, what the progress is.  You can add callbacks to a promise at any time, which will trigger after the operation is complete and the promise is resolved. If the promise has already resolved, the callback will be invoked immediately.</p>
<p id="promises_were_p">Promises were popularized in JavaScript by jQuery, inspired by the CommonJS Promises/A design.  jQuery  uses them internally to manage asynchronous operations, such as Ajax. In fact, as of jQuery 1.5, all jQuery Ajax methods return a promise. Here's how they work:</p>
<pre class="programlisting" data-language="js" id="var_whendatafet"><code class="kd">var</code> <code class="nx">whenDataFetched</code> <code class="o">=</code> <code class="nx">$</code><code class="p">.</code><code class="nx">getJSON</code><code class="p">(</code>
  <code class="s1">'https://graph.facebook.com/jsapplications'</code>
<code class="p">);</code>

<code class="nx">asyncTest</code><code class="p">(</code><code class="s1">'Ajax promise API'</code><code class="p">,</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
  <code class="nx">whenDataFetched</code>
    <code class="p">.</code><code class="nx">done</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">response</code><code class="p">)</code> <code class="p">{</code>
      <code class="nx">ok</code><code class="p">(</code><code class="nx">response</code><code class="p">,</code>
        <code class="s1">'The server returned data.'</code><code class="p">);</code>
      <code class="nx">start</code><code class="p">();</code>
    <code class="p">})</code>
    <code class="p">.</code><code class="nx">fail</code><code class="p">(</code><code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
      <code class="nx">ok</code><code class="p">(</code><code class="kc">true</code><code class="p">,</code>
        <code class="s1">'There was an error.'</code><code class="p">);</code>
      <code class="nx">start</code><code class="p">();</code>
    <code class="p">});</code>
<code class="p">});</code></pre>
<p id="the_example_abo">The example above demonstrates an Ajax request to get the page metadata for the "Programming JavaScript Applications" page. Since all of jQuery's Ajax helper functions return a promise, you can add a success callback with <code class="code">whenDataFetched.done()</code>.</p>
<p id="the_difference_">The difference between a promise and a callback is that a promise is an object that gets returned from the callee, instead of a function that gets passed into  and invoked by the callee. With promises, it's much easier to add additional callbacks if you need them, and to isolate those callbacks from each other so that the callback code can be organized independently of the initiating call.</p>
<p id="a_deferred_is_t">A <em class="firstterm">deferred</em> is the object that controls the promise, with a few extra methods. jQuery's <code class="code">.Deferred()</code> returns a new object that does everything a promise does, but also provides <code class="code">.resolve()</code> and <code class="code">.reject()</code> methods that trigger the corresponding callbacks. For example, say you want to make <code class="code">setTimeout()</code> a little more flexible, so that you can add callbacks to it at any time, and break the need to attach a callback at the timer start time. You could implement it like this:</p>
<pre class="programlisting" data-language="js" id="var_timer__fun"><code class="kd">var</code> <code class="nx">timer</code> <code class="o">=</code> <code class="kd">function</code> <code class="nx">timer</code><code class="p">(</code><code class="nx">delay</code><code class="p">)</code> <code class="p">{</code>
  <code class="kd">var</code> <code class="nx">whenTimedOut</code> <code class="o">=</code> <code class="nx">$</code><code class="p">.</code><code class="nx">Deferred</code><code class="p">(),</code>
    <code class="nx">promise</code> <code class="o">=</code> <code class="nx">whenTimedOut</code><code class="p">.</code><code class="nx">promise</code><code class="p">();</code>

  <code class="nx">promise</code><code class="p">.</code><code class="nx">cancel</code> <code class="o">=</code> <code class="kd">function</code> <code class="p">(</code><code class="nx">payload</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">whenTimedOut</code><code class="p">.</code><code class="nx">reject</code><code class="p">(</code><code class="nx">payload</code><code class="p">);</code>
  <code class="p">};</code>

  <code class="nx">setTimeout</code><code class="p">(</code><code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
    <code class="nx">whenTimedOut</code><code class="p">.</code><code class="nx">resolve</code><code class="p">();</code>
  <code class="p">},</code> <code class="nx">delay</code><code class="p">);</code>

  <code class="k">return</code> <code class="nx">promise</code><code class="p">;</code>
<code class="p">};</code>

<code class="nx">asyncTest</code><code class="p">(</code><code class="s1">'Deferred'</code><code class="p">,</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
  <code class="kd">var</code> <code class="nx">startTime</code> <code class="o">=</code> <code class="k">new</code> <code class="nb">Date</code><code class="p">(),</code>
    <code class="nx">delay</code> <code class="o">=</code> <code class="mi">30</code><code class="p">,</code>
    <code class="nx">afterTimeout</code> <code class="o">=</code> <code class="mi">50</code><code class="p">,</code>
    <code class="nx">cancelTime</code> <code class="o">=</code> <code class="mi">100</code><code class="p">,</code>
    <code class="nx">myTimer</code> <code class="o">=</code> <code class="nx">timer</code><code class="p">(</code><code class="nx">delay</code><code class="p">),</code>
    <code class="nx">cancelTimer</code> <code class="o">=</code> <code class="nx">timer</code><code class="p">(</code><code class="nx">cancelTime</code><code class="p">);</code>

  <code class="nx">expect</code><code class="p">(</code><code class="mi">4</code><code class="p">);</code>

  <code class="nx">myTimer</code><code class="p">.</code><code class="nx">done</code><code class="p">(</code><code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
    <code class="nx">ok</code><code class="p">(</code><code class="kc">true</code><code class="p">,</code>
      <code class="s1">'First callback fired.'</code><code class="p">);</code>
  <code class="p">});</code>

  <code class="nx">myTimer</code><code class="p">.</code><code class="nx">done</code><code class="p">(</code><code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
    <code class="kd">var</code> <code class="nx">now</code> <code class="o">=</code> <code class="k">new</code> <code class="nb">Date</code><code class="p">();</code>
    <code class="nx">ok</code><code class="p">((</code><code class="nx">now</code> <code class="o">-</code> <code class="nx">startTime</code><code class="p">)</code> <code class="o">&gt;</code> <code class="nx">delay</code><code class="p">,</code>
      <code class="s1">'Delay works.'</code>
      <code class="p">);</code>
  <code class="p">});</code>

  <code class="nx">setTimeout</code><code class="p">(</code><code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
    <code class="nx">ok</code><code class="p">(</code><code class="kc">true</code><code class="p">,</code>
      <code class="s1">'Fires after timeout expires.'</code><code class="p">);</code>
  <code class="p">},</code> <code class="nx">afterTimeout</code><code class="p">);</code>

  <code class="nx">setTimeout</code><code class="p">(</code><code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
    <code class="nx">start</code><code class="p">();</code>
  <code class="p">},</code> <code class="nx">afterTimeout</code> <code class="o">+</code> <code class="mi">20</code><code class="p">);</code>

  <code class="nx">cancelTimer</code>
    <code class="p">.</code><code class="nx">done</code><code class="p">(</code><code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
      <code class="nx">ok</code><code class="p">(</code><code class="kc">false</code><code class="p">,</code>
        <code class="s1">'A canceled timer should NOT run .done().'</code><code class="p">);</code>
    <code class="p">})</code>
    <code class="p">.</code><code class="nx">fail</code><code class="p">(</code><code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
      <code class="nx">ok</code><code class="p">(</code><code class="kc">true</code><code class="p">,</code>
        <code class="s1">'A canceled timer calls .fail().'</code><code class="p">);</code>
    <code class="p">})</code>
    <code class="p">.</code><code class="nx">cancel</code><code class="p">();</code>
<code class="p">});</code></pre>
<p id="promises_really">Promises really shine when you need to  orchestrate a complex sequence of events.  It's sometimes necessary to gather data from multiple sources prior to getting data from yet another source.</p>
<p id="with_callbacks">With callbacks, that can be complicated. With promises, it's easy to wait for any number of promises to resolve before moving on to the next step. Using the <code class="code">timer()</code> function defined above:</p>
<pre class="programlisting" data-language="js" id="var_a__timer"><code class="kd">var</code> <code class="nx">a</code> <code class="o">=</code> <code class="nx">timer</code><code class="p">(</code><code class="mi">60</code><code class="p">),</code>
  <code class="nx">b</code> <code class="o">=</code> <code class="nx">timer</code><code class="p">(</code><code class="mi">70</code><code class="p">),</code>
  <code class="nx">c</code> <code class="o">=</code> <code class="nx">timer</code><code class="p">(</code><code class="mi">40</code><code class="p">),</code>
  <code class="nx">tasks</code> <code class="o">=</code> <code class="p">[</code><code class="nx">a</code><code class="p">,</code> <code class="nx">b</code><code class="p">,</code> <code class="nx">c</code><code class="p">];</code>

<code class="nx">asyncTest</code><code class="p">(</code><code class="s1">'Multiple dependencies.'</code><code class="p">,</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
  <code class="nx">$</code><code class="p">.</code><code class="nx">when</code><code class="p">(</code><code class="nx">a</code><code class="p">,</code> <code class="nx">b</code><code class="p">,</code> <code class="nx">c</code><code class="p">).</code><code class="nx">done</code><code class="p">(</code><code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
    <code class="nx">ok</code><code class="p">(</code><code class="kc">true</code><code class="p">,</code> <code class="s1">'Runs when all promises resolve'</code><code class="p">);</code>
    <code class="nx">start</code><code class="p">();</code>
  <code class="p">});</code>
<code class="p">});</code></pre>
</div>
</div></section><footer><div class="navfooter">
<hr>
<table style="width: 100%; ">
<tr>
<td style="width: 40%; text-align: left; ">
<a accesskey="p" href="ch02.html">Prev</a> </td>
<td style="width: 20%; text-align: center; "> </td>
<td style="width: 40%; text-align: right; "> <a accesskey="n" href="ch04.html">Next</a>
</td>
</tr>
<tr>
<td style="width: 40%; text-align: left; vertical-align: top; ">Chapter 2. JavaScript Style Guide </td>
<td style="width: 20%; text-align: center; "><a accesskey="h" href="index.html">Home</a></td>
<td style="width: 40%; text-align: right; vertical-align: top; "> Chapter 4. Objects</td>
</tr>
</table>
</div></footer>


	<div class="extra-footer">
		<p>© 2013, O’Reilly Media, Inc.</p>
		<ul>
			<li><a href="http://oreilly.com/terms/">Terms of Service</a></li>
			<li><a href="http://oreilly.com/oreilly/privacy.csp">Privacy Policy</a></li>
			<li>Interested in <a href="mailto:scordesse@oreilly.com">sponsoring content?</a></li>
		</ul>
	</div>
<script type="text/javascript">if (!NREUMQ.f) { NREUMQ.f=function() {
NREUMQ.push(["load",new Date().getTime()]);
var e=document.createElement("script");
e.type="text/javascript";
e.src=(("http:"===document.location.protocol)?"http:":"https:") + "//" +
  "rpm-images.newrelic.com/42/eum/rum.js";
document.body.appendChild(e);
if(NREUMQ.a)NREUMQ.a();
};
NREUMQ.a=window.onload;window.onload=NREUMQ.f;
};
NREUMQ.push(["nrfj","beacon-3.newrelic.com","3e361aebcf","2194180","IApbRUBZXg1WEEoHDAwORh5aQl8N",20,76,new Date().getTime(),"","","","",""]);</script></body>
</html>