<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head><script type="text/javascript">var NREUMQ=NREUMQ||[];NREUMQ.push(["mark","firstbyte",new Date().getTime()]);</script>
	<title>Programming JavaScript Applications</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link href="http://dwn0odqttrkhc.cloudfront.net/assets/book-748da559db3e7bc457e1e4da3b2fa1e9.css" media="screen" rel="stylesheet" type="text/css" />
	<link href="http://dwn0odqttrkhc.cloudfront.net/assets/default-6b113e470a1a8ec83000e32a1548bc3a.css" media="screen" rel="stylesheet" type="text/css" />
	<script src="http://dwn0odqttrkhc.cloudfront.net/assets/application-984298d79dbc8412cdf579684d9338f6.js" type="text/javascript"></script>
	<script src="http://dwn0odqttrkhc.cloudfront.net/assets/book-756862b9ed04d945ca53de5b8f106a83.js" type="text/javascript"></script>
	<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
	<link href="http://dwn0odqttrkhc.cloudfront.net/assets/janrain-53eb5abed55992e21943b9d3373923e8.css" media="all" rel="stylesheet" type="text/css" />
	<meta content="authenticity_token" name="csrf-param" />
<meta content="g+KL75JTIVlk4jUmbA+m6f1h6WB52h1kRW6wdh1KkmU=" name="csrf-token" />
	<script type="text/javascript" charset="utf-8">
  	
		app.data = new classes.Data({"controller":{"controller":"books","action":"html"},"capturable":{"capture_server":"https://oreilly.janraincapture.com","client_id":"6n5q2k9vesqgn93k3mhevka6c3c3rsre","app_url":"https://login.oreilly.com","app_id":"xsnca5wmqe9vxv97ygh5vfejkd","load_js":"d16s8pqtk4uodx.cloudfront.net/login.oreilly.com/load.js"},"user":{"id":null,"account":"LoggedOutAccount","email":"","name":null,"gravatar_url":"http://www.gravatar.com/avatar/d41d8cd98f00b204e9800998ecf8427e?s=40&d=identicon"},"book":{"isbn":"1234000000262","chapter":"ch06.html","toc_url":"/books/1234000000262/toc_html","metadata_url":"http://d4bb7yl96lyl1.cloudfront.net/1234000000262/metadata/metadata_c6a0e8997c9604111d0171fb2d72f5c1b6cfd618.json"},"abilities":{"can_destroy_all_comments":false,"can_create_comments":false},"advertisement":{"body":"<style>      \r\n.ad-profile-image {\r\n  padding: 0;\r\n  margin: 0;\r\n  max-height: 30px;\r\n }\r\n\r\n.top-banner {\r\n  position: absolute;\r\n  right: 0;\r\n  top: 34px;\r\n  z-index: 99999;\r\n}\r\n\r\np.banner-text {\r\n  margin: 0;\r\n  text-align: center;\r\n  padding-right: 10px;\r\n  width: 500px;\r\n}\r\n\r\n@media screen and (max-width: 600px) {\r\n   p.banner-text {\r\n     width: 100%;\r\n     text-align: center;\r\n  }\r\n}\r\n\r\nspan.ebook-advantage {\r\n  font-size: smaller;\r\n  display: block;\r\n}\r\n\r\ndiv.banner-container {\r\n  margin: 0 auto;\r\n}\r\n\r\ndiv.banner-container ul {\r\n  margin: 0 auto;\r\n}\r\n\r\ndiv.topad { padding-bottom: 5px; }\r\n\r\ndiv.banner-container ul li {\r\n  display: inline-block;\r\n  vertical-align: middle;\r\n}\r\n\r\ndiv.banner-container li p {\r\n  padding-top: 0;\r\n  margin-top: 0;\r\n}\r\n\r\ndiv.banner-container li.sponsor {\r\n  border-right: 1px solid rgb(125, 154, 180);\r\n  margin-right: 5px;\r\n  padding-right: 10px;\r\n}\r\n\r\ndiv.banner-container .webbutton {\r\n  background-color: #3994b6;\r\n  display: inline-block;\r\n  padding: 10px;\r\n  -webkit-border-radius: 5px;\r\n  -moz-border-radius: 5px;\r\n  border-radius: 5px;\r\n  color: #FFF;\r\n  text-align: center;\r\n  text-decoration: none;\r\n  font-size: 12px;\r\n  font-weight: bold;\r\n}\r\n\r\n</style>\r\n   \r\n<div style=\"color: rgb(125, 154, 180);\">\r\n\r\n<div class=\"banner-container\">\r\n\r\n<ul>\r\n\r\n<li class=\"sponsor\">\r\n<!--CONFERENCE SPONSOR IMAGE-->\r\n<a href=\"http://velocityconf.com/\">\r\n<img src=\"http://orm-other.s3.amazonaws.com/velocity_logo.png\" class=\"ad-profile-image\"/>\r\n<!-- <img src=\"http://orm-other.s3.amazonaws.com/fluent_logo.png\" class=\"ad-profile-image\"/>\r\n<img src=\"http://orm-other.s3.amazonaws.com/oscon_logo.png\" class=\"ad-profile-image\"/>\r\n<img src=\"http://orm-other.s3.amazonaws.com/strata_logo.png\" class=\"ad-profile-image\"/>\r\n<img src=\"http://orm-other.s3.amazonaws.com/StrataRx_logo.png\" class=\"ad-profile-image\"/>\r\n<img src=\"http://orm-other.s3.amazonaws.com/velocity_logo.png\" class=\"ad-profile-image\"/> -->\r\n</a>\r\n</li>\r\n\r\n<li>\r\n<!--AD TEXT, 2 LINES, REPLACE LINK URL AS WELL-->\r\n<p class=\"banner-text\">Enjoy this free Early Release version of <em>Programming JavaScript Applications</em>. Purchase and download the DRM-free ebook on <a href=\"http://shop.oreilly.com/product/0636920024231.do?intcmp=il-npa-books-video-product_chimera\">oreilly.com</a>.<span class=\"ebook-advantage\">Learn more about the O’Reilly <a href=\"http://shop.oreilly.com/category/ebooks.do\">Ebook Advantage</a>.</span></p>\r\n</li>\r\n\r\n<li>\r\n<!--BUY BUTTON-->\r\n<a class=\"webbutton\" href=\"http://shop.oreilly.com/product/0636920024231.do?intcmp=il-npa-books-video-product_chimera\">Buy the Ebook</a>\r\n</li> \r\n\r\n</ul>\r\n\r\n</div>\r\n\r\n<!--CORNER BANNER (IF NEEDED)-->\r\n<!--<a href=\"http://shop.oreilly.com/product/0636920025245.do\" class=\"top-banner\"><img src=\"http://orm-other.s3.amazonaws.com/banner.png\" /></a>-->\r\n\r\n</div>"}});

		/* Janrain setup */
  	var janrainModal = new JanrainView();
  	$("head").append(janrainModal.render().el);

  	/* segment.io setup */
  	var analytics=analytics||[];analytics.load=function(e){var t=document.createElement("script");t.type="text/javascript",t.async=!0,t.src=("https:"===document.location.protocol?"https://":"http://")+"d2dq2ahtl5zl1z.cloudfront.net/analytics.js/v1/"+e+"/analytics.min.js";var n=document.getElementsByTagName("script")[0];n.parentNode.insertBefore(t,n);var r=function(e){return function(){analytics.push([e].concat(Array.prototype.slice.call(arguments,0)))}},i=["identify","track","trackLink","trackForm","trackClick","trackSubmit","pageview","ab","alias","ready"];for(var s=0;s<i.length;s++)analytics[i[s]]=r(i[s])};
  	
  	analytics.load("hg9h6b9pae");

  	$(function() {
			app.bookapp = new BookApp();
		});
	
	</script>
</head>
<body>
	<div id="menu">
	
		<ul id="menu-left">
			<li id="home-link"><a href="/"><i class="icon-house"></i></a></li>
			<li><a href="/books/1234000000262">Programming JavaScript Applications</a></li>
			<div class="clear"></div>
		</ul>
	
		<ul id="menu-right">
			<li id="comments-link"><a>&nbsp;</a></li>
			<li>
				<a href="#" class="dropdown-toggle" data-toggle="dropdown">Chapters</a>
				<div id="toc-popup" class="dropdown-menu"></div>
			</li>
				<li><a href="#" class="capture_modal_open" id="capture_signin_link">Log In / Sign Up</a></li>
			<li id="search-li">
				<form accept-charset="UTF-8" action="/searches" id="search-form" method="get"><div style="margin:0;padding:0;display:inline"><input name="utf8" type="hidden" value="&#x2713;" /></div>
	<input name='search[q]' type="text" placeholder="Search book..." id="book-search" />

	<input id="search_bookId" name="search[bookId]" type="hidden" value="1234000000262" />
	
	<div style='display:none'>
		sorted by: 
		<select name='search[sort]' >
			<option value='relevance'>Relevance</option>
			<option value='authors'>Author(s)</option>
			<option value='title'>Title</option>
		</select>
		returning
		<select name='search[limit]' >
			<option value='5'>5</option>
			<option value='10'>10</option>
			<option value='20'>20</option>
			<option selected="selected" value='50'>50</option>
			<option value='100'>100</option>
		</select>
		values at a time.
	</div>
</form>
			</li>
			<div class="clear"></div>
		</ul>
		<div class="clear"></div>
	
</div>
	<header><div class="navheader">
<table style="width: 100%; ">
<tr><td style="text-align: center; " colspan="3">Chapter 6. Separation of Concerns</td></tr>
<tr>
<td style="width: 20%; text-align: left; ">
<a accesskey="p" href="ch05.html">Prev</a> </td>
<td style="width: 60%; text-align: center; "> </td>
<td style="width: 20%; text-align: right; "> </td>
</tr>
</table>
<hr>
</div></header><section class="chapter" data-original-filename="ch06.xml" id="ch9nklpbt00005ig111ud5yao"><div class="titlepage"><div><div><h1 class="title">Chapter 6. Separation of Concerns</h1></div></div></div>
<p id="separation_of_c_id2"><em class="firstterm">Separation of concerns</em> is the idea that each module or layer in an application should only be responsible for one thing, and should not contain code that deals with other things. Separating concerns reduces code complexity by breaking a large application down into many smaller units of encapsulated functionality.</p>
<p id="its_easy_to_co">It's easy to confuse separation of concerns with employing modules for the construction of your application, but separation of concerns also implies the layering of functionality in your application. For example, n-tier architecture and MVC architectures are the result of separating concerns across the entire application, rather than at the individual module level. The goal of MVC and related patterns is to separate data management and presentation.</p>
<p id="separation_of_c_id3">Separation of concerns can be expressed as functions, modules, controls, widgets,  layers, tiers, services, and so on. The various units of concern vary from one app to the next, and each different app may use a different combination. Functions and modules have already been discussed.</p>
<p id="a_control_is_a_">A <em class="firstterm">control</em> is a reusable GUI input that enables user interaction with your application. For example, combo boxes, calendar inputs, sliders, buttons, switches, and knobs are all controls.</p>
<p id="a_widget_is_a_s">A <em class="firstterm">widget</em> is a small application which is intended to be embedded in other applications. For example, <a class="ulink" href="http://wordpress.org/" target="_top">WordPress</a> allows developers to offer embeddable units of functionality to blog owners through its plugin ecosystem. There are many widgets to manage calendars, comments, maps, and all sorts of services from third party providers.</p>
<div class="tip" id="the_word_widget_id1"><p id="the_word_widget_id2">The word widget is historically used to mean the same thing as controls. To avoid confusion, this book will always refer to interactive form inputs  as controls (or inputs), and widgets will always refer to embeddable mini applications.</p></div>
<p id="layers_are_logi"><em class="firstterm">Layers</em> are logical groupings of functionality. For example, a data layer might encapsulate functionality related to data and state, while a presentation layer handles display concerns, such as rendering to the DOM and binding UI behaviors.</p>
<p id="tiers_are_the_r"><em class="firstterm">Tiers</em> are the runtime environments that layers get deployed to. A runtime environment usually consists of at least one physical computer, an operating system, the runtime engine (e.g., Node, Java, or Ruby) and any configuration needed to express how the application should interact with its environment.</p>
<p id="its_possible_t_id1">It's possible to run multiple layers on the same tier, but tiers should be kept independent enough that they can easily be deployed to separate machines, or even separate data centers. For large scale applications, it's usually also necessary that tiers can scale horizontally, meaning that as demand increases, you can add machines to a tier in order to improve its capacity to meet that demand.</p>
<div class="sect1" data-original-filename="ch06.xml" id="client_side_concerns">
<div class="titlepage"><div><div><h2 class="title">Client Side Concerns</h2></div></div></div>
<p id="there_are_sever_id4">There are several client-side concerns that almost every mature JavaScript application might deal with at some point:</p>
<div class="itemizedlist" id="module_manageme_id1"><ul class="itemizedlist">
<li class="listitem"><p id="module_manageme_id2">Module management</p></li>
<li class="listitem"><p id="events_id2">Events</p></li>
<li class="listitem"><p id="presentation_an">Presentation and DOM manipulation</p></li>
<li class="listitem"><p id="internationaliz_id1">Internationalization</p></li>
<li class="listitem"><p id="data_management">Data Management and IO (including AJAX)</p></li>
<li class="listitem"><p id="routing_transl">Routing (translating URLs to script actions)</p></li>
<li class="listitem"><p id="logging">Logging</p></li>
<li class="listitem"><p id="analytics_track">Analytics Tracking</p></li>
<li class="listitem"><p id="authentication">Authentication</p></li>
<li class="listitem"><p id="feature_togglin">Feature Toggling (decouple code deployment and feature release)</p></li>
</ul></div>
<p id="various_librari">Various libraries and frameworks exist which generally attempt to provide some combination of mechanisms to deal with these concerns. Libraries roughly fall into two categories: Minimal and monolithic. Minimal libraries generally provide a handful of objects and methods which make it easier to build well organized applications. Perhaps the most famous example is Backbone.js, which provides Views, Models, Collections, Routers, and Events.</p>
<p id="that_may_sound_">That may sound like a lot, until you compare it to something like the Dojo framework, which is something like a library of libraries. It includes an impressive array of components which do everything from extending JavaScript with ideas from other programming languages like aspects (Aspect Oriented Programming) to DOM widgets such as a calendar. Dojo is interesting because it started out more monolithic, and now it's actually a tiny module loader with a large library of components that you can use if you wish, without loading the entire Dojo framework.</p>
<p id="larger_framewor">Larger frameworks tend to be more heavy-handed (opinionated) about how your application architecture should function.</p>
<p id="there_is_a_grow">There is a growing trend in the JavaScript community moving in the direction of micro libraries, and micro library frameworks. <a class="ulink" href="http://microjs.com/" target="_top">Microjs.com</a> has a list of interesting micro libraries. You should certainly explore the wealth of microlibraries available in the community, and use the ones that solve your problems.</p>
<div class="warning" id="you_might_see_m_id1">
<p id="you_might_see_m_id2">You might see microlibrary proponents  discourage the use of jQuery, not least because it's quite large compared to most microlibraries. However, there is some security in using a well tested library like jQuery because it is used and improved by thousands of other smart developers. It's usually safe to assume that jQuery will mostly behave as expected (of course, there are always exceptions). </p>
<p id="despite_the_cla">Despite the claims of microlibary authors, most microlibraries have not undergone the same level of scrutiny as jQuery, and small libraries don't equate to bug free libraries. Everybody makes mistakes. Be prepared to debug them as you work with them. Please contribute fixes back to the author if you find and fix a bug.</p>
<p id="its_also_likel">It's also likely that you'll use most of jQuery's core feature set in every application that you build. I see no good reason to reassemble that feature set from microlibraries every time you start a new project.</p>
<p id="also_be_aware_t">Also be aware that many microlibraries may need to reinvent the wheel over and over again for commonly needed patterns, like copying attrubites from one object to another (as in jQuery or Underscore's <code class="code">.extend()</code> method). It might seem like a good idea to use less code, but there's a chance you'll end up using more, instead, unless you go with a well organized microlibrary framework with components designed to be used together.</p>
</div>
<p id="in_order_to_dec">In order to decide which application frameworks or libraries might help you build your application, take a look at the <a class="ulink" href="http://addyosmani.github.com/todomvc/" target="_top">TodoMVC project</a>, which compares many commonly used libraries, such as Backbone.js, Angular.js, Dojo, and YUI by showing you an example of what a simple Todo application looks like using each library.</p>
<div class="sect2" id="module_management">
<div class="titlepage"><div><div><h3 class="title">Module Management</h3></div></div></div>
<p id="module_manageme_id3">Module management is concerned with supplying a standard architecture that allows your modules to fit together easily and communicate with each other without being tightly coupled.</p>
<p id="the_module_mana">The module manager prescribes a standard module API that all other modules can implement and a sandbox of common library functionality that any module can use, so that application modules can stay lightweight and focus exclusively on the service that they provide.</p>
<p id="module_manageme_id4">Module management  typically supplies your application with:</p>
<div class="itemizedlist" id="namespacingsand"><ul class="itemizedlist">
<li class="listitem"><p id="namespacing">Namespacing</p></li>
<li class="listitem"><p id="sandbox_a_base">Sandbox (a base layer of functionality that other modules can safely use)</p></li>
<li class="listitem"><p id="access_to_envir">Access to environment variables and bootstrapped data</p></li>
<li class="listitem"><p id="module_lifecycl">Module lifecycle hooks (help with setup and teardown)</p></li>
<li class="listitem"><p id="an_event_system">An event system for inter-module communication</p></li>
</ul></div>
<p id="nicholas_zakas_">Nicholas Zakas gave a related talk called <a class="ulink" href="http://www.slideshare.net/nzakas/scalable-javascript-application-architecture" target="_top">Scalable JavaScript Application Architecture</a>, and Addy Osmani (author of Aura) wrote about it in <a class="ulink" href="http://addyosmani.com/largescalejavascript/" target="_top">"Patterns For Large-Scale JavaScript Application Architecture"</a>. Often, module management implementations are part of a monolithic application library tightly coupled to a proprietary codebase, or both.</p>
<p id="aura_is_a_good_">Aura is a good example of an open-source implementation with a fairly narrow focus on module management - with one clear difference: Aura has a strong focus on widgets, which are modules that have a UI component that needs to render itself to the screen. A generic module could perform any type of service, and may or may not need a dedicated space to render. A widget exists primarily for the purpose of suppling UI output or UI interaction.</p>
<p id="for_the_sake_of">For the sake of clarity and simplicity in the following examples, I wrote a simple module management solution called Tinyapp. It is an open source library. To get the source, clone it from Github:</p>
<pre class="programlisting" data-language="console" id="git_clone_git"><code class="gp">$</code> git clone git://github.com/dilvie/tinyapp.git</pre>
<div class="sect3" id="chanb2cc80001c2rw22adtqek">
<div class="titlepage"><div><div><h4 class="title">Getting Started</h4></div></div></div>
<p id="as_of_this_writ_id1">As of this writing, Tinyapp is rapidly evolving. Please see the <a class="ulink" href="http://tinyappjs.com/" target="_top">Tinyapp website</a>  to learn how to download and install the latest version.</p>
<p id="simply_require">Simply <code class="code">require()</code> it and initialize your app:</p>
<pre class="programlisting" data-language="js" id="var_app__requi_id1"><code class="kd">var</code> <code class="nx">app</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'tinyapp'</code><code class="p">);</code>

<code class="nx">app</code><code class="p">.</code><code class="nx">init</code><code class="p">({</code>
  <code class="nx">environment</code><code class="o">:</code> <code class="nx">environment</code><code class="p">,</code>
  <code class="nx">pageData</code><code class="o">:</code> <code class="nx">pageData</code><code class="p">,</code>
  <code class="nx">beforeRender</code><code class="o">:</code> <code class="p">[</code><code class="nx">promise1</code><code class="p">,</code> <code class="nx">promise2</code><code class="p">...]</code>
<code class="p">});</code></pre>
<p id="the_environment">The <code class="bold">environment</code> object (optional) is the primary means of passing application environment configuration  into your JavaScript application. Use it for passing in data that usually has to come from server side configuration, such as environment domain names, application ids for third party services, CDN urls, etc...</p>
<p id="there_are_a_cou">There are a couple of ways you could source the environment from the server side: load it with Ajax, or include it in the html with an inline script.</p>
<p id="the_pagedata_ob">The <code class="code">pageData</code> object is intended to register bootstrapped data with the app at page load time.</p>
<p id="beforerender_is"><code class="code">beforeRender</code> is a list of promises which all must finish before the render phase begins. For example, many apps will need i18n translations to load before any module is allowed to render. By adding an i18n promise to the application's <code class="code">beforeRender</code> queue, you can postpone render until the translations are loaded. Using <code class="code">beforeRender</code> can prevent tricky race condition bugs, and provide a neat solution if you need a guaranteed way to handle tasks before the modules render. See   <a class="xref" href="ch06.html#chanatuqi0000c2rw41l8on79">“Registration, Loading and Rendering”</a> for more about application and module timing hooks.</p>
<div class="warning" id="be_careful_with_id1"><p id="be_careful_with_id2">Be careful with the global <code class="code">beforeRender</code> queue. Each item you add to it compounds the possibility that something in the queue will fail, which might significantly delay or block the render of your application. If what you're waiting for only impacts a single module, keep the waiting logic isolated to that module.</p></div>
<p id="heres_how_you__id2">Here's how you might build up a typical Tinyapp module:</p>
<p id="require_tinyapp">Require Tinyapp:</p>
<pre class="programlisting" data-language="js" id="var_app__requi_id2"><code class="kd">var</code> <code class="nx">app</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'tinyapp'</code><code class="p">);</code></pre>
<p id="provide_an_api">Provide an API:</p>
<pre class="programlisting" data-language="js" id="var_app__requi_id3"><code class="kd">var</code> <code class="nx">app</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'tinyapp'</code><code class="p">),</code>

  <code class="nx">hello</code> <code class="o">=</code> <code class="kd">function</code> <code class="nx">hello</code><code class="p">()</code> <code class="p">{</code>
    <code class="k">return</code> <code class="s1">'hello, world'</code><code class="p">;</code>
  <code class="p">},</code>

  <code class="nx">api</code> <code class="o">=</code> <code class="p">{</code>
    <code class="nx">hello</code><code class="o">:</code> <code class="nx">hello</code>
  <code class="p">};</code></pre>
<p id="export_your_mod">Export your module:</p>
<pre class="programlisting" data-language="js" id="var_app__requi_id4"><code class="kd">var</code> <code class="nx">app</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'tinyapp'</code><code class="p">),</code>

  <code class="nx">hello</code> <code class="o">=</code> <code class="kd">function</code> <code class="nx">hello</code><code class="p">()</code> <code class="p">{</code>
    <code class="k">return</code> <code class="s1">'hello, world'</code><code class="p">;</code>
  <code class="p">},</code>

  <code class="nx">api</code> <code class="o">=</code> <code class="p">{</code>
    <code class="nx">hello</code><code class="o">:</code> <code class="nx">hello</code>
  <code class="p">};</code>

<code class="nx">module</code><code class="p">.</code><code class="nx">exports</code> <code class="o">=</code> <code class="nx">api</code><code class="p">;</code>
</pre>
<div class="tip" id="this_contrived__id1">
<p id="this_contrived__id2">This contrived example should be really be simplified even further. Since it doesn't actually use <code class="code">tinyapp</code>, it doesn't need to require it, and since it's only exporting a single fuction (which is actually a pretty good idea for lots of modules), it could just be <code class="code">module.exports = function hello() { </code>...</p>
<p id="any_standard_no">Any standard node-style module could be used as a Tinyapp module, but as you'll see, Tinyapp provides some utility and benefit that you'll use a lot.</p>
</div>
</div>
<div class="sect3" id="registration_loading_and_rendering">
<div class="titlepage"><div><div><h4 class="title">Registration, Loading and Rendering</h4></div></div></div>
<p id="if_you_need_to_">If you need to fetch some data asynchronously before you render your module, Tinyapp helps speed things up by launching your asynchronous calls as early as possible.</p>
<p id="module_initiali">Module initialization is broken into two phases: load and render. Imagine you want to asynchronously fetch some data while the page is still loading so that you can begin to render it as early as possible. This can speed up your perceived page load times.</p>
<p id="the_solution_is">The solution is to kick off the asynchronous fetch at load time, so that it begins the download as early as possible: before DOM ready, and before the page is done processing all the HTML, CSS, and JavaScript on the page. Since the load is asynchronous, it will introduce only a few milliseconds of latency during the load phase, but it'll do most of the work in the background while the browser continues processing the rest of the page in parallel with the load.</p>
<p id="if_you_have_dat">If you have data that is secondary to the main purpose of the page, and you can get away with waiting until after the DOM is ready, it's a good idea to let your page load normally and fetch the data during the render step, instead of using the early load hook. This will reduce the number of page requests that must be handled at page load time (eliminating the latency hit) and hopefully also improve the perceived performance of your app.</p>
<p id="tinyapp_allows_">Tinyapp allows you to hook into those page load phases individually so you can optimize page load times and manage render dependencies without worrying about asynchronous timing issues.</p>
<p id="you_can_specify">You can specify <code class="code">load()</code> and <code class="code">render()</code> callbacks by passing them into a registration method:</p>
<pre class="programlisting" data-language="js" id="appregister_"><code class="nx">app</code><code class="p">.</code><code class="nx">register</code><code class="p">({</code>
  <code class="nx">load</code><code class="o">:</code> <code class="nx">load</code><code class="p">,</code>
  <code class="nx">render</code><code class="o">:</code> <code class="nx">render</code>
<code class="p">});</code></pre>
<p id="the_render_ca">The  <code class="code">render()</code> callback is called after:</p>
<div class="itemizedlist" id="any_promise_ret_id1"><ul class="itemizedlist">
<li class="listitem"><p id="any_promise_ret_id2">Any promise returned by <code class="code">load()</code> is resolved. For example, if you return a jQuery AJAX promise from your <code class="code">load()</code> function, it will wait until the AJAX fetch is complete. All jQuery AJAX calls return compatible promises.</p></li>
<li class="listitem"><p id="all_beforerende">All <code class="code">beforeRender</code> callbacks have fired (see <a class="xref" href="ch06.html#chanb2cc80001c2rw22adtqek" title="Getting Started">“Getting Started”</a>).</p></li>
<li class="listitem"><p id="the_dom_is_read">The DOM is ready to be manipulated.</p></li>
</ul></div>
<p id="registration_is">Registration is optional. If you don't need any of the features it provides, you aren't required to use it.</p>
<p id="time_for_an_exa">Time for an example. Imagine you have a widget that displays tour dates for bands. Here's how it could work:</p>
<pre class="programlisting" data-language="js" id="var_app__requi_id5"><code class="kd">var</code>
  <code class="nx">app</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'tinyapp'</code><code class="p">),</code>
  <code class="nx">view</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'./view'</code><code class="p">),</code>
  <code class="nx">data</code><code class="p">,</code>

  <code class="nx">load</code> <code class="o">=</code> <code class="kd">function</code> <code class="nx">load</code><code class="p">()</code> <code class="p">{</code>
    <code class="kd">var</code> <code class="nx">url</code> <code class="o">=</code> <code class="s1">'http://api.bandsintown.com/artists/'</code> <code class="o">+</code>
      <code class="s1">'Skrillex.json?api_version=2.0&amp;amp;app_id=YOUR_APP_ID'</code><code class="p">;</code>

    <code class="nx">whenLoaded</code> <code class="o">=</code> <code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="nx">url</code><code class="p">);</code>
    <code class="nx">whenLoaded</code><code class="p">.</code><code class="nx">done</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">response</code><code class="p">)</code> <code class="p">{</code>
      <code class="nx">data</code> <code class="o">=</code> <code class="nx">response</code><code class="p">;</code>
    <code class="p">});</code>

    <code class="k">return</code> <code class="nx">whenLoaded</code><code class="p">.</code><code class="nx">promise</code><code class="p">();</code>
  <code class="p">},</code>

  <code class="nx">render</code> <code class="o">=</code> <code class="kd">function</code> <code class="nx">render</code><code class="p">()</code> <code class="p">{</code>
    <code class="nx">view</code><code class="p">.</code><code class="nx">render</code><code class="p">(</code><code class="nx">data</code><code class="p">);</code>
  <code class="p">};</code>

<code class="nx">app</code><code class="p">.</code><code class="nx">register</code><code class="p">({</code>
  <code class="nx">load</code><code class="o">:</code> <code class="nx">load</code><code class="p">,</code>
  <code class="nx">render</code><code class="o">:</code> <code class="nx">render</code><code class="p">,</code>
<code class="p">});</code>

<code class="nx">module</code><code class="p">.</code><code class="nx">exports</code> <code class="o">=</code> <code class="nx">api</code><code class="p">;</code>
</pre>
<div class="warning" id="try_not_to_do_a_id1">
<p id="try_not_to_do_a_id2">Try not to do anything blocking in your <code class="code">load()</code> function.  For example, you might want to fetch the data that you need to complete your page render, but if you're loading a  large collection and you need to iterate over the collection and do some data processing, save the data processing step for <code class="code">render()</code> time, when you're not blocking the page render process.</p>
<p id="its_not_safe_t"><span class="emphasis"><em>It's not safe to manipulate the DOM at all in your <code class="code">load()</code> function.</em></span> </p>
</div>
</div>
</div>
<div class="sect2" id="events_id3">
<div class="titlepage"><div><div><h3 class="title">Events</h3></div></div></div>
<p id="events_are_a_me"><em class="firstterm">Events</em> are a method of communicating between different application modules or components in order to achieve loose coupling, asynchronous communication, interprocess communication, or any combination of the above. For example, the browser environment is event-driven. It presents DOM elements to users (buttons and form inputs, for example), and then responds to user input by firing events for the application to listen for and handle.</p>
<p id="youre_probably">You're probably already familiar with responding to existing browser DOM events. If you need a refresher, consult the <a class="ulink" href="https://developer.mozilla.org/en-US/docs/DOM" target="_top">Mozilla DOM Reference</a> or "Dynamic HTML: The Definitive Reference" by Danny Goodman (O’Reilly). This section covers defining and using your own custom events, independent of the DOM.</p>
<p id="in_order_to_kee_id1"></p>
<div class="tip" id="in_order_to_kee_id2"><p id="in_order_to_kee_id3">In order to keep modules decoupled from each other, it's helpful to think of events as reports of what has happened, rather than commands for what should happen next. Other modules can listen for the events they care about and decide what to do next on their own.</p></div>
<div class="sect3" id="event_emitters">
<div class="titlepage"><div><div><h4 class="title">Event Emitters</h4></div></div></div>
<p id="often_we_need_t">Often we need to provide a method API that can handle a range of asynchronous communication. A good solution to this problem is to return an object that emits events. DOM elements are event emitters, so that they can notify you of user input or other state changes. For example, most elements emit a click <code class="code">event</code> when the user clicks on them, and the HTML5 video API emits events for loading progress, playback position changes, and a variety of other information that isn't immediately known.</p>
<p id="its_possible_t_id2">It's possible to create your own event emitter API that you can mix into any JavaScript object. A minimal implementation might only have three methods:</p>
<p id="on_trigger">.on(), .trigger(), .off()</p>
<p id="backbonejs_is_">Backbone.js is a client side MV* library that provides event emitters for models, views, routers, and collections. If you're using Backbone, (which relies on Underscore), you can turn any object into an event emitter like this:</p>
<pre class="programlisting" data-language="js" id="extendmyobje"><code class="nx">_</code><code class="p">.</code><code class="nx">extend</code><code class="p">(</code><code class="nx">myObject</code><code class="p">,</code> <code class="nx">Backbone</code><code class="p">.</code><code class="nx">Events</code><code class="p">);</code>

<code class="nx">myObject</code><code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s1">'my_event'</code><code class="p">,</code> <code class="kd">function</code> <code class="nx">handle</code><code class="p">(</code><code class="nx">data</code><code class="p">)</code> <code class="p">{</code>
  <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">data</code><code class="p">);</code>
<code class="p">});</code>

<code class="nx">object</code><code class="p">.</code><code class="nx">trigger</code><code class="p">(</code><code class="s1">'my_event'</code><code class="p">,</code> <code class="s1">'hi'</code><code class="p">);</code> <code class="c1">// logs 'hi'</code></pre>
<p id="the_downside_to">The downside to triggering events only on the object to which the events belong is that every listener must be given a reference to the object. In situations where there are potentially many objects listening, that strategy requires too much boilerplate code to be maintainable.</p>
<p id="another_problem">Another problem you might encounter is that listeners must be tightly coupled to emitters, which partially defeats the purpose of using events in the first place. To get around that, you can wire up emitters and  receivers through an event mediator, or connector.</p>
<p id="in_cases_where_">In cases where you have a views with child views that need to communicate up to the top level, this pattern becomes problematic because at each level, the child and parent must register with each other to relay messages back and forth. In that situation, you create a lot of code overhead, and debugging event passing bugs can become very painful.</p>
<div class="tip" id="if_you_have_an__id1"><p id="if_you_have_an__id2">If you have an object that needs to inform your application about asynchronous events such as incoming push notifications (chat notifications, new items added to collections, etc...), an event emitter might be the right solution.</p></div>
</div>
<div class="sect3" id="event_aggregators">
<div class="titlepage"><div><div><h4 class="title">Event Aggregators</h4></div></div></div>
<p id="in_contrast_to_">In contrast to event emitters, an <em class="firstterm">event aggregator</em> is a central object that collects events from multiple sources, and delivers them to registered subscribers. This is essentially a type of publish/subscribe pattern. An aggregator eliminates the need for specialized  mediators to keep an emitter and listener decoupled. Again, with backb and Underscore, that might look something like this:</p>
<p id="var_app___bus_id1"></p>
<pre class="programlisting" data-language="js" id="var_app___bus_id2"><code class="kd">var</code> <code class="nx">app</code> <code class="o">=</code> <code class="p">{</code>
  <code class="nx">bus</code><code class="o">:</code> <code class="nx">_</code><code class="p">.</code><code class="nx">extend</code><code class="p">({},</code> <code class="nx">Backbone</code><code class="p">.</code><code class="nx">Events</code><code class="p">)};</code>

<code class="nx">app</code><code class="p">.</code><code class="nx">bus</code><code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s1">'my_event'</code><code class="p">,</code> <code class="kd">function</code> <code class="nx">handle</code><code class="p">(</code><code class="nx">data</code><code class="p">)</code> <code class="p">{</code>
  <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">data</code><code class="p">);</code>
<code class="p">});</code>

<code class="nx">app</code><code class="p">.</code><code class="nx">bus</code><code class="p">.</code><code class="nx">trigger</code><code class="p">(</code><code class="s1">'my_event'</code><code class="p">,</code> <code class="s1">'hi'</code><code class="p">);</code> <code class="c1">// logs 'hi'</code></pre>
<p id="event_aggregato">Event aggregators can be enormously useful. Because neither emitter nor subscriber need know about the other, aggregators enable very loose coupling between modules. Each only needs a reference to the aggregator.</p>
</div>
<div class="sect3" id="queues_and_stacks">
<div class="titlepage"><div><div><h4 class="title">Queues and Stacks</h4></div></div></div>
<p id="one_disadvantag">One disadvantage of the publish/subscribe pattern is that there is no guarantee that a message will be processed once it is broadcast.</p>
<p id="a_message_queue">A <em class="firstterm">message queue</em> is a type of event mediator that records every message it hears in a queue (or stack) for later processing. That log of messages can be permanently recorded, if needed, and the queue is actively managed, so it's possible to enforce guarantees that some listener got the message. </p>
<p id="often_there_is_">Often there is a need for separate modules or processes to collaborate in order to process input. For example, imagine that your application is a tool for photographers. It allows photographers to upload a photo, resize it, watermark it, and then send it to various social networks automatically.</p>
<p id="when_a_photo_is">When a photo is uploaded, it's added to a processing queue. Later, a pool of photo processing workers can independently pull photo processing jobs from  the message queue as they are ready to process them, and message back when the photos are ready to be distributed across the web. Other workers can then pick up the finished photo messages and handle the distribution step. With this architecture, the processing workers can scale independently of the distribution workers.</p>
<p id="if_you_need_a_m">If you need a message queue, you might be in luck. It's such a common pattern that there are several popular out of the box solutions, such as <a class="ulink" href="http://robey.github.com/kestrel/" target="_top">Kestrel</a>, or <a class="ulink" href="http://aws.amazon.com/sqs/" target="_top">Amazon Simple Queue Service (SQS)</a>.</p>
</div>
<div class="sect3" id="choosing_the_right_event_model">
<div class="titlepage"><div><div><h4 class="title">Choosing the Right Event Model</h4></div></div></div>
<p id="in_reality_no_">In reality, no single event model provides a complete solution to event management. It doesn't make sense to examine a bunch of different event models and chose just one for your application. Most web-based applications eventually need more than one type. Here are some example use cases:</p>
<p id="for_reusable_li">For reusable libraries that deal with asynchronous behaviors, consider an event emitter.</p>
<p id="for_communicati">For communication between models, views, logging systems, analytics systems, and so on, where it's advantageous to keep coupling to a minimum, go with an event aggregator.</p>
<p id="for_reliable_co">For reliable communication between independently scalable and deployable application tiers, a message queue may be the right solution.</p>
<p id="this_guide_has_">This guide has really only skimmed the surface of possible messaging patterns. I've intentionally focused only on the most common patterns that might be handy in almost every app that grows beyond a few thousand lines of code. For more ideas, take a look at Martin Fowler's writing on <a class="ulink" href="http://martinfowler.com/eaaDev/EventAggregator.html" target="_top">Event Aggregator</a>, <a class="ulink" href="http://martinfowler.com/eaaDev/MediatedSynchronization.html" target="_top">Observer Synchronization</a>, and <a class="ulink" href="http://martinfowler.com/eaaDev/EventSourcing.html" target="_top">Event Sourcing</a>.</p>
</div>
<div class="sect3" id="events_by_example">
<div class="titlepage"><div><div><h4 class="title">Events by Example</h4></div></div></div>
<p id="to_better_under">To better understand how the most common messaging patterns fit together, it might be useful to revisit the guestlist app introduced in <a class="xref" href="ch05.html" title="Chapter 5. Modules">Chapter 5</a>.</p>
<p id="of_course_the_">Of course, the whole idea here is to keep the presentation concerns separate from the data management and domain logic concerns. Backbone.js can give you a leg up with that by encapsulating common data management tasks in models and collections, and encapsulating display and UI concerns in views.</p>
<p id="all_backbonemo">All <code class="code">Backbone.Model</code> instances are event emitters. When a model attribute changes, it emits a <code class="code">change:&lt;attribute&gt;</code> event, where <code class="code">&lt;attribute&gt;</code> is the name of the attribute that changed. Since you want to communicate the change to the view without tightly coupling the model to the view or vice verse, you'll want to have the model listen for its own change event, and rebroadcast it it the app level.</p>
<p id="the_view_can_li">The view can listen for the app level <code class="code">changed</code> event and respond by updating the list item that changed.</p>
<p id="here_is_the_new">Here is the new guestlist model. You can listen to the <code class="code">Backbone.Model</code> event emitter with, <code class="code">this.on('change:checkedIn', handler)</code>:</p>
<div class="example" id="guestmodeljs">
<div class="example-title">Example 6-1. guestmodel.js</div>
<div class="example-contents"><pre class="programlisting" data-language="js" id="var_model__req"><code class="kd">var</code> <code class="nx">Model</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'backbone-browserify'</code><code class="p">).</code><code class="nx">Model</code><code class="p">,</code>
  <code class="nx">app</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'./tinyapp'</code><code class="p">),</code>

  <code class="c1">// Set the checkedIn attribute on the model.</code>

  <code class="nx">toggleCheckedIn</code> <code class="o">=</code> <code class="kd">function</code> <code class="nx">toggleCheckedIn</code><code class="p">()</code> <code class="p">{</code>
    <code class="k">this</code><code class="p">.</code><code class="nx">set</code><code class="p">(</code><code class="s1">'checkedIn'</code><code class="p">,</code> <code class="o">!</code><code class="k">this</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'checkedIn'</code><code class="p">));</code>
  <code class="p">},</code>

  <code class="nx">delegate</code> <code class="o">=</code> <code class="kd">function</code> <code class="nx">delegate</code><code class="p">()</code> <code class="p">{</code>
    <code class="kd">var</code> <code class="nx">sourceId</code> <code class="o">=</code> <code class="k">this</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'id'</code><code class="p">);</code>

    <code class="c1">// Listen for toggled event, sent from the view.</code>
    <code class="c1">// sourceId is used to filter the event. The model</code>
    <code class="c1">// does not need to know where the event comes from --</code>
    <code class="c1">// only which item was clicked.</code>

    <code class="nx">app</code><code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s1">'toggled-checkedin'</code><code class="p">,</code> <code class="nx">sourceId</code><code class="p">,</code>
      <code class="nx">toggleCheckedIn</code><code class="p">.</code><code class="nx">bind</code><code class="p">(</code><code class="k">this</code><code class="p">));</code>


    <code class="c1">// Relay the change event so the view can listen for it</code>
    <code class="c1">// without knowing anything about the model.</code>

    <code class="k">this</code><code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s1">'change:checkedIn'</code><code class="p">,</code> <code class="kd">function</code> <code class="p">(</code><code class="nx">item</code><code class="p">)</code> <code class="p">{</code>

      <code class="c1">// Send a shallow copy of the list item as the</code>
      <code class="c1">// message payload. Make sure the new checkedIn</code>
      <code class="c1">// state is easy to access.</code>

      <code class="kd">var</code> <code class="nx">event</code> <code class="o">=</code> <code class="nx">app</code><code class="p">.</code><code class="nx">extend</code><code class="p">({},</code> <code class="nx">item</code><code class="p">,</code> <code class="p">{</code>
        <code class="nx">sourceId</code><code class="o">:</code> <code class="k">this</code><code class="p">.</code><code class="nx">id</code><code class="p">,</code>
        <code class="nx">checkedIn</code><code class="o">:</code> <code class="nx">item</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'checkedIn'</code><code class="p">)</code>
      <code class="p">});</code>


      <code class="c1">// Broadcast the message on the aggregator.</code>

      <code class="nx">app</code><code class="p">.</code><code class="nx">trigger</code><code class="p">(</code><code class="s1">'changed.checkedIn'</code><code class="p">,</code> <code class="nx">event</code><code class="p">);</code>
    <code class="p">}.</code><code class="nx">bind</code><code class="p">(</code><code class="k">this</code><code class="p">));</code>  
  <code class="p">},</code>

  <code class="c1">// The collection expects a Backbone.Model constructor.</code>

  <code class="nx">api</code> <code class="o">=</code> <code class="nx">Model</code><code class="p">.</code><code class="nx">extend</code><code class="p">({</code>
    <code class="nx">initialize</code><code class="o">:</code> <code class="nx">delegate</code><code class="p">,</code>
    <code class="nx">toggleCheckedIn</code><code class="o">:</code> <code class="nx">toggleCheckedIn</code>
  <code class="p">});</code>

<code class="nx">module</code><code class="p">.</code><code class="nx">exports</code> <code class="o">=</code> <code class="nx">api</code><code class="p">;</code>
</pre></div>
</div>
<p id="note_the_line">Note the line:</p>
<pre class="programlisting" data-language="js" id="appontoggled"><code class="nx">app</code><code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s1">'toggled-checkedin'</code><code class="p">,</code> <code class="nx">sourceId</code><code class="p">,</code>
  <code class="nx">toggleCheckedIn</code><code class="p">.</code><code class="nx">bind</code><code class="p">(</code><code class="k">this</code><code class="p">));</code></pre>
<p id="tinyapp_adds_th">Tinyapp adds the concept of a <code class="code">sourceId</code> to event listening. The idea is that you augment your triggered event object with the id of the object you're talking about. When you listen for the event (like this example illustrates), you can pass in the object's ID to filter out any events that don't have that <code class="code">sourceId</code> on the event object. This can be handled at the application framework or event library level. For example, in Tinyapp, there's a wrapper around the <code class="code">events.on</code> method that looks something like this:</p>
<pre class="programlisting" data-language="js" id="function_on_"><code class="kd">function</code> <code class="nx">on</code><code class="p">()</code> <code class="p">{</code>
  <code class="kd">var</code> <code class="nx">args</code> <code class="o">=</code> <code class="p">[].</code><code class="nx">slice</code><code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">arguments</code><code class="p">),</code>
    <code class="nx">type</code> <code class="o">=</code> <code class="nx">args</code><code class="p">[</code><code class="mi">0</code><code class="p">],</code>
    <code class="nx">sourceId</code> <code class="o">=</code> <code class="nx">args</code><code class="p">[</code><code class="mi">1</code><code class="p">],</code>
    <code class="nx">callback</code> <code class="o">=</code> <code class="nx">args</code><code class="p">[</code><code class="mi">2</code><code class="p">];</code>

  <code class="c1">// If there's no sourceId, just pass this through</code>
  <code class="c1">// to the event emitter.</code>

  <code class="k">if</code> <code class="p">(</code><code class="nx">args</code><code class="p">.</code><code class="nx">length</code> <code class="o">XXXXXXXXXXXXXXXXX=</code> <code class="mi">2</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">events</code><code class="p">.</code><code class="nx">on</code><code class="p">.</code><code class="nx">apply</code><code class="p">(</code><code class="nx">events</code><code class="p">,</code> <code class="nx">arguments</code><code class="p">);</code>
  <code class="p">}</code> <code class="k">else</code> <code class="p">{</code>


    <code class="c1">// Otherwise, filter out any events that don't match</code>
    <code class="c1">// the expected sourceId.</code>

    <code class="nx">events</code><code class="p">.</code><code class="nx">on</code><code class="p">.</code><code class="nx">call</code><code class="p">(</code><code class="nx">events</code><code class="p">,</code> <code class="nx">type</code><code class="p">,</code> <code class="kd">function</code> <code class="p">(</code><code class="nx">event</code><code class="p">)</code> <code class="p">{</code>
      <code class="k">if</code> <code class="p">(</code><code class="nx">event</code><code class="p">.</code><code class="nx">sourceId</code> <code class="o">===</code> <code class="nx">sourceId</code><code class="p">)</code> <code class="p">{</code>
        <code class="nx">callback</code><code class="p">(</code><code class="nx">event</code><code class="p">);</code>
      <code class="p">}</code>
    <code class="p">});</code>
  <code class="p">}</code>
<code class="p">}</code></pre>
<p id="similar_strateg">Similar strategies include namespacing events, and creating separate channels (aggregators) for separate concerns.</p>
<div class="warning" id="regardless_of_w_id1"><p id="regardless_of_w_id2">Regardless of which mechanism you prefer for event communication, be careful not to refer to other modules directly (including via channels and namespaces). If modules know how to communicate with each other directly, it defeats the purpose of loose coupling, and you might as well give them a direct handle on each other. A common pitfall that I have fallen into myself is to use the module's namespace as the event namespace. Doing so gives every module that needs to listen knowledge of the emitting module by name.</p></div>
<p id="returning_to_th_id2">Returning to the example app: The collection isn't doing much yet, but later you'll use it to add and remove guests. For now, it just gets a handle to the model constructor which it will use to instantiate new list items. The create method is just a thin wrapper around collection instantiation.</p>
<div class="example" id="guestlistcollectionjs">
<div class="example-title">Example 6-2. guestlistcollection.js</div>
<div class="example-contents"><pre class="programlisting" data-language="js" id="var_app__requi_id6"><code class="kd">var</code> <code class="nx">app</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'./tinyapp'</code><code class="p">),</code>
  <code class="nx">Model</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'./guestmodel'</code><code class="p">),</code>
  <code class="nx">Collection</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'backbone-browserify'</code><code class="p">)</code>
    <code class="p">.</code><code class="nx">Collection</code><code class="p">.</code><code class="nx">extend</code><code class="p">({</code>
      <code class="nx">model</code><code class="o">:</code> <code class="nx">Model</code>
    <code class="p">}),</code>

  <code class="nx">create</code> <code class="o">=</code> <code class="kd">function</code> <code class="nx">create</code><code class="p">(</code><code class="nx">models</code><code class="p">)</code> <code class="p">{</code>
    <code class="nx">models</code> <code class="o">=</code> <code class="nx">models</code> <code class="o">||</code> <code class="nx">app</code><code class="p">.</code><code class="nx">pageData</code><code class="p">.</code><code class="nx">guestList</code><code class="p">;</code>

    <code class="k">return</code> <code class="k">new</code> <code class="nx">Collection</code><code class="p">(</code><code class="nx">models</code><code class="p">);</code>
  <code class="p">},</code>

  <code class="nx">api</code> <code class="o">=</code> <code class="p">{</code>
    <code class="nx">create</code><code class="o">:</code> <code class="nx">create</code>
  <code class="p">};</code>

<code class="nx">module</code><code class="p">.</code><code class="nx">exports</code> <code class="o">=</code> <code class="nx">api</code><code class="p">;</code>

          </pre></div>
</div>
<p id="similar_to_how_">Similar to how the model relays its own events, the view listens for DOM events and relays them on the app event aggregator  so that other modules can listen (such as  models or click loggers). Pay special attention to the <code class="code">delegate()</code> and <code class="code">relayClick()</code> functions:</p>
<div class="example" id="guestlistviewjs">
<div class="example-title">Example 6-3. guestlistview.js</div>
<div class="example-contents"><pre class="programlisting" data-language="js" id="var_app__requi_id7"><code class="kd">var</code> <code class="nx">app</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'./tinyapp'</code><code class="p">),</code>

  <code class="c1">// Assign Backbone.View to the View var.</code>

  <code class="nx">View</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'backbone-browserify'</code><code class="p">).</code><code class="nx">View</code><code class="p">,</code>

  <code class="nx">$</code> <code class="o">=</code> <code class="nx">app</code><code class="p">.</code><code class="nx">$</code><code class="p">,</code>
  <code class="nx">checkedinClass</code> <code class="o">=</code> <code class="s1">'icon-check'</code><code class="p">,</code>
  <code class="nx">listClass</code> <code class="o">=</code> <code class="s1">'dropdown-menu'</code><code class="p">,</code>
  <code class="nx">guestClass</code> <code class="o">=</code> <code class="s1">'guest'</code><code class="p">,</code>


  <code class="c1">// Rebroadcast DOM click events on the app event</code>
  <code class="c1">// aggregator.</code>

  <code class="nx">relayClick</code> <code class="o">=</code> <code class="kd">function</code> <code class="nx">relayClick</code><code class="p">(</code><code class="nx">e</code><code class="p">)</code> <code class="p">{</code>

    <code class="c1">// Get the ID from the element and use it to</code>
    <code class="c1">// namespace the event.</code>

    <code class="kd">var</code> <code class="nx">sourceId</code> <code class="o">=</code> <code class="nx">$</code><code class="p">(</code><code class="k">this</code><code class="p">).</code><code class="nx">attr</code><code class="p">(</code><code class="s1">'id'</code><code class="p">),</code>
      <code class="nx">event</code> <code class="o">=</code> <code class="nx">app</code><code class="p">.</code><code class="nx">extend</code><code class="p">(</code><code class="nx">e</code><code class="p">,</code> <code class="p">{</code>
        <code class="nx">sourceId</code><code class="o">:</code> <code class="nx">$</code><code class="p">(</code><code class="k">this</code><code class="p">).</code><code class="nx">attr</code><code class="p">(</code><code class="s1">'id'</code><code class="p">)</code>
      <code class="p">});</code>

    <code class="nx">app</code><code class="p">.</code><code class="nx">trigger</code><code class="p">(</code><code class="s1">'toggled-checkedin'</code><code class="p">,</code> <code class="nx">event</code><code class="p">);</code>
  <code class="p">},</code>

  <code class="nx">delegate</code> <code class="o">=</code> <code class="kd">function</code> <code class="nx">delegate</code><code class="p">()</code> <code class="p">{</code>

    <code class="c1">// Delegate all click events to the parent element.</code>

    <code class="k">this</code><code class="p">.</code><code class="nx">$el</code><code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s1">'click'</code><code class="p">,</code> <code class="s1">'.'</code> <code class="o">+</code> <code class="nx">guestClass</code><code class="p">,</code> <code class="nx">relayClick</code><code class="p">);</code>

    <code class="c1">// Listen for changed events from the model</code>
    <code class="c1">// and make sure the element reflects the current</code>
    <code class="c1">// state.</code>

    <code class="nx">app</code><code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s1">'changed.checkedIn'</code><code class="p">,</code> <code class="kd">function</code> <code class="nx">changeHandler</code><code class="p">(</code><code class="nx">event</code><code class="p">)</code> <code class="p">{</code>
      <code class="kd">var</code> <code class="nx">id</code> <code class="o">=</code> <code class="nx">event</code><code class="p">.</code><code class="nx">id</code><code class="p">;</code>


      <code class="c1">// Select the right list item by id.</code>

      <code class="k">this</code><code class="p">.</code><code class="nx">$el</code><code class="p">.</code><code class="nx">find</code><code class="p">(</code><code class="s1">'#'</code> <code class="o">+</code> <code class="nx">id</code><code class="p">)</code>
        <code class="p">.</code><code class="nx">toggleClass</code><code class="p">(</code><code class="nx">checkedinClass</code><code class="p">,</code> <code class="nx">event</code><code class="p">.</code><code class="nx">checkedIn</code><code class="p">);</code>

    <code class="p">}.</code><code class="nx">bind</code><code class="p">(</code><code class="k">this</code><code class="p">));</code>
  <code class="p">},</code>

  <code class="nx">render</code> <code class="o">=</code> <code class="kd">function</code> <code class="nx">render</code><code class="p">(</code><code class="nx">guestlist</code><code class="p">)</code> <code class="p">{</code>
    <code class="kd">var</code> <code class="nx">$el</code> <code class="o">=</code> <code class="k">this</code><code class="p">.</code><code class="nx">$el</code><code class="p">;</code>

    <code class="nx">$el</code><code class="p">.</code><code class="nx">empty</code><code class="p">();</code>

    <code class="c1">// Loop over the passed-in guest models and render</code>
    <code class="c1">// them as li elements.</code>

    <code class="nx">guestlist</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">guestModel</code><code class="p">)</code> <code class="p">{</code>
      <code class="kd">var</code> <code class="nx">$guest</code><code class="p">;</code>
      <code class="nx">guest</code> <code class="o">=</code> <code class="nx">guestModel</code><code class="p">.</code><code class="nx">toJSON</code><code class="p">();</code>
      <code class="nx">$guest</code> <code class="o">=</code> <code class="nx">$</code><code class="p">(</code><code class="s1">'&lt;li class="'</code> <code class="o">+</code> <code class="nx">guestClass</code> <code class="o">+</code> <code class="s1">'" '</code> <code class="o">+</code>
        <code class="s1">'id="'</code> <code class="o">+</code> <code class="nx">guest</code><code class="p">.</code><code class="nx">id</code> <code class="o">+</code><code class="s1">'"&gt;'</code> <code class="o">+</code>
        <code class="s1">'&lt;span class="name"&gt;'</code> <code class="o">+</code> <code class="nx">guest</code><code class="p">.</code><code class="nx">name</code> <code class="o">+</code>
        <code class="s1">'&lt;/span&gt;&lt;/li&gt;'</code><code class="p">);</code>
      <code class="nx">$guest</code><code class="p">.</code><code class="nx">appendTo</code><code class="p">(</code><code class="nx">$el</code><code class="p">);</code>
    <code class="p">});</code>

    <code class="k">return</code> <code class="k">this</code><code class="p">;</code>
  <code class="p">},</code>

  <code class="c1">// Define the backbone view.</code>
  <code class="nx">GuestlistView</code> <code class="o">=</code> <code class="nx">View</code><code class="p">.</code><code class="nx">extend</code><code class="p">({</code>
    <code class="nx">tagName</code><code class="o">:</code> <code class="s1">'ol'</code><code class="p">,</code>
    <code class="nx">id</code><code class="o">:</code> <code class="s1">'guestlist-view'</code><code class="p">,</code>
    <code class="nx">className</code><code class="o">:</code> <code class="nx">listClass</code><code class="p">,</code>
    <code class="nx">initialize</code><code class="o">:</code> <code class="nx">delegate</code><code class="p">,</code>
    <code class="nx">render</code><code class="o">:</code> <code class="nx">render</code>
  <code class="p">}),</code>

  <code class="c1">// Expose a factory function.</code>
  <code class="nx">create</code> <code class="o">=</code> <code class="kd">function</code> <code class="nx">create</code><code class="p">()</code> <code class="p">{</code>
    <code class="k">return</code> <code class="k">new</code> <code class="nx">GuestlistView</code><code class="p">();</code>
  <code class="p">},</code>

  <code class="nx">api</code> <code class="o">=</code> <code class="p">{</code>
    <code class="nx">create</code><code class="o">:</code> <code class="nx">create</code>
  <code class="p">};</code>

<code class="nx">module</code><code class="p">.</code><code class="nx">exports</code> <code class="o">=</code> <code class="nx">api</code><code class="p">;</code>

          </pre></div>
</div>
</div>
</div>
<div class="sect2" id="mvc__mv">
<div class="titlepage"><div><div><h3 class="title">MVC / MV*</h3></div></div></div>
<p id="mvc_model_vie"><em class="firstterm">MVC</em> (Model, View, Controller) is an architecture for managing separation of presentation logic from business domain logic in applications.</p>
<p id="model_refers_to"><span class="emphasis"><em>Model</em></span> refers to application state, and methods for manipulating and retrieving state. Usually there is a mechanism to notify observing views when the model state changes. There can be more than one view listening to a single model.</p>
<p id="view_refers_to_"><span class="emphasis"><em>View</em></span> refers to the UI that gets drawn to the screen. It generally listens to the model so that it can update the UI when state changes, and sometimes to the controller so that it can handle presentation changes that do not impact the business domain (such as scrolling or showing / hiding UI).</p>
<p id="controller_refe"><span class="emphasis"><em>Controller</em></span> refers to the user interaction logic. It updates the model in response to user requests. In some MVC interpretations, it is responsible for instantiating both the model and the view, and wiring up event listeners between them. Most server side web frameworks have controllers that route incoming requests to actions, which manipulate the model and serve updated views to the user.</p>
<div class="figure" id="mvc">
<div class="figure-contents"><div class="mediaobject"><table style="border: 0; width: 432; cellpadding: 0; cellspacing: 0;"><tr><td><img style="width: 432; " src="http://orm-chimera-prod.s3.amazonaws.com/1234000000262/figs/0601.png" alt="MVC"></td></tr></table></div></div>
<div class="figure-title">Figure 6-1. MVC</div>
</div>
<p id="in_the_browser">In the browser, where each element in the DOM also happens to be an event emitter, it might seem natural to handle a bit more of the input directly in the view (rather than the controller, as is common with MVC). Several alternatives to MVC have sprung up which deviate slightly from the MVC architecture. The alternatives are commonly grouped together and referred to as <em class="firstterm">MV*</em>. Typically there will be a notion of a model and a view (or something like them), and some other notions about how models and views interact.</p>
<p id="the_most_popula">The most popular MV* library is <em class="firstterm">Backbone</em>. Instead of models, views, and controllers, and an opinionated way of stitching them together, Backbone defines <code class="code">View</code>, <code class="code">Model</code>, <code class="code">Collection</code>, and <code class="code">Router</code> constructors. You are expected to subclass those constructors using the <code class="code">.extend()</code> method available on each of the constructors. </p>
<div class="warning" id="backbones_ext_id1"><p id="backbones_ext_id2">Backbone's <code class="code">.extend()</code> method creates classical style inheritance hierarchies, with all the pitfalls that go along with them. I have seen a couple of projects get into trouble by relying too much on Backbone's <code class="code">.extend()</code> inheritance. Be careful about subclassing from subclasses. Instead, try passing exemplar prototypes and mixins into <code class="code">.extend()</code> in order to facilitate code reuse.  See <a class="xref" href="ch04.html#chcss2i1z00025eilzn6ki8ds" title="Classical Inheritance is Obsolete">“Classical Inheritance is Obsolete”</a> and <a class="xref" href="ch04.html#chcsrdou100015eilvj6l9inj" title="Prototypes">“Prototypes”</a>.</p></div>
<p id="backbone_is_not">Backbone is not  terribly opinionated about how you stitch the various pieces together, but most samples you'll find in the wild give a lot of responsibility to the view, which typically instantiates and keeps a reference to collections, models, or both. A typical arrangement might look something like this:</p>
<div class="figure" id="backbone">
<div class="figure-contents"><div class="mediaobject"><table style="border: 0; width: 432; cellpadding: 0; cellspacing: 0;"><tr><td><img style="width: 432; " src="http://orm-chimera-prod.s3.amazonaws.com/1234000000262/figs/0602.png" alt="Backbone"></td></tr></table></div></div>
<div class="figure-title">Figure 6-2. Backbone</div>
</div>
<p id="backbonerouter"><code class="code">Backbone.Router</code> allows you to update the location bar when the user selects different views, or create actions that get triggered in response to the user navigating to a given URL. This is the primary responsibility of controllers on the server side, because URLs are generally the only way for the user to communicate with a server-side application. That's not the case in a client-side application.</p>
<p id="backboneview_i"><code class="code">Backbone.View</code> is responsible for encapsulating view logic, such as how and when to display information. Views typically listen for DOM events, translate them into some intended action, and then emit events that other modules can subscribe to.</p>
<div class="warning" id="its_common_to__id2"><p id="its_common_to__id3">It's common to see views directly update models, collections, and routers, but when they do, it is a slippery slope. Often, developers get confused and start to put too much business logic in the view, which breaks the separation of concerns, and leads to code duplication and hard to find bugs across multiple views which need to share the same business rules. Instead, views should only manage the presentation concerns, and trigger events that other modules can listen for.</p></div>
<p id="backbonemodel_"><code class="code">Backbone.Model</code> is responsible for encapsulating state and business logic. When state changes, it emits events that views can subscribe to.</p>
<p id="backbonecollec"><code class="code">Backbone.Collection</code> is an extremely useful abstraction that provides a managed way of dealing with collections of models, complete with Underscore's many functional methods, which you can use to query, filter, and sort your collections.</p>
<p id="as_youve_alrea">As you've already seen in the event examples, there are alternative ways to stitch Backbone's tools together. For example, for a an almost entirely decoupled implementation, you can route most of the communication through an event aggregator. That might look something like this:</p>
<div class="figure" id="backbone_with_event_aggregator">
<div class="figure-contents"><div class="mediaobject"><table style="border: 0; width: 432; cellpadding: 0; cellspacing: 0;"><tr><td><img style="width: 432; " src="http://orm-chimera-prod.s3.amazonaws.com/1234000000262/figs/0603.png" alt="Backbone With Event Aggregator"></td></tr></table></div></div>
<div class="figure-title">Figure 6-3. Backbone With Event Aggregator</div>
</div>
<p id="the_solid_lines">The solid lines represent direct references. Dashed lines represent event listeners. As you can see, with this setup, you don't need a lot of direct references, which allows your modules to be a lot less coupled. Views listen for state changes and view selection events, and emits user action events. The Router listens for user route selections, and emits route change events. Collections listen for add and remove events, and relay change events from the model. The model listens for UI input changes and emits change events.</p>
<p id="this_is_the_pat">This is the pattern you'll see developing in the examples, but it's certainly not the only way to handle separation of concerns in the browser.  </p>
<p id="there_are_many__id2">There are many other MV* alternatives, including MVP, MVVM, RVP, etc... I'll leave it to you and Google to work out how all of them differ. The important thing to understand is that all of them exist to allow the separation of presentation logic and business domain logic. In short, your business logic should not be mixed in with your presentation logic and vice verse. You can explore various libraries frameworks at <a class="ulink" href="http://todomvc.com/" target="_top">TodoMVC.com</a>.</p>
</div>
<div class="sect2" id="presentation_and_dom_manipulation">
<div class="titlepage"><div><div><h3 class="title">Presentation and DOM Manipulation</h3></div></div></div>
<p id="the_primary_pur_id2">The primary purpose of a view in Backbone is to present the application's interface to the user and react to user input. As such, every Backbone view should be associated with some DOM. Backbone handles that association with the <code class="code">.el</code> and <code class="code">.$el</code> properties. The <code class="code">.el</code> property is a direct reference to the view's root element, while <code class="code">.$el</code> is a cached jQuery or Zepto object for the view's element.</p>
<p id="consider_the_fo">Consider the following from <code class="code">guestlistview.js</code>:</p>
<div class="example" id="creating_a_backbone_view">
<div class="example-title">Example 6-4. Creating a Backbone View</div>
<div class="example-contents"><pre class="programlisting" data-language="js" id="define_the_b_id1"><code class="c1">// Define the backbone view.</code>
<code class="nx">GuestlistView</code> <code class="o">=</code> <code class="nx">View</code><code class="p">.</code><code class="nx">extend</code><code class="p">({</code>
  <code class="nx">tagName</code><code class="o">:</code> <code class="s1">'ol'</code><code class="p">,</code>
  <code class="nx">id</code><code class="o">:</code> <code class="s1">'guestlist-view'</code><code class="p">,</code>
  <code class="nx">className</code><code class="o">:</code> <code class="nx">listClass</code><code class="p">,</code>
  <code class="nx">initialize</code><code class="o">:</code> <code class="nx">delegate</code><code class="p">,</code>
  <code class="nx">render</code><code class="o">:</code> <code class="nx">render</code>
<code class="p">}),</code></pre></div>
</div>
<p id="if_specified_b">If specified, Backbone.View will construct <code class="code">this.el</code> using the <code class="code">tagName</code>, <code class="code">className</code>, <code class="code">id</code>, and <code class="code">attributes</code> parameters. If you don't specify a <code class="code">tagName</code>, it will create a <code class="code">div</code>. You can also attach the view to an existing element by passing in a value for <code class="code">.el</code>.</p>
<div class="sect3" id="view_events">
<div class="titlepage"><div><div><h4 class="title">View Events</h4></div></div></div>
<p id="backbone_lets_y">Backbone lets you pass in an events hash to declaratively specify event handlers. The hash takes the form, <code class="code">{ 'eventName selector': 'callback' }</code>. If <code class="code">'callback'</code> is a string, it will map to the method on the view object that matches the name. You can also pass an inline function or function reference. Backbone uses jQuery's <code class="code">.on()</code> method, and delegates events to the view's root element (<code class="code">this.el</code>) by default. If you omit the selector, the root element will be the target element.</p>
<div class="warning" id="leaving_off_the_id1"><p id="leaving_off_the_id2">Leaving off the selector is probably a code smell. Could you be delegating events to a parent element, instead?</p></div>
<div class="sect4" id="event_delegation">
<div class="titlepage"><div><div><h5 class="title">Event Delegation</h5></div></div></div>
<p id="event_delegatio"><em class="firstterm">Event delegation</em> is the process of aggregating events from multiple sources to a single event handling mechanism. It's common to encounter large collections which share the same  event handlers, but attach different listeners for each item in the collection.</p>
<p id="for_example_it">For example, it might have been tempting to implement the guest list item as a separate view, and then rerender the guest template every time the status changed. That might look something like this:</p>
<pre class="programlisting" data-language="js" id="render__functi_id1"><code class="nx">render</code> <code class="o">=</code> <code class="kd">function</code> <code class="nx">render</code><code class="p">(</code><code class="nx">data</code><code class="p">)</code> <code class="p">{</code>
  <code class="kd">var</code> <code class="nx">$el</code> <code class="o">=</code> <code class="k">this</code><code class="p">.</code><code class="nx">$el</code><code class="p">;</code>

  <code class="c1">// Prevent memory leaks in rerender cases.</code>
  <code class="nx">$el</code><code class="p">.</code><code class="nx">off</code><code class="p">(</code><code class="s1">'click.'</code> <code class="o">+</code> <code class="k">this</code><code class="p">.</code><code class="nx">className</code><code class="p">);</code>
  <code class="nx">$el</code><code class="p">.</code><code class="nx">empty</code><code class="p">();</code>

  <code class="nx">processTemplate</code><code class="p">(</code><code class="nx">$el</code><code class="p">,</code> <code class="nx">data</code><code class="p">);</code>

  <code class="c1">// Reattach listener.</code>
  <code class="nx">$el</code><code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s1">'click.'</code> <code class="o">+</code> <code class="k">this</code><code class="p">.</code><code class="nx">className</code><code class="p">,</code> <code class="nx">handleClick</code><code class="p">);</code>

  <code class="k">return</code> <code class="k">this</code><code class="p">;</code>
<code class="p">};</code></pre>
<p id="note_that_this_">Note that this is essentially equivalent to passing an <code class="code">events</code> hash to Backbone in the hypothetical guests <code class="code">View.extend()</code>:</p>
<pre class="programlisting" data-language="js" id="events__clic"><code class="nx">events</code><code class="o">:</code> <code class="p">{</code>
  <code class="s1">'click'</code><code class="o">:</code> <code class="nx">handleClick</code>
<code class="p">}</code> </pre>
<p id="note_that_backb">Note that Backbone automatically delegates using jQuery's <code class="code">.on()</code> method, however, passing a hash like this into an item-level view negates that capability. Instead, it will wire up a separate click handler for each list item.</p>
<p id="this_approach_s">This approach slows down the application in two ways: First, it takes longer to initialize, because of the extra wiring that must be performed for each event handler, for each item. It also consumes more memory, particularly if you chose the inline method to specify the event handler. If you do that, there will actually be a separate copy of the event handler function for each item.</p>
<p id="you_should_be_a">You should be aware that you can leak memory if you bind event handlers to each item in a dynamic collection. For example, if you have a collection which utilizes the infinite scroll technique, you'll need to remove elements from the DOM as they scroll out of view to prevent browser performance issues or crashes. You must remember to remove the event listeners when you remove the items from the DOM. Backbone views have a <code class="code">.remove()</code> method which will remove both the DOM listeners, and stop the view from listening for events from other objects.</p>
<p id="youve_already_">You've already seen event delegation employed in the <code class="code">guestlistview.js</code> <code class="code">delegate()</code> function. Now you'll use the built in <code class="code">Backbone.View</code> events hash to handle it, instead. Here's what the delegation looked like before:</p>
<pre class="programlisting" data-language="js" id="from_the_del"><code class="c1">// From the delegate() function:</code>
<code class="c1">// Delegate all click events to the parent element.</code>
<code class="k">this</code><code class="p">.</code><code class="nx">$el</code><code class="p">.</code><code class="nx">on</code><code class="p">(</code><code class="s1">'click'</code><code class="p">,</code> <code class="s1">'.'</code> <code class="o">+</code> <code class="nx">guestClass</code><code class="p">,</code> <code class="nx">relayClick</code><code class="p">);</code></pre>
<p id="youll_pull_tha">You'll pull that code out of the delegate() function, and let Backbone handle it for you:</p>
<pre class="programlisting" data-language="js" id="define_the_b_id2"><code class="c1">// Define the backbone view.</code>
<code class="nx">GuestlistView</code> <code class="o">=</code> <code class="nx">View</code><code class="p">.</code><code class="nx">extend</code><code class="p">({</code>
  <code class="nx">tagName</code><code class="o">:</code> <code class="s1">'ol'</code><code class="p">,</code>
  <code class="nx">id</code><code class="o">:</code> <code class="s1">'guestlist-view'</code><code class="p">,</code>
  <code class="nx">className</code><code class="o">:</code> <code class="nx">listClass</code><code class="p">,</code>
  <code class="nx">initialize</code><code class="o">:</code> <code class="nx">delegate</code><code class="p">,</code>
  <code class="nx">render</code><code class="o">:</code> <code class="nx">render</code><code class="p">,</code>

  <code class="c1">// Add the handler to the view object:</code>
  <code class="nx">relayClick</code><code class="o">:</code> <code class="nx">relayClick</code><code class="p">,</code>

  <code class="c1">// Let Backbone handle the event delegation:</code>
  <code class="nx">events</code><code class="o">:</code> <code class="p">{</code>
    <code class="s1">'click .guest'</code><code class="o">:</code> <code class="s1">'relayClick'</code>
  <code class="p">}</code>
<code class="p">}),</code></pre>
<p id="by_delegating_t_id3">By delegating the <code class="code">click</code> to the parent element, instead of to each list item, only one listener has to be attached per behavior, rather than one per behavior for each item in the list. What's more, you don't have to worry about removing the listener and adding it again if you need to render a list item again.  In short, less code to write, and less risk of memory leaks.</p>
<p id="bonus_when_you">Bonus: When you expose your event handlers on the view object, it makes them easier to unit test, because you don't have to figure out how to simulate the events in order to invoke the handlers. Keep in mind that events are a part of the API surface area, and event handlers should be tested, just like public methods.</p>
<div class="warning" id="if_you_implemen_id1"><p id="if_you_implemen_id2">If you implement list items as sub views, you still need to remember to call the item's <code class="code">.remove()</code> method as the item scrolls away, because you still need to stop the view from listening to Backbone events. If you wire up any other kind of event listener (such as an app-level event aggregator), you should remember to remove those listeners, as well.</p></div>
</div>
</div>
<div class="sect3" id="id_d1e31975">
<div class="titlepage"><div><div><h4 class="title">Templates</h4></div></div></div>
<p id="templates_help_">Templates help to separate display structure concerns from logic. Templates define the structure of your UI, along with some indication of where data should be injected. Templates can be reused with a variety of different data. A template processor combines data and templates to produce the DOM output that will be rendered to the screen.</p>
<p id="its_common_for_id1"></p>
<div class="warning" id="its_common_for_id2"><p id="its_common_for_id3">It's common for template languages to support limited logic, such as if / else statements. I recommend that you avoid the temptation to use any of them,  because they defeat the purpose of separating DOM structure from logic concerns -- instead, your logic just lives somewhere else. Even worse, your logic lives in two places, and it's even harder to find the source of bugs.</p></div>
<p id="there_are_lots_">There are lots of different options for template rendering. Some common choices include Jade, Mustache, Haml, EJS,  Plates and Pure. Plates (a Flatiron library) and Pure provide the ability to write templates in pure HTML, with no specialized DSL mixed in at all. Data gets associated via css-style selectors in the JavaScript view layer. Backbone relies on the Underscore library, which happens to include a simple template engine. For the sake of simplicity and familiarity, you'll see it used in the examples.</p>
<p id="lets_revisit_t">Let's revisit the guestlist view and replace the inline HTML with a template.</p>
<p id="before">Before:</p>
<pre class="programlisting" id="li_class__id1">'&lt;li class="' + guestClass +
  '" ' +  'id="' + guest.id +'"&gt;' +
  '&lt;span class="name"&gt;' + guest.name +
  '&lt;/span&gt;&lt;/li&gt;'</pre>
<p id="after">After:</p>
<pre class="programlisting" id="li_class__id2">&lt;li class="&lt;%= guestClass %&gt;" id="&lt;%= id %&gt;"&gt;
  &lt;span class="name"&gt;&lt;%= name %&gt;&lt;/span&gt;
&lt;/li&gt;</pre>
<p id="even_better_no">Even better, now that it isn't expressed in a JavaScript string, it's obvious that it doesn't belong in the JavaScript view layer at all. For a template this small, it wouldn't do any harm to simply embed it in the HTML for the page. You can do that using a script tag:</p>
<pre class="programlisting" id="script_idgue">&lt;script id="guest" type="text/template"&gt;
  &lt;li class="&lt;%= guestClass %&gt;" id="&lt;%= id %&gt;"&gt;
    &lt;span class="name"&gt;&lt;%= name %&gt;&lt;/span&gt;
  &lt;/li&gt;
&lt;/script&gt;</pre>
<div class="tip" id="unless_the_temp_id1"><p id="unless_the_temp_id2">Unless the templates are tiny (a few lines), most templates should be in dedicated files. You may want to group them with corresponding views in the directory hierarchy. You can use a build step to pull templates into your HTML, or for templates that are only used rarely, fetch them as needed via AJAX.</p></div>
<p id="if_youre_using">If you're using a module system that doesn't pollute the global namespace, you'll need to explicitly require Underscore in order to access the template utility. If you're just including Backbone stand-alone, you don't need to do anything special to use Underscore's methods. Just use <code class="code">_.template()</code> directly. In this case, Browserify will not leak dependencies into the global namespace, so you'll need to require it. In <code class="code">guestlistview.js</code>, you'll insert the <code class="code">require()</code> line like this:</p>
<pre class="programlisting" data-language="js" id="assign_backb"><code class="c1">// Assign Backbone.View to the View var.</code>
<code class="nx">View</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'backbone-browserify'</code><code class="p">).</code><code class="nx">View</code><code class="p">,</code>

<code class="c1">// Grab the template utility from Underscore.</code>
<code class="nx">template</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'underscore'</code><code class="p">).</code><code class="nx">template</code><code class="p">,</code></pre>
<p id="of_course_this">Of course, this isn't going to work until we add Underscore to <code class="code">package.json</code>:</p>
<pre class="programlisting" id="underscore_">"underscore": "*",</pre>
<p id="save_the_file_">Save the file, and run:</p>
<pre class="programlisting" data-language="console" id="npm_install_id2"><code class="gp">$</code> npm install</pre>
<p id="now_that_the_de">Now that the dependency is there, it's time to add the template code. Underscore lets you compile your HTML templates into an executable function in order to speed up template processing. You can do that near the top of the <code class="code">render()</code> function so that it doesn't need to be called for every guest that gets rendered:</p>
<div class="example" id="render_with_template">
<div class="example-title">Example 6-5. render() with Template</div>
<div class="example-contents"><pre class="programlisting" data-language="js" id="render__functi_id2"><code class="nx">render</code> <code class="o">=</code> <code class="kd">function</code> <code class="nx">render</code><code class="p">(</code><code class="nx">guestlist</code><code class="p">)</code> <code class="p">{</code>
  <code class="kd">var</code> <code class="nx">$el</code> <code class="o">=</code> <code class="k">this</code><code class="p">.</code><code class="nx">$el</code><code class="p">,</code>

    <code class="c1">// Compile the guest template.</code>
    <code class="nx">guestTemplate</code> <code class="o">=</code> <code class="nx">template</code><code class="p">(</code><code class="nx">$</code><code class="p">(</code><code class="s1">'#guestTemplate'</code><code class="p">).</code><code class="nx">html</code><code class="p">());</code>

  <code class="nx">$el</code><code class="p">.</code><code class="nx">empty</code><code class="p">();</code>


  <code class="c1">// Loop over the passed-in guest models and render</code>
  <code class="c1">// them as li elements.</code>
  <code class="nx">guestlist</code><code class="p">.</code><code class="nx">forEach</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">guestModel</code><code class="p">)</code> <code class="p">{</code>
    <code class="kd">var</code> <code class="nx">guest</code><code class="p">;</code>

    <code class="c1">// Build the data object to pass into the template.</code>
    <code class="nx">guest</code> <code class="o">=</code> <code class="nx">guestModel</code><code class="p">.</code><code class="nx">toJSON</code><code class="p">();</code>

    <code class="c1">// Add the guestClass to the data object.</code>
    <code class="nx">guest</code><code class="p">.</code><code class="nx">guestClass</code> <code class="o">=</code> <code class="nx">guestClass</code><code class="p">;</code>

    <code class="c1">// Process the template data and append the output to the</code>
    <code class="c1">// list element.</code>
    <code class="nx">$el</code><code class="p">.</code><code class="nx">append</code><code class="p">(</code><code class="nx">guestTemplate</code><code class="p">(</code><code class="nx">guest</code><code class="p">));</code>
  <code class="p">});</code>

  <code class="k">return</code> <code class="k">this</code><code class="p">;</code>
<code class="p">}</code>
</pre></div>
</div>
<p id="remember_to_run">Remember to run <code class="code">grunt</code> to rebuild the project files, or set up a <code class="code">grunt watch</code> task to build on file save.  The tests should pass again. Having the lint and unit test tasks set up makes it easy to refactor like this with confidence, because you'll catch any mistakes early.</p>
</div>
<div class="sect3" id="web_components">
<div class="titlepage"><div><div><h4 class="title">Web Components</h4></div></div></div>
<p id="web_components__id1"><em class="firstterm">Web Components</em> are a new standard way of creating reusable components and widgets with JavaScript, HTML, and CSS. The new standards currently lack widespread browser support, but may soon transform the way we write reusable components for JavaScript applications.</p>
<div class="tip" id="shadow_dom__cu_id1"><p id="shadow_dom__cu_id2">Shadow DOM + Custom elements = Web Components.</p></div>
<p id="web_components__id2">Web Components use a technology called <em class="firstterm">Shadow DOM</em>, which allows you to hide an entirely new document context, including HTML, CSS, and JavaScript. Shadow DOM is completely encapsulated from the main document. It gets its own document root (called <em class="firstterm">shadow root</em>), and its own execution context for JavaScript. Shadow DOM is also minimally affected by the CSS on the parent page. The DOM encapsulation features should feel familiar to anyone who has used iframes for encapsulation purposes.</p>
<p id="your_shadow_dom">Your shadow DOM can be made up of many other HTML elements, but they won't be visible in the DOM tree unless you specifically enable shadow DOM viewing in a debugger, such as Chrome Developer Tools.</p>
<p id="custom_tags_are"><em class="firstterm">Custom tags</em> are an important aspect of web components which allow you to simplify your DOM and write more semantic HTML. For example, if you need to create a knob widget,  you can create a  component called <code class="code">&lt;x-knob&gt;</code>, which reads a lot better than <code class="code">&lt;div class="knob"&gt;</code>. Custom tags can use prototypal inheritance to inherit the properties of other tags. You can simplify the creation of <code class="code">&lt;x-knob&gt;</code> by sharing the prototype  from <code class="code">&lt;input&gt;</code>, and setting some default properties (for example, by selecting <code class="code">type="range"</code>). Use the new DOM method, <code class="code">document.register()</code> to define the element.</p>
<p id="heres_how_you__id3">Here's how you might define <code class="code">&lt;x-knob&gt;</code> using the <code class="code">document.register()</code> polyfill from Mozilla Web Components:</p>
<div class="example" id="documentregister">
<div class="example-title">Example 6-6. document.register()</div>
<div class="example-contents"><pre class="programlisting" data-language="js" id="documentregist"><code class="nb">document</code><code class="p">.</code><code class="nx">register</code><code class="p">(</code><code class="s1">'x-knob'</code><code class="p">,</code> <code class="p">{</code>

  <code class="s1">'prototype'</code><code class="o">:</code> <code class="nb">Object</code><code class="p">.</code><code class="nx">create</code><code class="p">(</code> <code class="p">(</code><code class="nb">window</code><code class="p">.</code><code class="nx">HTMLInputElement</code> <code class="o">||</code>
    <code class="nb">window</code><code class="p">.</code><code class="nx">HTMLSpanElement</code> <code class="o">||</code> <code class="nb">window</code><code class="p">.</code><code class="nx">HTMLElement</code><code class="p">).</code><code class="nx">prototype</code> <code class="p">),</code>

  <code class="s1">'lifecycle'</code><code class="o">:</code> <code class="p">{</code>

    <code class="nx">created</code><code class="o">:</code> <code class="kd">function</code><code class="p">(</code><code class="nx">proto</code><code class="p">)</code> <code class="p">{</code>
      <code class="k">this</code><code class="p">.</code><code class="nx">type</code><code class="o">=</code><code class="s1">'range'</code><code class="p">;</code>
      <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'x-knob created'</code><code class="p">,</code> <code class="k">this</code><code class="p">);</code>
    <code class="p">},</code>

    <code class="nx">inserted</code><code class="o">:</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
      <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'x-knob inserted'</code><code class="p">,</code> <code class="k">this</code><code class="p">);</code>
    <code class="p">},</code>

    <code class="nx">removed</code><code class="o">:</code> <code class="kd">function</code><code class="p">()</code> <code class="p">{</code>
      <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'x-knob removed'</code><code class="p">,</code> <code class="k">this</code><code class="p">);</code>
    <code class="p">},</code>

    <code class="nx">attributeChanged</code><code class="o">:</code> <code class="kd">function</code><code class="p">(</code><code class="nx">attr</code><code class="p">,</code> <code class="nx">value</code><code class="p">)</code> <code class="p">{</code>
      <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'x-knob attributeChanged'</code><code class="p">,</code> <code class="k">this</code><code class="p">,</code> <code class="nx">attr</code><code class="p">,</code> <code class="nx">value</code><code class="p">);</code>
    <code class="p">}</code>

  <code class="p">}</code>
<code class="p">});</code>

      </pre></div>
</div>
<p id="now_that_you_ha">Now that you have a definition, you can instantiate it with:</p>
<pre class="programlisting" data-language="js" id="var_knob__docu"><code class="kd">var</code> <code class="nx">knob</code> <code class="o">=</code> <code class="nb">document</code><code class="p">.</code><code class="nx">createElement</code><code class="p">(</code><code class="s1">'x-knob'</code><code class="p">);</code></pre>
<p id="take_a_closer_l">Take a closer look at what happens:</p>
<div class="example" id="custom_tag_tests">
<div class="example-title">Example 6-7. Custom Tag Tests</div>
<div class="example-contents"><pre class="programlisting" data-language="js" id="function__"><code class="nx">$</code><code class="p">(</code><code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>

  <code class="nx">test</code><code class="p">(</code><code class="s1">'document.register()'</code><code class="p">,</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>

    <code class="nx">equal</code><code class="p">(</code><code class="k">typeof</code> <code class="nb">document</code><code class="p">.</code><code class="nx">register</code><code class="p">,</code> <code class="s1">'function'</code><code class="p">,</code>
      <code class="s1">'Should exist.'</code><code class="p">);</code>

  <code class="p">});</code>

  <code class="nx">test</code><code class="p">(</code><code class="s1">'document.createElement("x-knob")'</code><code class="p">,</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
    <code class="kd">var</code> <code class="nx">knob</code> <code class="o">=</code> <code class="nb">document</code><code class="p">.</code><code class="nx">createElement</code><code class="p">(</code><code class="s1">'x-knob'</code><code class="p">);</code>

    <code class="nx">ok</code><code class="p">(</code><code class="nx">knob</code><code class="p">.</code><code class="nx">getAttribute</code><code class="p">,</code>
      <code class="s1">'should produce a custom element.'</code><code class="p">);</code>
  <code class="p">});</code>

  <code class="nx">test</code><code class="p">(</code><code class="s1">'x-knob inheritance'</code><code class="p">,</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
    <code class="kd">var</code> <code class="nx">knob</code> <code class="o">=</code> <code class="nb">document</code><code class="p">.</code><code class="nx">createElement</code><code class="p">(</code><code class="s1">'x-knob'</code><code class="p">);</code>

    <code class="nx">ok</code><code class="p">(</code><code class="nx">knob</code><code class="p">.</code><code class="nx">checkValidity</code><code class="p">,</code>
      <code class="s1">'should inherit from input element.'</code><code class="p">);</code>
  <code class="p">});</code>

  <code class="nx">test</code><code class="p">(</code><code class="s1">'x-knob input type'</code><code class="p">,</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
    <code class="kd">var</code> <code class="nx">knob</code> <code class="o">=</code> <code class="nb">document</code><code class="p">.</code><code class="nx">createElement</code><code class="p">(</code><code class="s1">'x-knob'</code><code class="p">);</code>

    <code class="nx">equal</code><code class="p">(</code><code class="nx">knob</code><code class="p">.</code><code class="nx">type</code><code class="p">,</code> <code class="s1">'range'</code><code class="p">,</code>
      <code class="s1">'should have type="range".'</code><code class="p">);</code>
  <code class="p">});</code>

<code class="p">});</code>
</pre></div>
</div>
<p id="as_exciting_as_">As exciting as all this is, it's still bleeding edge. There is currently disagreement in the community about this mechanism, arguing that if we go down this road, we'll lose a lot of the semantic meaning that the community has pushed so hard for. Ian Hickson argues along these lines:</p>
<p id="wouldnt_it_be_">Wouldn't it be better to add a new attribute so that we can preserve the semantics of existing elements? For example: <code class="code">&lt;input is="knob" type="range"&gt;</code>. An obvious counter argument is that popular tags will become part of the semantic vernacular, and that agents will begin to recognize them, just as they recognize the semantics of many metadata formats, and many semantic extensions built on top of vanilla HTML. Another counter argument is that many custom elements will not have meaningful base elements whose semantics would be useful to build on. </p>
<p id="as_of_this_writ_id2">As of this writing, none of these features are available for production use if you want solid cross-browser support. Mozilla has created a <a class="ulink" href="http://github.com/mozilla/web-components" target="_top">custom tag polyfill</a> that you can experiment with today for non-production use. There is a small movement to create a library of GUI components using the current state of the web components specification and the Mozilla Web Components polyfill.</p>
</div>
</div>
</div>
<div class="sect1" data-original-filename="ch06.xml" id="server_side_concerns">
<div class="titlepage"><div><div><h2 class="title">Server Side Concerns</h2></div></div></div>
<p id="there_was_a_tim">There was a time when the server side did a lot of work, but that time has come and gone in the world of JavaScript applications. Many current JavaScript applications defer most of the rendering and  business logic to the client. For most apps, the server side will look something like this:</p>
<p id="para_id4"> </p>
<div class="orderedlist" id="restful_or_rest_id1"><ol class="orderedlist" type="1">
<li class="listitem"><p id="restful_or_rest_id2">RESTful or REST-like API.</p></li>
<li class="listitem"><p id="static_fileser">Static file-server.</p></li>
<li class="listitem"><p id="a_singlepage_i">A single-page index route that pre-injects data for the initial page load. (This can be replaced by the static file server if you defer the page data to a subsequent AJAX request).</p></li>
</ol></div>
<p id="there_are_many__id3">There are many ways to accomplish these goals, but you should have little trouble finding alternatives via Google. In this section, you'll learn how to get the job done with Node and Express.</p>
<div class="sect2" id="getting-started-with-node-and-express">
<div class="titlepage"><div><div><h3 class="title">Getting Started With Node and Express</h3></div></div></div>
<p id="node_is_a_serve">
      Node is a server-side JavaScript environment with many attractive
      features:
    </p>
<div class="itemizedlist" id="a_fast_javascri_id1"><ul class="itemizedlist">
<li class="listitem"><p id="a_fast_javascri_id2">
          A fast JavaScript engine (built on V8).
        </p></li>
<li class="listitem"><p id="asynchronous_by">
          Asynchronous by default philosophy (nothing should block).
        </p></li>
<li class="listitem"><p id="eventloop_desi">
          Event-loop design (much like the browser environment).
        </p></li>
<li class="listitem"><p id="networking_as_a">
          Networking as a first class citizen (create production capable
          servers with few lines of code).
        </p></li>
<li class="listitem"><p id="a_highly_usable">
          A highly usable streams API.
        </p></li>
<li class="listitem"><p id="a_large_rapidl">
          A large, rapidly growing developer community.
        </p></li>
<li class="listitem"><p id="a_simple_commo">
          A simple, CommonJS-based module solution that guarantees
          module encapsulation (your var declarations are limited to
          module scope).
        </p></li>
<li class="listitem"><p id="a_developer_fri">
          A developer friendly package management system with thousands
          of open-source packages to choose from.
        </p></li>
</ul></div>
<p id="some_of_these_f">
      Some of these features might take some getting used to if you are
      accustomed to server-side environments that allow features such as
      blocking IO and a single thread per connection (for convenient
      state management). However, you'll find that the incredible
      performance boost achieved by non-blocking request/response cycles
      is well worth the learning effort.
    </p>
<p id="dont_underesti">
      Don't underestimate the value of the asynchronous by default
      philosophy. That is the key to Node's incredible performance in
      production environments.
    </p>
<p id="where_other_env">
      Where other environments force users to wait in line while files
      load or network operations take place, Node fires off the request
      and keeps accepting new connections and executing other code paths
      while the asynchronous event does its work in the background.
    </p>
<p id="processes_can_s">
      Processes can spend an incredible amount of time waiting for file
      reads and network requests, especially if they encounter an error.
      Node just keeps cruising along. It's like getting out of congested
      city streets with stop lights at every block and on to an open
      freeway.
    </p>
<p id="node_isnt_fast">
      Node isn't fast simply because of the performance of the V8
      JavaScript engine (though that does help). It's fast because it
      doesn't waste time waiting around for things to happen. There are
      other platforms that share some of JavaScript's performance
      characteristics: Twisted Python and Tornado spring to mind.
      They're fast for the same reason. However, even though they are
      more mature, they can't compete with the active membership of the
      JavaScript developer community.
    </p>
<p id="node_comes_pack">
      Node comes packaged with a module management solution called npm.
      It gives you access to a package registry stocked with thousands
      of open-source packages, and makes it very easy for you to
      contribute your own, or use a private git repository for
      proprietary work. Of course, it's easy to mix and match
      open-source and proprietary packages in a single application.
    </p>
<div class="sect3" id="installing-node-and-express">
<div class="titlepage"><div><div><h4 class="title">Installing Node and Express</h4></div></div></div>
<p id="first_make_sur">
        First, make sure you have node installed. There are installers
        available from the <a class="ulink" href="http://nodejs.org" target="_top">Node homepage</a>, but I like to use <code class="literal">nvm</code> so
        that I can easily switch between different versions of node. To
        install node with <code class="literal">nvm</code>:
      </p>
<pre class="programlisting" data-language="console" id="curl_https">
<code class="gp">$</code> curl https://raw.github.com/creationix/nvm/master/install.sh | sh
</pre>
<p id="for_more_on_nvm">
        For more on <code class="literal">nvm</code>, check out the docs on the
        <a class="ulink" href="https://github.com/creationix/nvm" target="_top">Github repository</a>. With node installed, you'll need to create a
        new directory for your project:
      </p>
<pre class="programlisting" data-language="console" id="mkdir_myfirs">
<code class="gp">$</code> mkdir my-first-project
<code class="gp">$</code> <code class="nb">cd </code>my-first project
</pre>
<p id="then_initialize">
        Then initialize your project:
      </p>
<pre class="programlisting" data-language="console" id="npm_init">
<code class="gp">$</code> npm init
</pre>
<p id="express_is_curr">
        Express is currently the most popular application framework for
        Node. It's easy to learn and use, and it has a vibrant developer
        community. If you're going to build applications in Node,
        chances are you'll eventually use express. There's no time like
        the present to get started. Install express:
      </p>
<pre class="programlisting" data-language="console" id="npm_install_">
<code class="gp">$</code> npm install --save express
</pre>
<p id="thats_it_you">
        That's it. You're ready to get started!
      </p>
<p id="if_this_is_your_id2">
        If this is your first time using Node and Express, it might be
        helpful to see what some of the community believes are the
        current set of best practices.
        <a class="ulink" href="https://github.com/inadarei/nodebootstrap" target="_top">Node Bootstrap</a> aims to show new users some common practices
        in the Node / Express community, using Twitter Bootstrap. Among
        other things, there's an example of using the cluster module to
        manage multiple instances of the server (utilizing all available
        CPU cores).
      </p>
</div>
<div class="sect3" id="organizing-files-in-node">
<div class="titlepage"><div><div><h4 class="title">Organizing Files in Node</h4></div></div></div>
<p id="its_a_good_ide">
        It's a good idea to follow the emerging file organization trends
        in existing, popular Node repositories. That way, anybody
        familiar with Node should be able to find their way around your
        repository. Here are some common file locations:
      </p>
<div class="itemizedlist" id="main_indexjs_id1"><ul class="itemizedlist">
<li class="listitem"><p id="main_indexjs_id2">
            Main <code class="literal">./index.js</code>,
            <code class="literal">./server.js</code>, or
            <code class="literal">./yourentryfile.js</code> in the root.
          </p></li>
<li class="listitem"><p id="supporting_file">
            Supporting files in <code class="literal">./lib/</code>
          </p></li>
<li class="listitem"><p id="static_http_fil">
            Static http files in <code class="literal">./public/</code>
          </p></li>
<li class="listitem"><p id="views_or_templa">
            Views or templates in <code class="literal">./views/</code>
          </p></li>
<li class="listitem"><p id="commandline_ex">
            Command-line executables in <code class="literal">./bin/</code>
          </p></li>
<li class="listitem"><p id="tests_in_test">
            Tests in <code class="literal">./test/</code> (or
            <code class="literal">./spec/</code> if you`re a jasmine cool-aid
            drinker)
          </p></li>
<li class="listitem"><p id="npm_scripts_in_">
            Npm Scripts in <code class="literal">./scripts/</code>
          </p></li>
<li class="listitem"><p id="config_in_con">
            Config in <code class="literal">./config/</code>
          </p></li>
<li class="listitem"><p id="documentation_i">
            Documentation in <code class="literal">./doc/</code>
          </p></li>
<li class="listitem"><p id="examples_in_e">
            Examples in <code class="literal">./examples/</code>
          </p></li>
<li class="listitem"><p id="performance_ana">
            Performance analysis in <code class="literal">./benchmarks/</code>
          </p></li>
<li class="listitem"><p id="native_c__c_">
            Native c / c++ source in <code class="literal">./source/</code>
          </p></li>
</ul></div>
<p id="the_npm_reposit">
        The <a class="ulink" href="https://github.com/isaacs/npm" target="_top">npm repository</a> serves as a good example.
      </p>
</div>
<div class="sect3" id="node-libraries">
<div class="titlepage"><div><div><h4 class="title">Node Libraries</h4></div></div></div>
<p id="some_of_my_favo">
        Some of my favorite Node libraries include:
      </p>
<div class="itemizedlist" id="mout_like_under_id1"><ul class="itemizedlist">
<li class="listitem"><p id="mout_like_under_id2">
            <a class="ulink" href="http://moutjs.com/" target="_top">Mout</a> Like Underscore
            / LoDash. Stuff that should probably be included in
            JavaScript.
          </p></li>
<li class="listitem"><p id="express_web_app">
            <a class="ulink" href="http://expressjs.com/" target="_top">Express</a> Web
            application framework.
          </p></li>
<li class="listitem"><p id="nconf_applicati">
            <a class="ulink" href="https://github.com/flatiron/nconf" target="_top">Nconf</a>
            Application config.
          </p></li>
<li class="listitem"><p id="hogan_mustache_">
            <a class="ulink" href="http://twitter.github.com/hogan.js/" target="_top">Hogan</a>
            Mustache for express.
          </p></li>
<li class="listitem"><p id="superagent_comm">
            <a class="ulink" href="https://github.com/visionmedia/superagent" target="_top">Superagent</a>
            Communicate with APIs.
          </p></li>
<li class="listitem"><p id="socketio_realt">
            <a class="ulink" href="http://socket.io/" target="_top">Socket.io</a> Realtime
            communications (websockets).
          </p></li>
<li class="listitem"><p id="q_promises">
            <a class="ulink" href="https://github.com/kriskowal/q" target="_top">Q</a>
            Promises.
          </p></li>
<li class="listitem"><p id="async_asynchron">
            <a class="ulink" href="https://github.com/caolan/async" target="_top">Async</a>
            Asynchronous functional utilities.
          </p></li>
<li class="listitem"><p id="bunyan_logging">
            <a class="ulink" href="https://github.com/trentm/node-bunyan" target="_top">Bunyan</a>
            Logging.
          </p></li>
<li class="listitem"><p id="tape_testing">
            <a class="ulink" href="https://github.com/substack/tape" target="_top">Tape</a>
            Testing.
          </p></li>
<li class="listitem"><p id="cuid_better_tha">
            <a class="ulink" href="http://usecuid.org/" target="_top">Cuid</a> Better than
            guid/uuid for web applications.
          </p></li>
<li class="listitem"><p id="derbyjs_add_re">
            <a class="ulink" href="http://derbyjs.com/" target="_top">Derby.js</a> Add
            realtime, collaborative MVC to express.
          </p></li>
<li class="listitem"><p id="nodehttpproxy">
            <a class="ulink" href="https://github.com/nodejitsu/node-http-proxy" target="_top">Node-http-proxy</a>
            Proxy your service APIs.
          </p></li>
</ul></div>
</div>
<div class="sect3" id="configuration">
<div class="titlepage"><div><div><h4 class="title">Configuration</h4></div></div></div>
<p id="dont_include_c">
        Don't include configuration data in your app repository
        (including secrets, paths to file locations, server hostnames,
        etc..). Instead, set up environment files with examples for sane
        defaults. Check in the examples, but don't check in the actual
        configuration. Following this rule of thumb will make deployment
        / ops support for the app a lot easier. Check an example file
        into your app repo: <code class="literal">s3.env.example</code>
      </p>
<pre class="programlisting" id="s_keymykey_s">
S3_KEY=mykey
S3_SECRET=mysecret
</pre>
<p id="then_copy_it_an">
        Then copy it and fill in the real values when you install the
        app:
      </p>
<pre class="programlisting" data-language="console" id="cp_senvexa">
<code class="gp">$</code> cp s3.env.example s3.env
</pre>
<p id="use_a_package_l">
        Use a package like <code class="literal">nconf</code> to make the
        environment variables available in your app. Make sure that the
        real environment files get added to
        <code class="literal">.gitignore</code> so that you don't accidentally
        check them into your repository.
      </p>
<div class="warning" id="one_of_the_firs_id1">
<p id="one_of_the_firs_id2">One of the first stumbling blocks you might run into moving from
          browsers to Node is that you can't rely on your closure state to
          be reserved for a single user. You have a single instance of the
          app, with a single pool of memory, and a potentially unbounded
          number of incoming connections.
          </p>
<p id="state_needs_to_">State needs to be kept in a database, or passed as parameters through function calls. For example, each request in an Express application will have corresponding request and response objects. That may be a good place to store in-memory state for a single request/response cycle. Likewise, singletons are a good way to store state that will be shared for all requests, such as your application configuration, but otherwise, they're usually an anti-pattern in Node applications.</p>
</div>
</div>
<div class="sect3" id="express">
<div class="titlepage"><div><div><h4 class="title">Express</h4></div></div></div>
<p id="there_are_a_lot">
        There are a lot of application frameworks available for Node.
        One popular framework that I find particularly useful is
        Express. It's basically an HTTP server built on top of Node's
        http module and Connect middleware.
      </p>
</div>
<div class="sect3" id="create-your-app">
<div class="titlepage"><div><div><h4 class="title">Create your app</h4></div></div></div>
<p id="to_create_an_ex">
        To create an express app instance, you'll need to require
        express, and call the function that gets returned:
      </p>
<pre class="programlisting" data-language="js" id="var_express__r_id1">
<code class="kd">var</code> <code class="nx">express</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'express'</code><code class="p">),</code>

  <code class="c1">// Create app instance.</code>
  <code class="nx">app</code> <code class="o">=</code> <code class="nx">express</code><code class="p">();</code>
</pre>
</div>
<div class="sect3" id="routing">
<div class="titlepage"><div><div><h4 class="title">Routing</h4></div></div></div>
<p id="express_has_a_b">
        Express has a built-in app router. It's pretty simple to use.
        First, request method names correspond to the methods you call
        to set up your route. <code class="literal">GET</code> is
        <code class="literal">.get()</code>. <code class="literal">POST</code> is
        <code class="literal">.post()</code> and so on. To create a route that
        will handle any request type, use <code class="literal">.all()</code>.
        Pass the route as the first parameter, and a function as the
        second parameter:
      </p>
<pre class="programlisting" data-language="js" id="appget_fu">
<code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'/'</code><code class="p">,</code> <code class="kd">function</code> <code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code> <code class="p">{</code>
  <code class="nx">res</code><code class="p">.</code><code class="nx">setHeader</code><code class="p">(</code><code class="s1">'Content-Type'</code><code class="p">,</code> <code class="s1">'text/plain'</code><code class="p">);</code>

  <code class="nx">res</code><code class="p">.</code><code class="nx">end</code><code class="p">(</code><code class="s1">'Hello, world!'</code><code class="p">);</code>
<code class="p">});</code>
</pre>
<p id="routes_have_eas">
        Routes have easy parameter matching:
      </p>
<pre class="programlisting" data-language="js" id="appgetname">
<code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'/:name'</code><code class="p">,</code> <code class="kd">function</code><code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">){</code>
  <code class="kd">var</code> <code class="nx">name</code> <code class="o">=</code> <code class="nx">req</code><code class="p">.</code><code class="nx">params</code><code class="p">.</code><code class="nx">name</code><code class="p">;</code>

  <code class="nx">res</code><code class="p">.</code><code class="nx">send</code><code class="p">(</code><code class="s1">'Hello, '</code> <code class="o">+</code> <code class="nx">name</code><code class="p">);</code>
<code class="p">});</code>
</pre>
<p id="a_route_can_be_">
        A route can be a regular expression:
      </p>
<pre class="programlisting" data-language="js" id="appgethugh">
<code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="sr">/(Hugh|Kevin)/</code><code class="p">,</code> <code class="kd">function</code> <code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="p">{</code>
  <code class="kd">var</code> <code class="nx">name</code> <code class="o">=</code> <code class="nx">req</code><code class="p">.</code><code class="nx">params</code><code class="p">[</code><code class="mi">0</code><code class="p">],</code> <code class="c1">// Whitelisted user</code>
    <code class="nx">output</code><code class="p">;</code>

  <code class="c1">// Write something to output...</code>

  <code class="nx">res</code><code class="p">.</code><code class="nx">send</code><code class="p">(</code><code class="s1">'Hello, '</code> <code class="o">+</code> <code class="nx">name</code><code class="p">);</code>
<code class="p">});</code>
</pre>
</div>
<div class="sect3" id="middleware">
<div class="titlepage"><div><div><h4 class="title">Middleware</h4></div></div></div>
<p id="middleware_is_s">
        Middleware is software that takes an incoming request, processes
        it, and passes it on to the next piece of middleware in the
        chain. Express middleware takes the form:
      </p>
<pre class="programlisting" data-language="js" id="add_some_dat">
<code class="c1">// Add some data to the request object that your other</code>
<code class="c1">// midleware and routes can use.</code>
<code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="p">{</code>
  <code class="nx">req</code><code class="p">.</code><code class="nx">foo</code> <code class="o">=</code> <code class="s1">'bar'</code><code class="p">;</code>
  <code class="nx">next</code><code class="p">();</code>
<code class="p">});</code>
</pre>
<p id="heres_how_it_w">
        Here's how it works in the context of an express server:
      </p>
<pre class="programlisting" data-language="js" id="use_strict_v_id3">
<code class="s1">'use strict'</code><code class="p">;</code>
<code class="kd">var</code> <code class="nx">express</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'express'</code><code class="p">),</code>

  <code class="c1">// Create app instance.</code>
  <code class="nx">app</code> <code class="o">=</code> <code class="nx">express</code><code class="p">(),</code>

  <code class="c1">// Use the `PORT` environment variable, or port 44444</code>
  <code class="nx">port</code> <code class="o">=</code> <code class="nx">process</code><code class="p">.</code><code class="nx">env</code><code class="p">.</code><code class="nx">PORT</code> <code class="o">||</code> <code class="mi">44444</code><code class="p">;</code>

<code class="c1">// The new middleware adds the property `foo` to the request</code>
<code class="c1">// object and sets it to 'bar'.</code>
<code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="p">{</code>
  <code class="nx">req</code><code class="p">.</code><code class="nx">foo</code> <code class="o">=</code> <code class="s1">'bar'</code><code class="p">;</code>
  <code class="nx">next</code><code class="p">();</code>
<code class="p">});</code>

<code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'/'</code><code class="p">,</code> <code class="kd">function</code> <code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code> <code class="p">{</code>
  <code class="nx">res</code><code class="p">.</code><code class="nx">setHeader</code><code class="p">(</code><code class="s1">'Content-Type'</code><code class="p">,</code> <code class="s1">'text/plain'</code><code class="p">);</code>

  <code class="c1">// Send the value passed from the middleware, above.</code>
  <code class="nx">res</code><code class="p">.</code><code class="nx">end</code><code class="p">(</code><code class="nx">req</code><code class="p">.</code><code class="nx">foo</code><code class="p">);</code>
<code class="p">});</code>

<code class="nx">app</code><code class="p">.</code><code class="nx">listen</code><code class="p">(</code><code class="nx">port</code><code class="p">,</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
  <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'Listening on port '</code> <code class="o">+</code> <code class="nx">port</code><code class="p">);</code>
<code class="p">});</code>
</pre>
<p id="point_a_browser">
        Point a browser at the new server, or just use curl:
      </p>
<pre class="programlisting" data-language="console" id="curl_httpl">
<code class="gp">$</code> curl http://localhost:44444/
<code class="go">bar</code>
</pre>
<p id="handling_errors">
        Handling errors is just as simple. Again, you'll use middleware:
      </p>
<pre class="programlisting" data-language="js" id="use_strict_v_id4">
<code class="s1">'use strict'</code><code class="p">;</code>
<code class="kd">var</code> <code class="nx">express</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'express'</code><code class="p">),</code>

  <code class="c1">// Create app instance.</code>
  <code class="nx">app</code> <code class="o">=</code> <code class="nx">express</code><code class="p">(),</code>

  <code class="c1">// Use the `PORT` environment variable, or port 44444</code>
  <code class="nx">port</code> <code class="o">=</code> <code class="nx">process</code><code class="p">.</code><code class="nx">env</code><code class="p">.</code><code class="nx">PORT</code> <code class="o">||</code> <code class="mi">44444</code><code class="p">;</code>

<code class="c1">// Some middleware that produces an error:</code>
<code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">request</code><code class="p">,</code> <code class="nx">response</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="p">{</code>
  <code class="kd">var</code> <code class="nx">bar</code><code class="p">;</code>

  <code class="k">try</code> <code class="p">{</code>

    <code class="c1">// This will throw because `foo` is undefined.</code>
    <code class="nx">request</code><code class="p">.</code><code class="nx">foo</code> <code class="o">=</code> <code class="nx">foo</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'bar'</code><code class="p">);</code>

  <code class="p">}</code> <code class="k">catch</code> <code class="p">(</code><code class="nx">error</code><code class="p">)</code> <code class="p">{</code>

    <code class="c1">// Pass the error to the next error handler in the</code>
    <code class="c1">// middleware chain. If you forget `return` here,</code>
    <code class="c1">// it will continue to process the rest of the</code>
    <code class="c1">// function, and probably throw an unhandled exception.</code>

    <code class="k">return</code> <code class="nx">next</code><code class="p">(</code><code class="nx">error</code><code class="p">);</code>
  <code class="p">}</code>

  <code class="c1">// Do something with bar.</code>
<code class="p">});</code>

<code class="c1">// Tell express to process routes before it gets to the error handler.</code>
<code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="nx">app</code><code class="p">.</code><code class="nx">router</code><code class="p">);</code>


<code class="c1">// Error handlers take four parameters. The first is the error.</code>
<code class="c1">// Generally, you'll want to add your error handler to the bottom of</code>
<code class="c1">// your app.use() stack.</code>
<code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code><code class="kd">function</code> <code class="p">(</code><code class="nx">error</code><code class="p">,</code> <code class="nx">request</code><code class="p">,</code> <code class="nx">response</code><code class="p">,</code> <code class="nx">next</code><code class="p">)</code> <code class="p">{</code>

  <code class="c1">// Log the error.</code>
  <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="nx">error</code><code class="p">);</code>

  <code class="c1">// Send the user a friendly message:</code>
  <code class="nx">response</code><code class="p">.</code><code class="nx">send</code><code class="p">(</code><code class="mi">500</code><code class="p">,</code> <code class="s1">'Your request was not handled successfully. '</code> <code class="o">+</code>
    <code class="s1">'Our smartest fix-it guy has already been alerted. '</code> <code class="o">+</code>
    <code class="s1">'Contact us if you need help.'</code><code class="p">);</code>

  <code class="c1">// Use setTimeout to give the app time to log and clean up,</code>
  <code class="c1">// but shut down ASAP to avoid unintended behavior.</code>
  <code class="c1">// Could also use setImmediate() in recent versions of Node.</code>
  <code class="nx">setTimeout</code><code class="p">(</code><code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
    <code class="nx">process</code><code class="p">.</code><code class="nx">exit</code><code class="p">(</code><code class="mi">1</code><code class="p">);</code>
  <code class="p">},</code> <code class="mi">0</code><code class="p">);</code>

<code class="p">});</code>

<code class="nx">app</code><code class="p">.</code><code class="nx">get</code><code class="p">(</code><code class="s1">'/'</code><code class="p">,</code> <code class="kd">function</code> <code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code> <code class="p">{</code>
  <code class="nx">res</code><code class="p">.</code><code class="nx">setHeader</code><code class="p">(</code><code class="s1">'Content-Type'</code><code class="p">,</code> <code class="s1">'text/plain'</code><code class="p">);</code>

  <code class="c1">// Sadly, nobody will ever see this friendly greeting.</code>
  <code class="nx">res</code><code class="p">.</code><code class="nx">end</code><code class="p">(</code><code class="s1">'Hello, world!'</code><code class="p">);</code>
<code class="p">});</code>

<code class="nx">app</code><code class="p">.</code><code class="nx">listen</code><code class="p">(</code><code class="nx">port</code><code class="p">,</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
  <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'Listening on port '</code> <code class="o">+</code> <code class="nx">port</code><code class="p">);</code>
<code class="p">});</code>
</pre>
<p id="you_can_clean_u">
        You can clean up after a lot of errors. In fact, sometimes an
        error is an expected probability. For example, there's a chance
        that sometimes remote services won't be available, and you can
        recover from that condition and try again later. However,
        sometimes you just won't get the answer you're looking for and
        there's nothing you can do to recover. You don't want to keep
        your server running with undefined state. In the case of errors
        that you can't easily recover from, it's important to shut down
        the process as quickly as possible.
      </p>
<div class="sect4" id="let-it-crash">
<div class="titlepage"><div><div><h5 class="title">Let it Crash</h5></div></div></div>
<p id="processes_crash">
          Processes crash. Like all things, your server's runtime will
          expire. Don't sweat it. Log the error, shut down the server,
          and launch a new instance. You can use Node's cluster module,
          forever (a Node module available on npm), or a wide range of
          other server monitor utilities to detect crashes and repair
          the service in order to keep things running smoothly, even in
          the face of unexpected exceptions.
        </p>
</div>
</div>
<div class="sect3" id="templates">
<div class="titlepage"><div><div><h4 class="title">Templates</h4></div></div></div>
<p id="express_comes_w">
        Express comes with some built-in handling of templates, but it
        must be configured. You have to tell Express which view engine
        to use in order to process templates, and where to find the
        views. First, you'll want to require your template engine. For
        Mustache templates, you can use Hogan:
      </p>
<pre class="programlisting" data-language="js" id="var_hulk__requ">
<code class="kd">var</code> <code class="nx">hulk</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'hulk-hogan'</code><code class="p">);</code>
</pre>
<p id="most_of_the_set">
        Most of the settings for express are specified with
        <code class="literal">app.set()</code>. You'll need to use it to configure
        express to use the template engine of your choice. There are
        four options that you should be aware of:
      </p>
<pre class="programlisting" data-language="js" id="tell_express">
<code class="c1">// Tell express where to find your templates.</code>
<code class="nx">app</code><code class="p">.</code><code class="nx">set</code><code class="p">(</code><code class="s1">'views'</code><code class="p">,</code> <code class="nx">__dirname</code> <code class="o">+</code> <code class="s1">'/views'</code><code class="p">);</code>

<code class="c1">// By default, Express will use a generic HTML wrapper (a layout)</code>
<code class="c1">// to render all your pages. If you don't need that, turn it off.</code>
<code class="nx">app</code><code class="p">.</code><code class="nx">set</code><code class="p">(</code><code class="s1">'view options'</code><code class="p">,</code> <code class="p">{</code><code class="nx">layout</code><code class="o">:</code> <code class="kc">false</code><code class="p">});</code>

<code class="c1">// Tell express which engine to use.</code>
<code class="nx">app</code><code class="p">.</code><code class="nx">set</code><code class="p">(</code><code class="s1">'view engine'</code><code class="p">,</code> <code class="s1">'hulk-hogan'</code><code class="p">);</code>

<code class="c1">// Specify the extension you'll use for your views.</code>
<code class="nx">app</code><code class="p">.</code><code class="nx">engine</code><code class="p">(</code><code class="s1">'.html'</code><code class="p">,</code> <code class="nx">hulk</code><code class="p">.</code><code class="nx">__express</code><code class="p">);</code>
</pre>
<p id="remember_to_def">
        Remember to define a route that uses your new view. Assuming
        you've used your middleware to build a data object on the
        request object called <code class="literal">req.data</code> (see
        Middleware, above):
      </p>
<pre class="programlisting" data-language="js" id="appall_fu">
<code class="nx">app</code><code class="p">.</code><code class="nx">all</code><code class="p">(</code><code class="s1">'/'</code><code class="p">,</code> <code class="kd">function</code> <code class="p">(</code><code class="nx">req</code><code class="p">,</code> <code class="nx">res</code><code class="p">)</code> <code class="p">{</code>
  <code class="nx">res</code><code class="p">.</code><code class="nx">render</code><code class="p">(</code><code class="s1">'index'</code><code class="p">,</code> <code class="nx">req</code><code class="p">.</code><code class="nx">data</code><code class="p">,</code> <code class="kd">function</code> <code class="nx">callback</code><code class="p">(</code><code class="nx">err</code><code class="p">,</code> <code class="nx">html</code><code class="p">)</code> <code class="p">{</code>
    <code class="c1">// Handle error.</code>
  <code class="p">});</code>
<code class="p">});</code>
</pre>
<p id="you_can_leave_o">
        You can leave off the callback parameter and any errors will be
        internally passed via <code class="literal">next(err)</code> for your
        generic error handlers to catch. If you pass the callback, that
        automatic error handling will not occur, and you should handle
        the error explicitly.
      </p>
</div>
<div class="sect3" id="next-steps">
<div class="titlepage"><div><div><h4 class="title">Next Steps</h4></div></div></div>
<p id="of_course_you__id3">
        Of course, you want to do a lot more with your app than return a
        hard-coded message to your users. The good news is that there
        are drivers for just about any database you can dream of. You
        can use a variety of template libraries, and of course, serve
        static files. I encourage you to dive into the Node module
        playground and take a look around. For starters, here's a simple
        static file server example using the built-in static middleware:
      </p>
<pre class="programlisting" data-language="js" id="var_express__r_id2">
<code class="kd">var</code> <code class="nx">express</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'express'</code><code class="p">),</code>

    <code class="nx">app</code> <code class="o">=</code> <code class="nx">express</code><code class="p">(),</code> <code class="c1">// Create the express app.</code>

    <code class="c1">// Try pulling the port from the environment. Or</code>
    <code class="c1">// default to 5555 if no environment variable is set.</code>
    <code class="nx">port</code> <code class="o">=</code> <code class="o">+</code><code class="nx">process</code><code class="p">.</code><code class="nx">env</code><code class="p">.</code><code class="nx">PORT</code> <code class="o">||</code> <code class="mi">5555</code><code class="p">;</code>

<code class="c1">// .bodyParser() parses the request body and creates the</code>
<code class="c1">// req.body object.</code>
<code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code> <code class="nx">express</code><code class="p">.</code><code class="nx">bodyParser</code><code class="p">()</code> <code class="p">);</code>

<code class="c1">// .methodOverride() lets you simulate DELETE and PUT</code>
<code class="c1">// methods with POST methods. Common boilerplate.</code>
<code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code> <code class="nx">express</code><code class="p">.</code><code class="nx">methodOverride</code><code class="p">()</code> <code class="p">);</code>

<code class="c1">// .static() creates a static file server, which looks for</code>
<code class="c1">// assets in the /public directory, in this case.</code>
<code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code> <code class="nx">express</code><code class="p">.</code><code class="kr">static</code><code class="p">(</code><code class="nx">__dirname</code> <code class="o">+</code> <code class="s1">'/public'</code><code class="p">)</code> <code class="p">);</code>

<code class="c1">// app.router handles path routing for express apps.</code>
<code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code> <code class="nx">app</code><code class="p">.</code><code class="nx">router</code> <code class="p">);</code>

<code class="c1">// Express comes with a default error handler that is</code>
<code class="c1">// intended for development use. You'll want to implement</code>
<code class="c1">// your own for production systems.</code>
<code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code> <code class="nx">express</code><code class="p">.</code><code class="nx">errorHandler</code><code class="p">()</code> <code class="p">);</code>

<code class="nx">app</code><code class="p">.</code><code class="nx">listen</code><code class="p">(</code><code class="nx">port</code><code class="p">,</code> <code class="kd">function</code> <code class="p">()</code> <code class="p">{</code>
  <code class="nx">console</code><code class="p">.</code><code class="nx">log</code><code class="p">(</code><code class="s1">'Server listening on port '</code> <code class="o">+</code> <code class="nx">port</code><code class="p">);</code>
<code class="p">});</code>
</pre>
<p id="have_a_look_at_">
        Have a look at the
        <a class="ulink" href="http://expressjs.com/guide.html" target="_top">Express guide</a> and <a class="ulink" href="http://expressjs.com/api.html" target="_top">API reference</a> for a lot more useful examples, and the
        <a class="ulink" href="http://nodejs.org/api/" target="_top">Node Manual</a> for Node
        API documentation. There are lots of useful gems that you'll
        want to learn more about.
      </p>
</div>
</div>
</div>
<div class="sect1" data-original-filename="ch06.xml" id="internationalization">
<div class="titlepage"><div><div><h2 class="title">Internationalization</h2></div></div></div>
<p id="internationaliz_id2">Internationalization or localization  is the process of converting text strings, numbers, dates, and currency into localized languages and representations. When you build a web application which grows to or near the saturation point in one country or culture, the easiest way to grow your user base is to expand to other cultures. One of the biggest hurdles to cross is obviously the translation of your app, but before you can even start down that road, you need to have some mechanisms in place to make that possible. </p>
<p id="so_when_is_the_">So when is the right time to get started? <span class="emphasis"><em>Right now.</em></span> The biggest obstacle to translation is that you must plan for it, or budget a whole lot more time and energy to painstakingly go through the app, find all the strings that need translating, and then add support for it after the fact. By far, the easiest way to support internationalization is to plan for it up front, as soon as you start building templates. Any string that gets displayed to the user should be run through a translation function, first.</p>
<p id="instead_of_roll">Instead of rolling your own translation solution, I recommend that you find a good library to handle it for you. Some good ones include <a class="ulink" href="http://momentjs.com/" target="_top">Moment.js</a> for dates, and <a class="ulink" href="http://i18next.com/" target="_top">i18next</a> for strings.</p>
<p id="microsoft_produ">Microsoft produced a very thorough solution that works with strings, numbers, currency, percentages, and dates. It's called <a class="ulink" href="https://github.com/jquery/globalize" target="_top">Globalize</a>, and it was generously donated to the jQuery project, but it has since been made stand-alone and converted to work with AMD and node-style modules. You don't need to use jQuery to use Globalize.</p>
<p id="one_advantage_o">One advantage of Globalize is that it uses a fairly comprehensive database of locale information that is hard to match in JavaScript. The only comparable solution that I'm aware of is the <a class="ulink" href="http://cldr.unicode.org/" target="_top">Unicode Common Locale Data Repository (CLDR)</a>. CLDR is used by many of the top software development companies, including Apple, Google, IBM, and Adobe. Anybody can contribute to it. You could think of it is the Wikipedia of globalization data. There has even been talk of using CLDR data to generate culture files for Globalize, and that may become available in a future version.</p>
<p id="if_you_dont_wa">If you don't want to wait, and you don't mind Twitter's choice of which locales to support, you may be able to use <a class="ulink" href="https://github.com/twitter/twitter-cldr-js" target="_top">twitter-cldr-js</a>. Twitter's CLDR package has a dependency on Ruby, so it may need to be shoe-horned into your Node project if you decide to go that route.</p>
<p id="for_now_i_reco">For now, I recommend Globalize.</p>
<p id="once_youve_cho">Once you've chosen a solution, getting your translation data where it needs to be is your next challenge. It doesn't make sense to ship the whole catalog of translation data to the client if they only need a single locale set.</p>
<p id="if_you_render_a">If you render all your templates on the client side, you can inject a default set of translations into the page data at page load time, or make an asynchronous call to fetch translations, or both.</p>
<div class="tip" id="there_have_been_id1"><p id="there_have_been_id2">There have been apps where the page renders, and then an alternate translation loads, and the page re-renders. Those cases can present an awkward user experience, so make sure that you resolve the preferred locale before you invoke your initial page render.</p></div>
<p id="once_it_has_bee">Once it has been determined that the user has a locale preference different from the default, it's important to store that information so that you can present them with their preferred locale experience at every subsequent page load. It's a good idea to set a cookie that contains this information. It's probably not a good idea to store that information in a server-side session, because if the user is not logged in, or the session is expired, the user might have trouble logging in and getting their preferred locale experience back.</p>
<div class="sect2" id="locale_determination">
<div class="titlepage"><div><div><h3 class="title">Locale Determination</h3></div></div></div>
<p id="unfortunately__id3">Unfortunately, there is no easy way to get a user's true locale preference on the client side without asking them. However, the browser's request header can tell you the user's preference. There's a locale module for express that makes the best match easy to get:</p>
<pre class="programlisting" data-language="js" id="var_locale__re">
<code class="kd">var</code> <code class="nx">locale</code> <code class="o">=</code> <code class="nx">require</code><code class="p">(</code><code class="s1">'locale'</code><code class="p">),</code>
  <code class="c1">// ... other requires ...</code>
  <code class="c1">// Tell locale which locales you support.</code>
  <code class="nx">supportedLocales</code> <code class="o">=</code> <code class="p">[</code><code class="s1">'en'</code><code class="p">,</code> <code class="s1">'en_US'</code><code class="p">,</code> <code class="s1">'ja'</code><code class="p">];</code>

<code class="c1">// locale() returns a middleware function that pulls the</code>
<code class="c1">// req.headers["accept-language"] attribute and runs the value</code>
<code class="c1">// through locales.best(supported) to determine the closest</code>
<code class="c1">// matching locale.</code>
<code class="nx">app</code><code class="p">.</code><code class="nx">use</code><code class="p">(</code> <code class="nx">locale</code><code class="p">(</code><code class="nx">supportedLocales</code><code class="p">)</code> <code class="p">);</code>
      </pre>
</div>
</div></section><footer><div class="navfooter">
<hr>
<table style="width: 100%; ">
<tr>
<td style="width: 40%; text-align: left; ">
<a accesskey="p" href="ch05.html">Prev</a> </td>
<td style="width: 20%; text-align: center; "> </td>
<td style="width: 40%; text-align: right; "> </td>
</tr>
<tr>
<td style="width: 40%; text-align: left; vertical-align: top; ">Chapter 5. Modules </td>
<td style="width: 20%; text-align: center; "><a accesskey="h" href="index.html">Home</a></td>
<td style="width: 40%; text-align: right; vertical-align: top; "> </td>
</tr>
</table>
</div></footer>


	<div class="extra-footer">
		<p>© 2013, O’Reilly Media, Inc.</p>
		<ul>
			<li><a href="http://oreilly.com/terms/">Terms of Service</a></li>
			<li><a href="http://oreilly.com/oreilly/privacy.csp">Privacy Policy</a></li>
			<li>Interested in <a href="mailto:scordesse@oreilly.com">sponsoring content?</a></li>
		</ul>
	</div>
<script type="text/javascript">if (!NREUMQ.f) { NREUMQ.f=function() {
NREUMQ.push(["load",new Date().getTime()]);
var e=document.createElement("script");
e.type="text/javascript";
e.src=(("http:"===document.location.protocol)?"http:":"https:") + "//" +
  "rpm-images.newrelic.com/42/eum/rum.js";
document.body.appendChild(e);
if(NREUMQ.a)NREUMQ.a();
};
NREUMQ.a=window.onload;window.onload=NREUMQ.f;
};
NREUMQ.push(["nrfj","beacon-3.newrelic.com","3e361aebcf","2194180","IApbRUBZXg1WEEoHDAwORh5aQl8N",68,227,new Date().getTime(),"","","","",""]);</script></body>
</html>